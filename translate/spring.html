<!DOCTYPE html>
<!-- saved from url=(0066)https://spring.io/guides/tutorials/spring-security-and-angular-js/ -->
<html data-mobile-support="" data-newsletter-subscription="" data-search="" data-clipboard-buttons="" data-code-prettify="" data-code-sidebar="" data-hide-show-guide="" data-sts-import=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Getting Started Â· Spring Security and Angular JS</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport">
<link rel="shortcut icon" type="image/x-icon" href="https://spring.io/img/favicon.png">
<link href="./spring_files/css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="./spring_files/main.css">
<link rel="stylesheet" type="text/css" href="./spring_files/gsguide.css">
<script type="text/javascript" async="" src="./spring_files/munchkin.js"></script><script type="text/javascript" async="" src="./spring_files/inpage_linkid.js" id="undefined"></script><script type="text/javascript" async="" src="./spring_files/ga.js"></script><script>
        var baseUrl = '/';
  </script><style type="text/css"></style>
<script async="" src="./spring_files/curl.js" data-curl-run=""></script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification">
<meta property="og:title" content="Spring Security and Angular JS">
<meta property="og:image" content="/img/spring-by-pivotal.png">
<meta property="og:description" content="this tutorial is designed to be completed in 2-3 hours, it provides deeper, in-context explorations of enterprise application development topics, leaving you ready to implement real-world solutions.">
<script>
    //
      var _gaq = _gaq || [];
      var pluginUrl =
       '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
      _gaq.push(
        ['_require', 'inpage_linkid', pluginUrl],
        ['_setAccount', 'UA-2728886-20'],
        ['_trackPageview'],
        ['b._require', 'inpage_linkid', pluginUrl],
        ['b._setAccount', 'UA-2728886-19'],
        ['b._trackPageview']
      );

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
  </script>
 
<script type="text/javascript" charset="utf-8" async="" src="./spring_files/run.js"></script><script type="text/javascript" charset="utf-8" src="./spring_files/jquery-migrate-1.2.1.js"></script><script type="text/javascript" charset="utf-8" src="./spring_files/munchkin(1).js"></script><style type="text/css">/*.lleo_errorSelection *::-moz-selection,
.lleo_errorSelection *::selection,
.lleo_errorSelection *::-webkit-selection {
    background-color: red !important;
    color: #fff !important;;
}*/

#lleo_dialog,
#lleo_dialog * {
    color: #000 !important;
    font: normal 13px Arial, Helvetica !important;
    line-height: 15px !important;
    margin: 0 !important;
	padding: 0 !important;
	background: none !important;
	border: none 0 !important;
	position: static !important;
	vertical-align: baseline !important;
	overflow: visible !important;
	width: auto !important;
	height: auto !important;
    max-width: none !important;
    max-height: none !important;
	float: none !important;
	visibility: visible !important;
	text-align: left !important;
    text-transform: none !important;
	border-collapse: separate !important;
	border-spacing: 2px !important;
    box-sizing: content-box !important;
    box-shadow: none !important;
    opacity: 1 !important;
    text-shadow: none !important;
    letter-spacing: normal !important;
    -webkit-filter: none !important;
    -moz-filter: none !important;
    filter: none !important;
}
#lleo_dialog *:before,
#lleo_dialog *:after {
    content: '';
}

#lleo_dialog iframe {
	height: 0 !important;
	width: 0 !important;
}

#lleo_dialog {
    position: absolute !important;
    background: #fff !important;
    border: solid 1px #ccc !important;
    padding: 7px 0 0 !important;
    left: -999px;
    top: -999px;
    width: 440px !important;
    overflow: hidden;
    display: block !important;
    z-index: 999999999 !important;
    box-shadow: 8px 16px 30px rgba(0, 0, 0, 0.16) !important;
    border-radius: 3px !important;
    opacity: 0 !important;
    -webkit-transform: translateY(15px);
    -moz-transform: translateY(15px);
    -ms-transform: translateY(15px);
    -o-transform: translateY(15px);
    transform: translateY(15px);
}
#lleo_dialog.lleo_show_small {
    width: 150px !important;
}
#lleo_dialog.lleo_show {
    opacity: 1 !important;
    -webkit-transform: translateY(0);
    -moz-transform: translateY(0);
    -ms-transform: translateY(0);
    -o-transform: translateY(0);
    transform: translateY(0);
    -webkit-transition: -webkit-transform 0.3s, opacity 0.3s !important;
    -moz-transition: -moz-transform 0.3s, opacity 0.3s !important;
    -ms-transition: -ms-transform 0.3s, opacity 0.3s !important;
    -o-transition: -o-transform 0.3s, opacity 0.3s !important;
    transition: transform 0.3s, opacity 0.3s !important;
}
#lleo_dialog.lleo_collapse {
    opacity: 0 !important;
    -webkit-transform: scale(0.25, 0.1) translate(-550px, 100px);
    -moz-transform: scale(0.25, 0.1) translate(-550px, 100px);
    -ms-transform: scale(0.25, 0.1) translate(-550px, 100px);
    -o-transform: scale(0.25, 0.1) translate(-550px, 100px);
    transform: scale(0.25, 0.1) translate(-550px, 100px);
    -webkit-transition: -webkit-transform 0.4s, opacity 0.4s !important;
    -moz-transition: -moz-transform 0.4s, opacity 0.4s !important;
    -ms-transition: -ms-transform 0.4s, opacity 0.4s !important;
    -o-transition: -o-transform 0.4s, opacity 0.4s !important;
    transition: transform 0.4s, opacity 0.4s !important;
}
#lleo_dialog input::-webkit-input-placeholder {
    color: #aaa !important;
}
#lleo_dialog .lleo_has_pic #lleo_word {
	margin-right: 80px !important;
}
#lleo_dialog #lleo_translationsContainer1 {
	position: relative !important;
}
#lleo_dialog #lleo_translationsContainer2 {
	padding: 7px 0 0 !important;
	vertical-align: middle !important;
}
#lleo_dialog #lleo_word {
    color: #000 !important;
    margin: 0 5px 2px 0 !important;
    /*float: left !important;*/
}
#lleo_dialog .lleo_has_sound #lleo_word {
    margin-left: 30px !important;
}
#lleo_dialog #lleo_text {
    font-weight: bold !important;
    color: #d56e00 !important;
    text-decoration: none !important;
    cursor: default !important;
}
/*
#lleo_dialog #lleo_text.lleo_known {
    cursor: pointer !important;
    text-decoration: underline !important;
}
*/
/*#lleo_dialog #lleo_closeBtn {
    position: absolute !important;
    right: 6px !important;
    top: 5px !important;
    line-height: 1px !important;
    text-decoration: none !important;
    font-weight: bold !important;
    font-size: 0 !important;
    color: #aaa !important;
    display: block !important;
	z-index: 9999999999 !important;
	width: 7px !important;
	height: 7px !important;
	padding: 0 !important;
	margin: 0 !important;
}*/

#lleo_dialog #lleo_optionsBtn {
    position: absolute !important; 
    right: 3px !important;
    top: 5px !important;
    line-height: 1px !important;
    text-decoration: none !important;
    font-weight: bold !important;
    font-size: 13px !important;
    color: #aaa !important;
    padding: 2px !important;
	display: none;
}
    #lleo_dialog.lleo_optionsShown #lleo_optionsBtn {
        display: block !important;
    }
    #lleo_dialog #lleo_optionsBtn img {
        width: 12px !important;
        height: 12px !important;
    }
#lleo_dialog #lleo_sound {
    float: left !important;
    width: 16px !important;
    height: 16px !important;
    margin-left: 9px !important;
    margin-right: 3px !important;
    background: 0 0 no-repeat !important;
    cursor: pointer !important;
    display: none !important;
    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAfNJREFUeNq0U01IVFEU/u57Oo5WhBRIBBptykWLYBa2soWiEKQQEbrSFsGbVRQKQc2iFqGitXqvjQxCoCJCqyI0aBUtZILaJNUuYWYWo8HovJ/707nP94bnz0rxwvfOuefd8517fi5TSuE4i50YwZ3l37ZhNlpgzFkaaM/G9sHF1YskNrT+7l4PjMOcb78t2JL71uxgB+2UlfxHTtq5N94fIOh/88kWgWfl73ZCSQkpeGg3H091JY6dI2S00qA/N3KO3dDUYhFgEmZGurG+w9FqApIHsVM7kaTF9Nhn0r8Q7hPWQgIRuNaH3AMUA4W/Lkdh04cpFS43G0TgxQTvCdMETVAk3KynIHwXZU/ge8XDt7KH9bKLjU0P2zVO5LsEpSejVRJ9UR18EtfqKegovs9R3Q6w9c/H1o4Aa2Jwm1lIvn9RJ4w9RdRRzqcYrpwycCll4Cy1lnkS3Bc6vfBg28v8aRIfI78zhB/1GygROH3jLyyzMQ0zlUZuZBSlKkeLoegGtTjYLcJ8pF+NakHOFC2J6w+f25mxSfWrWFF/ShXVPTGvtN14NNkVnxlYWJkgZEL7/vwKr55lKSVnaGYWkuYgrgG172uUv47+U7fw0EHaJXmalUQy/HqO6lBzEsVjJC4Q8kd6TETQpjuaGOvjv8b/AgwA/ij1XMx58NIAAAAASUVORK5CYII=) !important;
}
#lleo_dialog .lleo_has_sound #lleo_sound {
    display: block !important;
}

#lleo_dialog #lleo_soundWave {
    border: solid 5px #4495CC !important;
    border-radius: 5px !important;
    position: absolute !important;
    left: -5px !important;
    top: -5px !important;
    right: -5px !important;
    bottom: -5px !important;
    z-index: 0 !important;
    opacity: 0.9 !important;
    display: none !important;
}
    #lleo_dialog #lleo_soundWave.lleo_beforePlaying {
        display: block !important;
    }
    #lleo_dialog #lleo_soundWave.lleo_playing {
        opacity: 0 !important;
        border-width: 20px !important;
        border-radius: 30px !important;

        -webkit-transform: scale(1.07,1.1) !important;
        -moz-transform: scale(1.07,1.1) !important;
        -ms-transform: scale(1.07,1.1) !important;
        transform: scale(1.07,1.1) !important;

        -webkit-transition: all 0.6s !important;
        -moz-transition: all 0.6s !important;
        -ms-transition: all 0.6s !important;
        transition: all 0.6s !important;
    }


#lleo_dialog #lleo_picOuter {
    position: absolute !important;
    float: right !important;
    top: 4px;
    right: 5px;
    z-index: 9 !important;
    display: none !important;
    width: 100px !important;
}
    #lleo_dialog.lleo_optionsShown #lleo_picOuter {
        right: 25px;
    }
#lleo_dialog .lleo_has_pic #lleo_picOuter {
    display: block !important;
}
    #lleo_dialog #lleo_picOuter:hover {
        width: auto !important;
        z-index: 11 !important;
    }
#lleo_dialog #lleo_pic,
#lleo_dialog #lleo_picBig {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    border: solid 2px #fff !important;
    -webkit-border-radius: 2px !important;
    -moz-border-radius: 2px !important;
	border-radius: 2px !important;
    z-index: 1 !important;
}
#lleo_dialog #lleo_pic {
	position: relative !important;
    border: none !important;
	width: 30px !important;
}
#lleo_dialog #lleo_picBig {
    box-shadow: -1px 2px 4px rgba(0,0,0,0.3);
    z-index: 2 !important;
    opacity: 0 !important;
    visibility: hidden !important;
}
    #lleo_dialog #lleo_picOuter:hover #lleo_picBig {
        visibility: visible !important;
        opacity: 1 !important;
        -webkit-transition: opacity 0.3s !important;
        -webkit-transition-delay: 0.3s !important;
    }
#lleo_dialog #lleo_transcription {
    margin: 0 80px 4px 31px !important;
    color: #aaaaaa !important;
}
#lleo_dialog .lleo_no_trans {
    color: #aaa !important;
}

#lleo_dialog .ll-translation-counter {
	float: right !important;
    font-size: 11px !important;
    color: #aaa !important;
    padding: 2px 2px 1px 10px !important;
}

#lleo_dialog .ll-translation-text {
	float: left !important;
	/*width: 80% !important;*/
}

#lleo_dialog #lleo_trans a {
    color: #3F669F !important;
    text-decoration: none !important;
    text-overflow: ellipsis !important;
    padding: 1px 4px !important;
    overflow: hidden !important;
    float: left !important;
    width: 320px !important;
}

#lleo_dialog .ll-translation-item {
    color: #3F669F !important;
    border: solid 1px #fff !important;
    padding: 3px !important;
    width: 100% !important;
    float: left !important;
	-moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
}

#lleo_dialog .ll-translation-item:hover {
	border: solid 1px #9FC2C9 !important;
    background: #EDF4F6 !important;
	cursor: pointer !important;
}
#lleo_dialog .ll-translation-item:hover .ll-translation-counter {
	color: #83a0a6 !important;
}

#lleo_dialog .ll-translation-marker {
    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAAWSURBVBhXY7RPm/+fAQkwIXNAbMICAJQ8AkvqWg/SAAAAAElFTkSuQmCC) !important;
    display: inline-block !important;
    width: 4px !important;
    height: 4px !important;
    margin: 7px 5px 2px 2px !important;
    float: left !important;
}

#lleo_dialog #lleo_icons {
    color: #aaa !important;
    font-size: 11px !important;
    background: #f8f8f8 !important;
    padding: 10px 10px 10px 16px !important;
}
#lleo_icons a {
    display: inline-block !important;
    width: 16px !important;
    height: 16px !important;
    margin: 0 10px -4px 3px !important;
    text-decoration: none !important;
    opacity: 0.5 !important;
    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHIAAAAQCAYAAADK4SssAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAADopJREFUeNqsWQt0lNWd/33fzGQemUcmzwkhSkhYSSgpJJGVWHlEVEwLq0AFhC520xN0cfcUkHZ7QNetwfac6mp3oR5Ss8c9XaPVhoJCtGwSkYQglQBBNg/IgxBIQl7zyCSZ97f/e7+ZyeShpu7eM/fc797vu9/j/u7v93+MUqlUwuv1IlQ6Ojqk7u5utLaWo/nanfB45tbnsSI6GgsXLhQwpcx/9rCE/0PpOLSL39Pnh9TY2Y1NJXW4NeTFz59agp9uXASfYwR/Xv9dxJ6pxwJBhCIQoKtFuIUAXPRksyTx+U2rVy0TtdrywNhYeviFJAlSsJ1oJNY2ZdfVLeKdiGIb96Kqw45LvU40Dbj42F2mKNyXasCjGTGI0aqmvr6wdseL075fEORl6h+yYWzcDaNeh8Q4E7z0kVPLx//5Il0uTLqHQqGA3z/92qioKHg8Hn5/SZqYogwdOBwO6d19+9DQ0ADdqrmTJhesLML6nQ38uLj4jHSkuJi/a+Q1vd8QxORg6/dBUtDblLzbhBuuOIhJcfhl5QCeyB9DusWA3MO/hf2+e6FwjtFHKGj15Y8M0Cd0KQTpbr8kCBrNsaTn9iXoH3jga5/739nZC7Mj+n7aHBVNwwSUEhuy4rCR6m8vD9ID5MVyeAI4cPo2suI0KMpJgEoU+A5QiCKmg0jT6H49/cP4Tt4i/FXaHLS0d6O57RZ0WvXXvltaWhpOnz7NCbZ371588MEHHLQ9e/bwev78eTzzzDPo7+8PzxFDIO4rKOAgomHihq+9ckxgdd26dWHQSkuBvJ2lmLqTv2kJbQAGot/nw9U7xDa9CQHakY5xFd45f4OdhWZhFtz534GP9k9A9PPWIxGgAu2AgHwP79hYYseRI8q+f/832Kqr4O7t5bt6pioFAmIkiJXXrbCYtbg85MF1q5vv+IFxH6KUApSizLDsJB09F2i3yozoc3pn/CaBVKPr9gC+X3g/3ih5GruL1mPPjx7DwLCdA/x1xWKx4K677kJ6ejpWr14dHt+xYwdSUlKQl5cHvV4/aQ7/GMZEDiDVI9IF4asecqQ4FwzvnaWl/x84hhnJwFAKSiTFaCDS7ifhhEjMu9pJS0dg0SH8Bh28BKqCXSuRxAp+ApMAFBX8Hj6PR3G+uhrDFRXoeekltG3ZjOsbN6L7wH4M/O53GKEX97pc8NGGCckSW9ibdg9anBJqu0ZgpFvNM0ahf8yH75GU7siOx3aqIjHQS8+N0SiRGa/BhR4nLHpVhBSKfEN03erHny+3IinehBf+cQuqzzby8+1dfURuKSy5X1UMBkP4eM6cOfxdmdQuWrSIj7nd7mlAKquqqqTyVXtnvfCFhUkoRi4xswG7V7RIM9lMVvJJHoryM7Gr4hxcLisfO7m3EIcrm1HZ3DmNkYIo79RHFsfjbHMvlGozLTKBKSpJPhUQ3WRvmlpwO1mE1WCGygMk2pxIcHjhlfzBzSDbQ2Jb2C56Bwfhra2F40wtFxHRaMK899+nU/LzGGAvnR+ARSUTNDVaBTVRMI6AO3VjhMCRkGPRUQusutuABbFqDsaJ63akmtQEZhSf5xx1wWTU4eBPfoDBYQeSE818fOV9i/HZpVYcPPQeLPHmWQGZmJgYPmasZGXt2rUcTFaiyVeJBJszMgxi7uxZxFjJrn/tzBnef5MA6iwp4uCFyrjVhieXp6H5wIYw61ip2FUIjcYc7oeO227a2DKjeG0GFib74LPZoVf58NTKuSSiAkr/9CaeeMSFFQeWYsOPv4XCvVl44GdLsbVoMU5mmcLsCrUBWnneRlYa81qHJzHy983UJzBvOTy8ppvV/Nz+2j581GwjGZav27AwBp/dHsUgXcuY1TLgxns0N/y9LjdMhmisJuD+dkMB1j24jJ7jx5vvnsLT+98gJ8cHg147q/XNysoCcziHhoY4C1NTU7F582Y0NjZikDZmXFzcdGkt6f8IxReO/KWKKDAsS4P29EDZOVhJsqqDgC6NMeOSzQrzc+Uhr5SDvPHwOd4/vHF5WFYL0mL48fee/wBHP2lGkl6Dcy+vwVu70nHhYB7WLJmDX/ypFDsbf42erBTZmwPRkfTVRTJXnx2Ln27PnQCSFpm1UhA8KeDnAPI2OM6cCCnoxLzfYkP3qA/dTh/ujPuxxKJF7e0x1BIbB91+LErUYoDA23rsBk5ccyCRGHu224meMT+fGyrxsUb09VtBHiyy1/4DOm7ewcjoOF58vRz6aDUSyGP1zeCxzlSYnLa3t8NqtUKtVnM2LliwALWkLIyJbA00Gs1kaaVJQjD8mOa87H7uMT722LrdMzyOFq9BRrKPQMspeZsDU09AHn1ug7yLXzmKtANlKNtWyEF+tvwcHny1kh8XZBbBQvawzya7+MMuLX7063r85vhlFORasH/7CtouEk5f/xzPf/IykJFI8ubjVl3wqYJSSrbTEwi/ul+SJTUEaESowVuOHXUiGXnJ6oVRLTP50XkGREcp8M41GzpcPjycZICOJPdfzvXhf0a8+GGWnhwfAUdJVtvo/IhnAphAQOJ2Uh2lQrROgzlJsQRmHwFsQrRWQ8wOzJoljG03b97kjMzIyMDWrVu5XaypqcGWLVsQGxsLo9E43dmZzY1n64Ey4Ha9XcP7DFAG4qGT5/BqzSUcenI5Dm3L5+dqyA4yUPPpelZiFR7oozSov+7Cq+XXcKN/lBZbgfmxKchIzyEL74JIjqboVxIkBCAtnAAVj4Ek0SMvZnCxQrLqj6wRUhsJJK097rj8vK4hG+ghKX2fgGL9VanRXEb/i5jH+o/ON5LDI6G8Ve6LX2LuEgg8jVqFnjvD8Hh9s7KLkxzA5GR88cUXOH78OO8zz5W998mTJ9HZ2Ul+g8jlNfK+XwlkKPzIzc2d4U0aJtlVJqche8ecmRCgBZnJxNInZfDoJTItMSSxlSh6uxL1nRNOj9c2iLlaN9bnxeMHaxfC5qAQgZ6aGpeMs1tK8XD8CkhjTlpYGiSAA4LMQ84yr2qatPpD8uqPlFm55dIaBHLzPSZIPgksuls334CaW04MkcyKBOg6Au6znjH0EBtTSMbvn6NDzQ0HOUh+PofNjSzs3g7nOCwJsrnout0fTkR8qY2aAWSz2Qyn0ymHg8HS3NzMEwHDw8Nhh2fGhMBfUljcyexjcQSQjH0hqXz7Inmml3oJOBsHtDAzDYe3FfDz5ec6Z/RaS/YU4KHcxYgzi/DZmzA8dAZdl3uQnLEJ8YYEnNj0Ov7mvT34uLcaUhTJip88WWJWIKAIpyZC3ioHjR1JEZmdCImNZGTx4jiUXbWjMM0IA8lqxXUHD+hXpuoRr1Xil239fLGfINBEan9P7BQ4FQU+V3aOJc4+pVKBzu4+PLWpgI9/WPM5OTi6aVmYyDJ1XKvVchvIWNfa2gqbzYaYmBhcvHiRn3e5XOHMzyQb+U2A3PfudU7I3btXhMeYPczJSkOaRYNtOZnYW7A0bP8YsCWVsrQeICbOFEduLfg2nIONuHz8aZhxBUrVGJRuEZ3XDiHlwT/CGJuOfy3Yi7r/uIIRkmGFjxYnwLIItKi+CSC5LQy24TWakqbjqa/gcS45M0uTNBwoJpvH2x3cS348w8gX+Xib3P/+PTFw+wI41j7C+0voO9lcbt/tTjz+yHIUrs6Fj+59b/YCUpRR2Kk6yeFhVU92U6OO4naUybXb4+XjLHUXWZhkqlQqDhh7z7a2Np4AuHr1aohE4ViTpVfZpvxGQL5UeYfHkCxLFxlDMi/1Ur0cLx44Ws9ldlvOBLAhtvZ+SWbHHRhFa/VOpBvPw2RmwTUF/14JmsEm9NfthmH9CdwTfzcs0YkYcXXCz9ItBKKKHB+fT86weP3+PkLMEo4jg6yMBDEEZIgJbOdXbUjD65eHUHumD0PjPs7wJqsb/1TXh3aKU1MMKiwjb/bDNjtsJKkatYC3Hkrhc/kmXrscP3tmEy43dWJJlhyCMafnk3cO4sKVNlTXX+FMHbQ64HJ7OaCW+Bjk52by8cgyb948XkdGRnifAUjrzG0jT3oEgWN2NDIXq4w0ebMpDMTcXBZLFn9lnpUlAcoigC3Kz+GMZACHEgSRcaTH3g+97xY0qhiMkI0SfGQH6T112lj4XbcheEcxLkbD5RylhVaRrEaRnfSSp+oPhxIdbvezGqWyjEAyRUrWVCBd4+PSRbf79KaQTSL79/cUxtxf0SknSlmsfMUatmHLLDouq0eJrfPj1PjNymSYVBPuhdmkD4cgpz+7ircqqqEimd3+2Cqs/OtvIS87I3zt6JiLJxkYCMyeNkaYGZ5YINtYVVUVls6ysjJuGxn7WDl16hQHmkkua0MAh4H8lb0G+0wFM4PX0BBeBQZiza+2TEqaJ0eAGQpBJuUOYyZinpzkGHJyrNOeoY2ZB3XCGowOV0Cp0/HQQylEwT+ugHrOOrKLenz4+cfosfdCMJDdYZkZryh7qpKcXdnZ1VXBcg4/TkwUF2k0+00KxaNmhSJPIQiT/rLoaGv7/BeDgw+9HDGWpFOh5ckM/KFjBD+pv4MeZ5C19BOVMmiPLzDhlRXJaOwdxVxj9IR/8FE9zl9q5Uy7eq0LNvsoHz97oYXCEDOSE8xIosrklaX6HCNj6O4d4uHJ1MKcmhdeeAF2u5336+rqOOgh23jixAlcuXJlGiOFqX9jsfLpp59Kxz58jXutISCZB7Vq6WZsvdc0499Y1iDTmPe6sYAko09+cC8Ftb29cuBcUrQcyVoz8l+ZsJNmmhP+G2t0SLI1vg6l/QuI3jEEVBqoLQ9DsbgILT19+O4bu3BLHKDFoLCA7SOJZEZSQTpY86X+/TK9XvmEyfR30aK4MUWjyffpdM4NjY2RyaZpXgizsSPeAKxuOZwxq0Wyj360DpFtpsvvm6sPyypbwzXbn5eYTWS206jXUhCv4gLA7sOk1OX2kE1kGaEAv4Y5RVq6RqtR8+OP3vrnaX9jRXq1kvT1/0/8rwADAJ+LRelLmVNwAAAAAElFTkSuQmCC) !important;
}
#lleo_icons a:hover {
    opacity: 1 !important;
}
#lleo_icons a.lleo_google     {background-position:-34px 0 !important;}
#lleo_icons a.lleo_multitran  {background-position:-64px 0 !important;}
#lleo_icons a.lleo_lingvo     {background-position:-51px 0 !important; width: 12px !important;}
#lleo_icons a.lleo_dict       {background-position:-17px 0 !important;}
#lleo_icons a.lleo_linguee    {background-position:-81px 0 !important;}
#lleo_icons a.lleo_michaelis  {background-position:-98px 0 !important;}

#lleo_dialog #lleo_contextContainer {
    margin: 0 !important;
    padding: 3px 15px 8px 10px !important;
    background: #eee !important;
    background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#eee)) !important;
    background: -moz-linear-gradient(-90deg, #fff, #eee) !important;
    border-bottom: solid 1px #ddd !important;
    border-top-left-radius: 3px !important;
    border-top-right-radius: 3px !important;
    display: none !important;
    overflow: hidden !important;
}
#lleo_dialog .lleo_has_context #lleo_contextContainer {
    display: block !important;
}
#lleo_dialog #lleo_context {
    color: #444 !important;
    text-shadow: 1px 1px 0 #f4f4f4 !important;
    line-height: 12px !important;
    font-size: 11px !important;
    margin-left: 2px !important;
}
#lleo_dialog #lleo_context b {
    line-height: 12px !important;
    color: #000 !important;
    font-weight: bold !important;
    font-size: 11px !important;
}
/*#lleo_dialog #lleo_gBrand {
    color: #aaa !important;
    font-size: 10px !important;
    *//*padding-right: 52px !important;*//*
    padding-bottom: 14px !important;
    margin: -3px 4px 0 4px !important;
    background: left bottom url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADMAAAAPCAYAAABJGff8AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAcVSURBVHja3FZrbFTHFT4z97W++/KatfHGNrFjMNjFLQ24iiVIFBzCD1SFqj/aRlCUCvjRKlVatUFJVJJGNKUtoRVqgZZWKWCVOEqKQxsaUoypaWzclNgGI9sLtndZv9beh/d133ems3ZAvKTGkfqnZ3U1d++9M+d88535zkGUUsjbpl/PgixiEEz05aHLIzsjo9cwIrrEy4EA7ypLm8rMAX2q850cYGMtmoD3tKOgYwF0QDAUjcFwwoLG33ih5hkZIJwFGjMA8QDRaQuCIzb0ZtbCMe00oCRbwUIwU7EHwo4jYFs6VASWPb3cv+yP7SfO9RCNNFIByLMpB+ybKIRoLgeXZhKweYrAfzP+1h3CABY90n/unafCwSs/xJK7BfMOzVZjq2w92WJlbhyzLeWSyXuCTXgMOKDsh2Dhlp9HoF57DdzTX4H4kteh5iHtzcRo8ph9XQ+DwZFGJME+RQYq5b/99HYLjNch7gi2t35roOONNQX+mh4kF7GnGDjnA70sgCe0eG+tIlcGX3F0wwtSN+gqBwJGvEXBumdVti9ImB/vNcT2DQHBGriMBkh17QZH7dFCgetBbIcywOa9Cm4QecSYx3dsV3Nz8x3Ytm7dio4fP063bNmC4HZ3BWrqpyN950d5qaDHVqeA2gZw8mLgRA9YBCKGDR+8zF2E3eg8AOdoCFuo+YpitswiboAFtwvNb/qcaTmy5+qg3XwjQi7YBLUjBCXsmmMSIbrZUJKHBWr2muZYRyo0vSfWV+YkyMx/YTTZPDyBCh68QeAP/ap5WuX4fobrsZvB3z7mgdyXmeRUvEjTjE5O8gIlBmDRC2LRKigp8QClOSguRfCj0PcZatejHYb455ORxPZaEf5azaOXRET3ahQWUQk9r+fMjgOHVFvg6FN11dhbGYB+SuBaVud8HhHvGx88tT6RMp6JzXxhmZ6OrqfGwC98KyZT0excfPqLgs8R5jwdhyMTr22Q8W+9Dn4kTLi/s3fi3RzfZOa2hJi3gZCKBLnIxzmK2Mb7GRgPEGqBIIpQXl4OevVGeEt+EqDI/7v3QxPaoGa38hxn1RRwP17sdk/lOP67KpiPDX6YXXuxj758I4rSdVUQKSuGnU4ZPMkk3u3Skjsmr3V/bKszPQW+qiZPcSWxcvHtlpJJ2wyLm6DMGm9g54V4ungltj+u9chHuhRytU0hz88Rz8Qqn1J3j/cwkzF4Q3AvedhWoiyneeCdFWy2hU1d28YU5nFJkMUDeN17681gqUPJqH6OvRYlKA34wXR5O1EytDkXy2xi5wgFSpDM0p2RiMBVAmcWpYAmppOrr03FbVxY2+T2+WFJpQ/S4YgWSV8PIsEp2jr7HsAmNl7m0BVp2rbrT0TTb4YNu83xKXXmFjPsjJzmPVUyO/B7BV8dcAV+luGUnwr1jWcS0Wh8bORryvC7Femh/qElmCwu5ZHopDZjTgC5QMJjBNRYkrQWOimw1Pp6KdMP4mCIy0QlqWM6Ebp+fna8+3uUcwcKS1e0SJA7ef1fred8n1NfKFwqFCMm12lKudDw8PulShbnCC0ux7TtG4US7PDghYGxlcltQEiMd5bt4pyB/VhwA5aKDW9p/QfVdStPg5mBYZ1a/0yYO/xg05US6lhOdNlOxus+ikw29s5mfjadQJ1ZBf5dXQFbH6lHG3wcOIwkPnyqjUYsPXvI70dviCKDL8o0MtS/WbeLXi1cvdrSxLTTMgykPcDV/bwq027o6vgKgdtbJ6L9tRK31oXhyQVJM2MmTW2tiuiJvyB1+jvUSD+NJX+fDtLkR13dZZNXT13NYv5iO//g5U1a/7o4gV8FLTgRiqu5M+nULpuQoyYTpFSWNiTT8HtVh59Ajx0cGNazlwfg8/rqXyqLH9pW4ghNfns2HiWZWNx2V6zqivWHvho50zKk902eRYQzTnwRL60ds2r8YfLuoE2+KepGk0DooYaFgMnrP9PNLLXVx830iGzMXGpkuexVxMKJuGUErVQkgbAEBpkTlc4khS/N6hREU2PPWIlAedllVLNLN2H7xAyFmQSBVAbBbP1+sKufexRGPzw52vW34xZFe4Cil6TihzshLv4JTq5zEmfrBjYTwMRAWFQKhQ1X9HzRNKFeRAsrmncUNcQrFKG2ucrAOgOOF8BmopCvI+iTYpLPT475EBgCfJevPCieoyCxIxP2vQIZx7MQ0FKv9/VdELRc/DlP5UZwuIqgYNHSjYmBtzvpoOqSXI9k9eWd833FnJ/82vPx4IV2APcDBZ+pXflkYUxhXK+BsxOb2L8eiFLrHyq3ZI1nacNBuaT+oNPBs7oZfdFIDbeAhLOcUQZcrhwIGv3Mfnn4H1k+HMVwQTY1zdoelj6U/MA2ZmcBcVu0xOAazUiMqTN9Z3U1cRALMiBbuF9dXJjPm13z/4P9R4ABANu4bb16FOo4AAAAAElFTkSuQmCC) no-repeat !important;
    display: inline-block !important;
    float: right !important;
}
#lleo_dialog #lleo_gBrand.hidden {
    display: none !important;
}*/
#lleo_dialog #lleo_translateContextLink {
    color: #444 !important;
    text-shadow: 1px 1px 0 #f4f4f4 !important;
    background: -webkit-gradient(linear, left top, left bottom, from(#f4f4f4), to(#ddd)) !important;
    background: -moz-linear-gradient(-90deg, #f4f4f4, #ddd) !important;
    border: solid 1px !important;
    box-shadow: 1px 1px 0 #f6f6f6 !important;
    border-color: #999 #aaa #aaa #999 !important;
    -moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
    padding: 0 3px !important;
    font-size: 11px !important;
    text-decoration: none !important;
    margin: 1px 5px 0 !important;
    display: inline-block !important;
    white-space: nowrap !important;
}
#lleo_dialog #lleo_translateContextLink:hover {
    background: #f8f8f8 !important;
}
#lleo_dialog #lleo_translateContextLink.hidden {
    visibility: hidden !important;
}

#lleo_dialog #lleo_setTransForm {
    display: block !important;
    margin-top: 3px !important;
    padding-top: 5px !important;
    /* Set position and background because the form might be overlapped by an image when no translations */
    position: relative !important;
    background: #fff !important;
    z-index: 10 !important;
    padding-bottom: 10px !important;
    padding-left: 16px !important;
}
#lleo_dialog .lleo-custom-translation {
    padding: 4px 5px !important;
    border: solid 1px #ddd !important;
	border-radius: 2px !important;
    width: 90% !important;
    min-width: 270px !important;
    background: -webkit-gradient(linear, 0 0, 0 20, from(#f1f1f1), to(#fff)) !important;
    background: -moz-linear-gradient(-90deg, #f1f1f1, #fff) !important;
	font: normal 13px Arial, Helvetica !important;
	line-height: 15px !important;
}
#lleo_dialog .lleo-custom-translation:hover {
    border: solid 1px #aaa !important;
}
#lleo_dialog .lleo-custom-translation:focus {
    background: #FFFEC9 !important;
}

#lleo_dialog *.hidden {
    display: none !important;
}

#lleo_dialog .infinitive{
    color: #D56E00 !important;
    text-decoration: none;
    border-bottom: 1px dotted #D56E00 !important;
}
#lleo_dialog .infinitive:hover{
    border: none !important;
}

#lleo_dialog .lleo_separator {
    height: 1px !important;
    background: #eee;
    margin-top: 10px !important;
    background: -webkit-linear-gradient(left, rgba(255,255,255,1) 0%,#eee 8%,rgba(255,255,255,1) 80%) !important;
    background: -moz-linear-gradient(left, rgba(255,255,255,1) 0%, #eee 8%, rgba(255,255,255,1) 80%) !important;
    background: -ms-linear-gradient(left, rgba(255,255,255,1) 0%,#eee 8%,rgba(255,255,255,1) 80%) !important;
    background: linear-gradient(to right, rgba(255,255,255,1) 0%,#eee 8%,rgba(255,255,255,1) 80%) !important;
}
#lleo_dialog #lleo_trans {
    /*border-top: 1px solid #eeeeee !important;*/
    padding: 5px 30px 0 14px !important;
    zoom: 1;
}

#lleo_dialog .lleo_clearfix {
	display: block !important;
	clear: both !important;
	visibility: hidden !important;
	height: 0 !important;
	font-size: 0 !important;
}


#lleo_dialog #lleo_picOuter table {
    width: 44px !important;
    position: absolute !important;
    right: 0 !important;
    top: 0 !important;
    vertical-align: middle !important;
}

#lleo_dialog #lleo_picOuter td {
    width: 38px !important;
    height: 38px !important;
    /*border: 1px solid #eeeeee !important;*/
    vertical-align: middle !important;
    text-align: center !important;
}

#lleo_dialog #lleo_picOuter td div {
	height: 38px !important;
	overflow: hidden !important;
}

#lleo_dialog .lleo_empty {
    margin: 0 5px 7px !important;
}

#lleo_youtubeExportBtn {
    margin-left: 10px;
    height: 24px;
}
    #lleo_youtubeExportBtn i {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: 0 0 url(https://d144fqpiyasmrr.cloudfront.net/plugins/all/images/i16.png) !important;
    }
    #lleo_youtubeExportBtn .yt-uix-button-content {
        font-size: 12px;
        line-height: 2px;
    }


/*** Parsed Lyrics Content *****************************/

.lleo_lyrics tran {
    background: transparent !important;
    border-radius: 2px !important;
    text-shadow: none !important;
    cursor: pointer !important;
}
    .lleo_lyrics tran:hover {
        color: #fff !important;
        background: #C77213 !important;
        -webkit-transition: all 0.1s !important;
        -moz-transition: all 0.1s !important;
        -ms-transition: all 0.1s !important;
        -o-transition: all 0.1s !important;
        transition: all 0.1s !important;
    }

.lleo_songName {
    border: solid 1px #ffd47c;
    background: #fff1c2;
    border-radius: 2px;
}

.lleo_hidden_iframe {
    visibility: hidden;
}</style></head>
<body style="-webkit-text-stroke-width: 0.5px;" class="show-sts">
<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="https://spring.io/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="https://spring.io/docs">Docs</a>
</li>
<li class="navbar-link active">
<a href="https://spring.io/guides">Guides</a>
</li>
<li class="navbar-link">
<a href="https://spring.io/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="https://spring.io/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="https://spring.io/questions">Questions</a>
</li>
<li class="navbar-link nav-search">
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<div class="search-input-close js-search-input-close">x</div>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="https://spring.io/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="https://spring.io/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="https://spring.io/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="https://spring.io/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="https://spring.io/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="https://spring.io/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="https://spring.io/questions">
Questions
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="https://spring.io/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="body--container container-fluid ">
<main class="main-body--wrapper">
<div class="row-fluid">
<div class="span8 mobile-left-pane">
<div class="content--title desktop-only">
Getting Started
</div>
<article class="content--container">
<h1 class="title">Spring Security and Angular JS</h1>
<div class="article-body"><div class="sect1">
<h2 id="_spring_and_angular_js_a_secure_single_page_application">A Secure Single Page Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we show some nice features of Spring Security, Spring Boot and Angular JS working together to provide a pleasant and secure user experience. It should be accessible to beginners with Spring and Angular JS, but there also is plenty of detail that will be of use to experts in either. This is actually the first in a series of sections on Spring Security and Angular JS, with new features exposed in each one successively. Weâll improve on the application in the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">second</a> and subsequent installments, but the main changes after this are architectural rather than functional.</p>
</div>
<div class="sect2">
<h3 id="_spring_and_the_single_page_application">Spring and the Single Page Application</h3>
<div class="paragraph">
<p>HTML5, rich browser-based features, and the "single page application" are extremely valuable tools for modern developers, but any meaningful interactions will involve a backend server, so as well as static content (HTML, CSS and JavaScript) we are going to need a backend server. The backend server can play any or all of a number of roles: serving static content, sometimes (but not so often these days) rendering dynamic HTML, authenticating users, securing access to protected resources, and (last but not least) interacting with JavaScript in the browser through HTTP and JSON (sometimes referred to as a REST API).</p>
</div>
<div class="paragraph">
<p>Spring has always been a popular technology for building the backend features (especially in the enterprise), and with the advent of <a href="http://projects.spring.io/spring-boot">Spring Boot</a> things have never been easier. Letâs have a look at how to build a new single page application from nothing using Spring Boot, Angular JS and Twitter Bootstrap. Thereâs no particular reason to choose that specific stack, but it is quite popular, especially with the core Spring constituency in enterprise Java shops, so itâs a worthwhile starting point.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_new_project">Create a New Project</h3>
<div class="paragraph">
<p>We are going to step through creating this application in some detail, so that anyone who isnât completely au fait with Spring and Angular can follow what is happening. If you prefer to cut to this chase, you can <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#how-does-it-work">skip to the end</a> where the application is working, and see how it all fits together. There are various options for creating a new project:</p>
</div>
<div class="ulist">
<ul>
<li> <p><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#using-curl">Using curl on the command line</a></p> </li>
<li> <p><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#using-spring-boot-cli">Using Spring Boot CLI</a></p> </li>
<li> <p><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#using-the-initializr-website">Using the Spring Initializr website</a></p> </li>
<li> <p><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#using-spring-tool-suite">Using Spring Tool Suite</a></p> </li>
</ul>
</div>
<div class="paragraph">
<p>The source code for the complete project we are going to build is in <a href="https://github.com/dsyer/spring-security-angular/tree/master/basic">Github here</a>, so you can just clone the project and work directly from there if you want. Then jump to the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#add-a-home-page">next section</a>.</p>
</div>
<div class="sect3">
<h4 id="using-curl">Using Curl</h4>
<div class="paragraph">
<p>The easiest way to create a new project to get started is via the <a href="https://start.spring.io/">Spring Boot Initializr</a>. E.g. using curl on a UN*X like system:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mkdir ui &amp;&amp; cd ui
$ curl https://start.spring.io/starter.tgz -d style=web \
-d style=security -d name=ui | tar -xzvf -"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mkdir ui </span><span class="pun">&amp;&amp;</span><span class="pln"> cd ui
$ curl https</span><span class="pun">:</span><span class="com">//start.spring.io/starter.tgz -d style=web \</span><span class="pln">
</span><span class="pun">-</span><span class="pln">d style</span><span class="pun">=</span><span class="pln">security </span><span class="pun">-</span><span class="pln">d name</span><span class="pun">=</span><span class="pln">ui </span><span class="pun">|</span><span class="pln"> tar </span><span class="pun">-</span><span class="pln">xzvf </span><span class="pun">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then import that project (itâs a normal Maven Java project by default) into your favourite IDE, or just work with the files and "mvn" on the command line. Then jump to the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#add-a-home-page">next section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-spring-boot-cli">Using Spring Boot CLI</h4>
<div class="paragraph">
<p>You can create the same project using the <a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#getting-started-installing-the-cli">Spring Boot CLI</a>, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ spring init --dependencies web,security ui/ &amp;&amp; cd ui"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ spring init </span><span class="pun">--</span><span class="pln">dependencies web</span><span class="pun">,</span><span class="pln">security ui</span><span class="pun">/</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> cd ui</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then jump to the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#add-a-home-page">next section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-the-initializr-website">Using the Initializr Website</h4>
<div class="paragraph">
<p>If you prefer you can also get the same code directly as a .zip file from the <a href="https://start.spring.io/">Spring Boot Initializr</a>. Just open it up in your browser and select dependencies "Web" and "Security", then click on "Generate Project". The .zip file contains a standard Maven or Gradle project in the root directory, so you might want to create an empty directory before you unpack it. Then jump to the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#add-a-home-page">next section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-spring-tool-suite">Using Spring Tool Suite</h4>
<div class="paragraph">
<p>In <a href="http://spring.io/tools/sts">Spring Tool Suite</a> (a set of Eclipse plugins) you can also create and import a project using a wizard at <code>File-&gt;New-&gt;Spring Starter Project</code>. Then jump to the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#add-a-home-page">next section</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="add-a-home-page">Add a Home Page</h3>
<div class="paragraph">
<p>The core of a single page application is a static "index.html", so letâs go ahead and create one (in "src/main/resources/static" or "src/main/resources/public"):</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Hello AngularJS&lt;/title&gt;
&lt;link href=&quot;css/angular-bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;style type=&quot;text/css&quot;&gt;
[ng\:cloak], [ng-cloak], .ng-cloak {
  display: none !important;
}
&lt;/style&gt;
&lt;/head&gt;

&lt;body ng-app=&quot;hello&quot;&gt;
  &lt;div class=&quot;container&quot;&gt;
    &lt;h1&gt;Greeting&lt;/h1&gt;
    &lt;div ng-controller=&quot;home&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
      &lt;p&gt;The ID is {{greeting.id}}&lt;/p&gt;
      &lt;p&gt;The content is {{greeting.content}}&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;script src=&quot;js/angular-bootstrap.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
  &lt;script src=&quot;js/hello.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="dec">&lt;!doctype html&gt;</span><span class="pln">
</span><span class="tag">&lt;html&gt;</span><span class="pln">
</span><span class="tag">&lt;head&gt;</span><span class="pln">
</span><span class="tag">&lt;title&gt;</span><span class="pln">Hello AngularJS</span><span class="tag">&lt;/title&gt;</span><span class="pln">
</span><span class="tag">&lt;link</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"css/angular-bootstrap.css"</span><span class="pln"> </span><span class="atn">rel</span><span class="pun">=</span><span class="atv">"stylesheet"</span><span class="tag">&gt;</span><span class="pln">
</span><span class="tag">&lt;style</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/css"</span><span class="tag">&gt;</span><span class="pln">
</span><span class="pun">[</span><span class="pln">ng\:cloak</span><span class="pun">],</span><span class="pln"> </span><span class="pun">[</span><span class="pln">ng</span><span class="pun">-</span><span class="pln">cloak</span><span class="pun">],</span><span class="pln"> </span><span class="pun">.</span><span class="pln">ng</span><span class="pun">-</span><span class="pln">cloak </span><span class="pun">{</span><span class="pln">
  display</span><span class="pun">:</span><span class="pln"> none </span><span class="pun">!</span><span class="pln">important</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span><span class="pln">
</span><span class="tag">&lt;/head&gt;</span><span class="pln">

</span><span class="tag">&lt;body</span><span class="pln"> </span><span class="atn">ng-app</span><span class="pun">=</span><span class="atv">"hello"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;h1&gt;</span><span class="pln">Greeting</span><span class="tag">&lt;/h1&gt;</span><span class="pln">
    </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"home"</span><span class="pln"> </span><span class="atn">ng-cloak</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"ng-cloak"</span><span class="tag">&gt;</span><span class="pln">
      </span><span class="tag">&lt;p&gt;</span><span class="pln">The ID is {{greeting.id}}</span><span class="tag">&lt;/p&gt;</span><span class="pln">
      </span><span class="tag">&lt;p&gt;</span><span class="pln">The content is {{greeting.content}}</span><span class="tag">&lt;/p&gt;</span><span class="pln">
    </span><span class="tag">&lt;/div&gt;</span><span class="pln">
  </span><span class="tag">&lt;/div&gt;</span><span class="pln">
  </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"js/angular-bootstrap.js"</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln">
  </span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"js/hello.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln">
</span><span class="tag">&lt;/body&gt;</span><span class="pln">
</span><span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Itâs pretty short and sweet because it is just going to say "Hello World".</p>
</div>
<div class="sect3">
<h4 id="_features_of_the_home_page">Features of the Home Page</h4>
<div class="paragraph">
<p>Salient features include:</p>
</div>
<div class="ulist">
<ul>
<li> <p>Some CSS imported in the <code>&lt;head&gt;</code>, one placeholder for a file that doesnât yet exist, but is named suggestively ("angular-bootstrap.css") and one inline stylesheet defining the <a href="https://docs.angularjs.org/api/ng/directive/ngCloak">"ng-cloak"</a> class.</p> </li>
<li> <p>The "ng-cloak" class is applied to the content <code>&lt;div&gt;</code> so that dynamic content is hidden until Angular JS has had a chance to process it (this prevents "flickering" during the initial page load).</p> </li>
<li> <p>The <code>&lt;body&gt;</code> is marked as <code>ng-app="hello"</code> which means we need to define a JavaScript module that Angular will recognise as an application called "hello".</p> </li>
<li> <p>All the CSS classes (apart from "ng-cloak") are from <a href="http://getbootstrap.com/">Twitter Bootstrap</a>. They will make things look pretty once we get the right stylesheets set up.</p> </li>
<li> <p>The content in the greeting is marked up using handlebars, e.g. <code>{{greeting.content}}</code> and this will be filled in later by Angular (using a "controller" called "home" according to the <code>ng-controller</code> directive on the surrounding <code>&lt;div&gt;</code>).</p> </li>
<li> <p>Angular JS (and Twitter Bootstrap) are included at the bottom of the <code>&lt;body&gt;</code> so that the browser can process all the HTML before it gets processed.</p> </li>
<li> <p>We also include a separate "hello.js" which is where we are going to define the application behaviour.</p> </li>
</ul>
</div>
<div class="paragraph">
<p>We are going to create the script and stylesheet assets in a minute, but for now we can ignore the fact that they donât exist.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_application">Running the Application</h4>
<div class="paragraph">
<p>Once the home page file is added, your application will be loadable in a browser (even though it doesnât do much yet). On the command line you can do this</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mvn spring-boot:run"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mvn spring</span><span class="pun">-</span><span class="pln">boot</span><span class="pun">:</span><span class="pln">run</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and go to a browser at <a href="http://localhost:8080/">http://localhost:8080</a>. When you load the home page you should get a browser dialog asking for username and password (the username is "user" and the password is printed in the console logs on startup). Thereâs actually no content yet, so you should get a blank page with a "Greeting" header once you successfully authenticate.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td>
<td class="content"> If you donât like scraping the console log for the password just add this to the "application.properties" (in "src/main/resources"): <code>security.user.password=password</code> (and choose your own password). We did this in the sample code using "application.yml". </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>In an IDE, just run the <code>main()</code> method in the application class (there is only one class, and it is called <code>UiApplication</code> if you used the "curl" command above).</p>
</div>
<div class="paragraph">
<p>To package and run as a standalone JAR, you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mvn package
$ java -jar target/*.jar"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mvn </span><span class="kwd">package</span><span class="pln">
$ java </span><span class="pun">-</span><span class="pln">jar target</span><span class="com">/*.jar</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_front_end_assets">Front End Assets</h3>
<div class="paragraph">
<p>Entry-level tutorials on Angular and other front end technologies often just include the library assets directly from the internet (e.g. <a href="https://docs.angularjs.org/misc/downloading">the Angular JS website</a> itself recommends downloading from <a href="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0/angular.min.js">Google CDN</a>). Instead of doing that we are going to generate the "angular-bootstrap.js" asset by concatenating several files from such libraries. This is not strictly necessary to get the application working, but it <em>is</em> best practice for a production application to consolidate scripts to avoid chatter between the browser and the server (or content delivery network). Since we arenât modifying or customizing the CSS stylesheets it is also unecessary to generate the "angular-bootstrap.css", and we could just use static assets from Google CDN for that as well. However, in a real application we almost certainly would want to modify the stylesheets and we wouldnât want to edit the CSS sources by hand, so we would use a higher level tool (e.g. <a href="http://lesscss.org/">Less</a> or <a href="http://sass-lang.com/">Sass</a>), so we are going to use one too.</p>
</div>
<div class="paragraph">
<p>There are many different ways of doing this, but for the purposes of this section, we are going to use <a href="http://alexo.github.io/wro4j/">wro4j</a>, which is a Java-based toolchain for preprocessing and packaging front end assets. It can be used as a JIT (Just in Time) <code>Filter</code> in any Servlet application, but it also has good support for build tools like Maven and Eclipse, and that is how we are going to use it. So we are going to build static resource files and bundle them in our application JAR.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Aside: Wro4j is probably not the tool of choice for hard-core front end developers - they would probably be using a node-based toolchain, with <a href="http://bower.io/">bower</a> and/or <a href="http://gruntjs.com/">grunt</a>. These are definitely excellent tools, and covered in great detail all over the internet, so please feel free to use them if you prefer. If you just put the outputs from those toolchains in "src/main/resources/static" then it will all work. I find wro4j comfortable because I am not a hard-core front end developer and I know how to use Java-based tooling.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>To create static resources at build time we add some magic to the Maven <code>pom.xml</code> (itâs quite verbose, but boilerplate, so it could be extracted into a parent pom in Maven, or a shared task or plugin for Gradle):</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;build&gt;
  &lt;resources&gt;
    &lt;resource&gt;
      &lt;directory&gt;${project.basedir}/src/main/resources&lt;/directory&gt;
    &lt;/resource&gt;
    &lt;resource&gt;
      &lt;directory&gt;${project.build.directory}/generated-resources&lt;/directory&gt;
    &lt;/resource&gt;
  &lt;/resources&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;!-- Serves *only* to filter the wro.xml so it can get an absolute
            path for the project --&gt;
          &lt;id&gt;copy-resources&lt;/id&gt;
          &lt;phase&gt;validate&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;copy-resources&lt;/goal&gt;
          &lt;/goals&gt;
          &lt;configuration&gt;
            &lt;outputDirectory&gt;${basedir}/target/wro&lt;/outputDirectory&gt;
            &lt;resources&gt;
              &lt;resource&gt;
                &lt;directory&gt;src/main/wro&lt;/directory&gt;
                &lt;filtering&gt;true&lt;/filtering&gt;
              &lt;/resource&gt;
            &lt;/resources&gt;
          &lt;/configuration&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;ro.isdc.wro4j&lt;/groupId&gt;
      &lt;artifactId&gt;wro4j-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.7.6&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;phase&gt;generate-resources&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;run&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
      &lt;configuration&gt;
        &lt;wroManagerFactory&gt;ro.isdc.wro.maven.plugin.manager.factory.ConfigurableWroManagerFactory&lt;/wroManagerFactory&gt;
        &lt;cssDestinationFolder&gt;${project.build.directory}/generated-resources/static/css&lt;/cssDestinationFolder&gt;
        &lt;jsDestinationFolder&gt;${project.build.directory}/generated-resources/static/js&lt;/jsDestinationFolder&gt;
        &lt;wroFile&gt;${project.build.directory}/wro/wro.xml&lt;/wroFile&gt;
        &lt;extraConfigFile&gt;${basedir}/src/main/wro/wro.properties&lt;/extraConfigFile&gt;
        &lt;contextFolder&gt;${basedir}/src/main/wro&lt;/contextFolder&gt;
      &lt;/configuration&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.webjars&lt;/groupId&gt;
          &lt;artifactId&gt;jquery&lt;/artifactId&gt;
          &lt;version&gt;2.1.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.webjars&lt;/groupId&gt;
          &lt;artifactId&gt;angularjs&lt;/artifactId&gt;
          &lt;version&gt;1.3.8&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.webjars&lt;/groupId&gt;
          &lt;artifactId&gt;bootstrap&lt;/artifactId&gt;
          &lt;version&gt;3.2.0&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;build&gt;</span><span class="pln">
  </span><span class="tag">&lt;resources&gt;</span><span class="pln">
    </span><span class="tag">&lt;resource&gt;</span><span class="pln">
      </span><span class="tag">&lt;directory&gt;</span><span class="pln">${project.basedir}/src/main/resources</span><span class="tag">&lt;/directory&gt;</span><span class="pln">
    </span><span class="tag">&lt;/resource&gt;</span><span class="pln">
    </span><span class="tag">&lt;resource&gt;</span><span class="pln">
      </span><span class="tag">&lt;directory&gt;</span><span class="pln">${project.build.directory}/generated-resources</span><span class="tag">&lt;/directory&gt;</span><span class="pln">
    </span><span class="tag">&lt;/resource&gt;</span><span class="pln">
  </span><span class="tag">&lt;/resources&gt;</span><span class="pln">
  </span><span class="tag">&lt;plugins&gt;</span><span class="pln">
    </span><span class="tag">&lt;plugin&gt;</span><span class="pln">
      </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-maven-plugin</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
    </span><span class="tag">&lt;/plugin&gt;</span><span class="pln">
    </span><span class="tag">&lt;plugin&gt;</span><span class="pln">
      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">maven-resources-plugin</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
      </span><span class="tag">&lt;executions&gt;</span><span class="pln">
        </span><span class="tag">&lt;execution&gt;</span><span class="pln">
          </span><span class="com">&lt;!-- Serves *only* to filter the wro.xml so it can get an absolute
            path for the project --&gt;</span><span class="pln">
          </span><span class="tag">&lt;id&gt;</span><span class="pln">copy-resources</span><span class="tag">&lt;/id&gt;</span><span class="pln">
          </span><span class="tag">&lt;phase&gt;</span><span class="pln">validate</span><span class="tag">&lt;/phase&gt;</span><span class="pln">
          </span><span class="tag">&lt;goals&gt;</span><span class="pln">
            </span><span class="tag">&lt;goal&gt;</span><span class="pln">copy-resources</span><span class="tag">&lt;/goal&gt;</span><span class="pln">
          </span><span class="tag">&lt;/goals&gt;</span><span class="pln">
          </span><span class="tag">&lt;configuration&gt;</span><span class="pln">
            </span><span class="tag">&lt;outputDirectory&gt;</span><span class="pln">${basedir}/target/wro</span><span class="tag">&lt;/outputDirectory&gt;</span><span class="pln">
            </span><span class="tag">&lt;resources&gt;</span><span class="pln">
              </span><span class="tag">&lt;resource&gt;</span><span class="pln">
                </span><span class="tag">&lt;directory&gt;</span><span class="pln">src/main/wro</span><span class="tag">&lt;/directory&gt;</span><span class="pln">
                </span><span class="tag">&lt;filtering&gt;</span><span class="pln">true</span><span class="tag">&lt;/filtering&gt;</span><span class="pln">
              </span><span class="tag">&lt;/resource&gt;</span><span class="pln">
            </span><span class="tag">&lt;/resources&gt;</span><span class="pln">
          </span><span class="tag">&lt;/configuration&gt;</span><span class="pln">
        </span><span class="tag">&lt;/execution&gt;</span><span class="pln">
      </span><span class="tag">&lt;/executions&gt;</span><span class="pln">
    </span><span class="tag">&lt;/plugin&gt;</span><span class="pln">
    </span><span class="tag">&lt;plugin&gt;</span><span class="pln">
      </span><span class="tag">&lt;groupId&gt;</span><span class="pln">ro.isdc.wro4j</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">wro4j-maven-plugin</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
      </span><span class="tag">&lt;version&gt;</span><span class="pln">1.7.6</span><span class="tag">&lt;/version&gt;</span><span class="pln">
      </span><span class="tag">&lt;executions&gt;</span><span class="pln">
        </span><span class="tag">&lt;execution&gt;</span><span class="pln">
          </span><span class="tag">&lt;phase&gt;</span><span class="pln">generate-resources</span><span class="tag">&lt;/phase&gt;</span><span class="pln">
          </span><span class="tag">&lt;goals&gt;</span><span class="pln">
            </span><span class="tag">&lt;goal&gt;</span><span class="pln">run</span><span class="tag">&lt;/goal&gt;</span><span class="pln">
          </span><span class="tag">&lt;/goals&gt;</span><span class="pln">
        </span><span class="tag">&lt;/execution&gt;</span><span class="pln">
      </span><span class="tag">&lt;/executions&gt;</span><span class="pln">
      </span><span class="tag">&lt;configuration&gt;</span><span class="pln">
        </span><span class="tag">&lt;wroManagerFactory&gt;</span><span class="pln">ro.isdc.wro.maven.plugin.manager.factory.ConfigurableWroManagerFactory</span><span class="tag">&lt;/wroManagerFactory&gt;</span><span class="pln">
        </span><span class="tag">&lt;cssDestinationFolder&gt;</span><span class="pln">${project.build.directory}/generated-resources/static/css</span><span class="tag">&lt;/cssDestinationFolder&gt;</span><span class="pln">
        </span><span class="tag">&lt;jsDestinationFolder&gt;</span><span class="pln">${project.build.directory}/generated-resources/static/js</span><span class="tag">&lt;/jsDestinationFolder&gt;</span><span class="pln">
        </span><span class="tag">&lt;wroFile&gt;</span><span class="pln">${project.build.directory}/wro/wro.xml</span><span class="tag">&lt;/wroFile&gt;</span><span class="pln">
        </span><span class="tag">&lt;extraConfigFile&gt;</span><span class="pln">${basedir}/src/main/wro/wro.properties</span><span class="tag">&lt;/extraConfigFile&gt;</span><span class="pln">
        </span><span class="tag">&lt;contextFolder&gt;</span><span class="pln">${basedir}/src/main/wro</span><span class="tag">&lt;/contextFolder&gt;</span><span class="pln">
      </span><span class="tag">&lt;/configuration&gt;</span><span class="pln">
      </span><span class="tag">&lt;dependencies&gt;</span><span class="pln">
        </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
          </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.webjars</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
          </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">jquery</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
          </span><span class="tag">&lt;version&gt;</span><span class="pln">2.1.1</span><span class="tag">&lt;/version&gt;</span><span class="pln">
        </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
        </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
          </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.webjars</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
          </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">angularjs</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
          </span><span class="tag">&lt;version&gt;</span><span class="pln">1.3.8</span><span class="tag">&lt;/version&gt;</span><span class="pln">
        </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
        </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
          </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.webjars</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
          </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">bootstrap</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
          </span><span class="tag">&lt;version&gt;</span><span class="pln">3.2.0</span><span class="tag">&lt;/version&gt;</span><span class="pln">
        </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
      </span><span class="tag">&lt;/dependencies&gt;</span><span class="pln">
    </span><span class="tag">&lt;/plugin&gt;</span><span class="pln">
  </span><span class="tag">&lt;/plugins&gt;</span><span class="pln">
</span><span class="tag">&lt;/build&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can copy that verbatim into your POM, or just scan it if you are following along from the <a href="https://github.com/dsyer/spring-security-angular/tree/master/basic/pom.xml#L43">source in Github</a>. The main points are:</p>
</div>
<div class="ulist">
<ul>
<li> <p>We are including some webjars libraries as dependencies (jquery and bootstrap for CSS and styling, and Angular JS for business logic). Some of the static resources in those jar files will be included in our generated "angular-bootstrap.*" files, but the jars themselves donât need to be packaged with the application.</p> </li>
<li> <p>Twitter Bootstrap has a dependency on jQuery, so we include that as well. An Angular JS application that didnât use Bootstrap wouldnât need that since Angular has its own version of the features it needs from jQuery.</p> </li>
<li> <p>The generated resources will go in "target/generated-resources", and because that is declared in the <code>&lt;resources/&gt;</code> section, they will be packaged in the output JAR from the project, and available on the classpath in the IDE (as long as we are using Maven tooling, e.g. m2e in Eclipse).</p> </li>
<li> <p>The wro4j-maven-plugin has some Eclipse integration features and you can install it from the Eclipse Marketplace (try it later if this is your first time - itâs not needed to complete the application). If you do that then Eclipse will watch the source files and re-generate the outputs if they change. If you run in debug mode then changes are immediately re-loadable in a browser.</p> </li>
<li> <p>Wro4j is controlled from an XML configuration file that doesnât know about your build classpath, and only understand absolute file paths, so we have to create an absolute file location and insert it in <code>wro.xml</code>. For that purpose we use Maven resource filtering and that is why there is an explicit "maven-resources-plugin" declaration.</p> </li>
</ul>
</div>
<div class="paragraph">
<p>Thatâs all of the changes we are going to need to the POM. It remains to add the wro4j build files, which we have specified are going to live in "src/main/wro".</p>
</div>
<div class="sect3">
<h4 id="_wro4j_source_files">Wro4j Source Files</h4>
<div class="paragraph">
<p>If you look in the <a href="https://github.com/dsyer/spring-security-angular/tree/master/basic/src/main/wro">source code in Github</a> you will see there are only 3 files (and one of those is empty, ready for later customization):</p>
</div>
<div class="ulist">
<ul>
<li> <p><code>wro.properties</code> is a configuration file for the preprocessing and rendering engine in wro4j. You can use it to switch on and off various parts of the toolchain. In this case we use it to compile CSS from <a href="http://lesscss.org/">Less</a> and to minify JavaScript, ultimately combining the sources from all the libraries we need in two files.</p>
<div class="listingblock">
<div class="title">
wro.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="preProcessors=lessCssImport
postProcessors=less4j,jsMin"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">preProcessors</span><span class="pun">=</span><span class="pln">lessCssImport
postProcessors</span><span class="pun">=</span><span class="pln">less4j</span><span class="pun">,</span><span class="pln">jsMin</span></code></pre>
</div>
</div> </li>
<li> <p><code>wro.xml</code> declares a single "group" of resources called "angular-bootstrap", and this ends up being the base name of the static resources that are generated. It includes references to <code>&lt;css&gt;</code> and <code>&lt;js&gt;</code> elements in the webjars we added, and also to a local source file <code>main.less</code>.</p>
<div class="listingblock">
<div class="title">
wro.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;groups xmlns=&quot;http://www.isdc.ro/wro&quot;&gt;
  &lt;group name=&quot;angular-bootstrap&quot;&gt;
  &lt;css&gt;webjar:bootstrap/3.2.0/less/bootstrap.less&lt;/css&gt;
    &lt;css&gt;file:${project.basedir}/src/main/wro/main.less&lt;/css&gt;
    &lt;js&gt;webjar:jquery/2.1.1/jquery.min.js&lt;/js&gt;
    &lt;js&gt;webjar:angularjs/1.3.8/angular.min.js&lt;/js&gt;
  &lt;/group&gt;
&lt;/groups&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;groups</span><span class="pln"> </span><span class="atn">xmlns</span><span class="pun">=</span><span class="atv">"http://www.isdc.ro/wro"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;group</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"angular-bootstrap"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;css&gt;</span><span class="pln">webjar:bootstrap/3.2.0/less/bootstrap.less</span><span class="tag">&lt;/css&gt;</span><span class="pln">
    </span><span class="tag">&lt;css&gt;</span><span class="pln">file:${project.basedir}/src/main/wro/main.less</span><span class="tag">&lt;/css&gt;</span><span class="pln">
    </span><span class="tag">&lt;js&gt;</span><span class="pln">webjar:jquery/2.1.1/jquery.min.js</span><span class="tag">&lt;/js&gt;</span><span class="pln">
    </span><span class="tag">&lt;js&gt;</span><span class="pln">webjar:angularjs/1.3.8/angular.min.js</span><span class="tag">&lt;/js&gt;</span><span class="pln">
  </span><span class="tag">&lt;/group&gt;</span><span class="pln">
</span><span class="tag">&lt;/groups&gt;</span></code></pre>
</div>
</div> </li>
<li> <p><code>main.less</code> is empty in the sample code, but could be used to customise the look and feel, changing the default settings in Twitter Bootstrap. E.g. to change the colours from default blue to light pink you could add a single line:</p>
<div class="listingblock">
<div class="title">
main.less
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@brand-primary: #de8579;"></button><pre class="prettyprint highlight prettyprinted"><code><span class="lit">@brand</span><span class="pun">-</span><span class="pln">primary</span><span class="pun">:</span><span class="pln"> </span><span class="com">#de8579;</span></code></pre>
</div>
</div> </li>
</ul>
</div>
<div class="paragraph">
<p>Copy those files to your project and run "mvn package" and you should see the "bootstrap-angular.*" resources show up in your JAR file. If you run the app now, you should see the CSS take effect, but the business logic and navigation is still missing.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_angular_application">Create the Angular Application</h3>
<div class="paragraph">
<p>Letâs create the "hello" application (in "src/main/resources/static/js/hello.js" so that the <code>&lt;script/&gt;</code> at the bottom of our "index.html" finds it in the right place).</p>
</div>
<div class="paragraph">
<p>A minimal Angular JS application looks like this:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [])
  .controller(&#39;home&#39;, function($scope) {
    $scope.greeting = {id: &#39;xxx&#39;, content: &#39;Hello World!&#39;}
})"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[])</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln">id</span><span class="pun">:</span><span class="pln"> </span><span class="str">'xxx'</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Hello World!'</span><span class="pun">}</span><span class="pln">
</span><span class="pun">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the application is "hello" and it has an empty (and redundant) "config" and an empty "controller" called "home". The "home" controller will be called when we load the "index.html" because we have decorated the content <code>&lt;div&gt;</code> with <code>ng-controller="home"</code>.</p>
</div>
<div class="paragraph">
<p>Notice that we injected a magic <code>$scope</code> into the controller function (Angular does <a href="https://docs.angularjs.org/tutorial">dependency injection by naming convention</a>, and recognises the names of your function parameters). The <code>$scope</code> is then used inside the function to set up content and behaviour for the UI elements that this controller is responsible for.</p>
</div>
<div class="paragraph">
<p>If you added that file under "src/main/resources/static/js" your app should now be secure and functional, and it will say "Hello World!". The <code>greeting</code> is rendered by Angular in the HTML using the handlebar placeholders, <code>{{greeting.id}}</code> and <code>{{greeting.content}}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-content">Adding Dynamic Content</h3>
<div class="paragraph">
<p>So far we have an application with a greeting that is hard coded. Thatâs useful for learning how things fit together, but really we expect content to come from a backend server, so letâs create an HTTP endpoint that we can use to grab a greeting. In your <a href="https://github.com/dsyer/spring-security-angular/blob/master/basic/src/main/java/demo/UiApplication.java">application class</a> (in "src/main/java/demo"), add the <code>@RestController</code> annotation and define a new <code>@RequestMapping</code>:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
public class UiApplication {

  @RequestMapping(&quot;/resource&quot;)
  public Map&lt;String,Object&gt; home() {
    Map&lt;String,Object&gt; model = new HashMap&lt;String,Object&gt;();
    model.put(&quot;id&quot;, UUID.randomUUID().toString());
    model.put(&quot;content&quot;, &quot;Hello World&quot;);
    return model;
  }

  public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">"/resource"</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> home</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> model </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="typ">Object</span><span class="pun">&gt;();</span><span class="pln">
    model</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"id"</span><span class="pun">,</span><span class="pln"> UUID</span><span class="pun">.</span><span class="pln">randomUUID</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">());</span><span class="pln">
    model</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"content"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hello World"</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> model</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">UiApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> Depending on the way you created your new project it might not be called <code>UiApplication</code>, and it might have <code>@EnableAutoConfiguration @ComponentScan @Configuration</code> instead of <code>@SpringBootApplication</code>. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>Run that application and try to curl the "/resource" endpoint and you will find that it is secure by default:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl localhost:8080/resource
{&quot;timestamp&quot;:1420442772928,&quot;status&quot;:401,&quot;error&quot;:&quot;Unauthorized&quot;,&quot;message&quot;:&quot;Full authentication is required to access this resource&quot;,&quot;path&quot;:&quot;/resource&quot;}"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl localhost</span><span class="pun">:</span><span class="lit">8080</span><span class="pun">/</span><span class="pln">resource
</span><span class="pun">{</span><span class="str">"timestamp"</span><span class="pun">:</span><span class="lit">1420442772928</span><span class="pun">,</span><span class="str">"status"</span><span class="pun">:</span><span class="lit">401</span><span class="pun">,</span><span class="str">"error"</span><span class="pun">:</span><span class="str">"Unauthorized"</span><span class="pun">,</span><span class="str">"message"</span><span class="pun">:</span><span class="str">"Full authentication is required to access this resource"</span><span class="pun">,</span><span class="str">"path"</span><span class="pun">:</span><span class="str">"/resource"</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_loading_a_dynamic_resource_from_angular">Loading a Dynamic Resource from Angular</h4>
<div class="paragraph">
<p>So letâs grab that message in the browser. Modify the "home" controller to load the protected resource using XHR:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [])
  .controller(&#39;home&#39;, function($scope, $http) {
  $http.get(&#39;/resource/&#39;).success(function(data) {
    $scope.greeting = data;
  })
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[])</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/resource/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">})</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We injected an <a href="https://docs.angularjs.org/api/ng/service/$http"><code>$http</code> service</a>, which is provided by Angular as a core feature, and used it to GET our resource. Angular passes us the JSON from the response body back to a callback function on success.</p>
</div>
<div class="paragraph">
<p>Run the application again (or just reload the home page in the browser), and you will see the dynamic message with its unique ID. So, even though the resource is protected and you canât curl it directly, the browser was able to access the content. We have a secure single page application in less than a hundred lines of code!</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> You might need to force your browser to reload the static resources after you change them. In Chrome (and Firefox with a plugin) you can use "developer tools" (F12), and that might be enough. Or you might have to use CTRL+F5. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="how-does-it-work">How Does it Work?</h3>
<div class="paragraph">
<p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, may require a plugin in Firefox). Hereâs a summary:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verb</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browser prompts for authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index.html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/css/angular-bootstrap.css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Twitter bootstrap CSS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/angular-bootstrap.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap and Angular JS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/hello.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON greeting</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You might not see the 401 because the browser treats the home page load as a single interaction, and you might see 2 requests for "/resource" because there is a <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> negotiation.</p>
</div>
<div class="paragraph">
<p>Look more closely at the requests and you will see that all of them have an "Authorization" header, something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="Authorization: Basic dXNlcjpwYXNzd29yZA=="></button><pre class="prettyprint highlight prettyprinted"><code><span class="typ">Authorization</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Basic</span><span class="pln"> dXNlcjpwYXNzd29yZA</span><span class="pun">==</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The browser is sending the username and password with every request (so remember to use HTTPS exclusively in production). Thereâs nothing "Angular" about that, so it works with your JavaScript framework or non-framework of choice.</p>
</div>
<div class="sect3">
<h4 id="_what_s_wrong_with_that">Whatâs Wrong with That?</h4>
<div class="paragraph">
<p>On the face of it, it seems like we did a pretty good job, itâs concise, easy to implement, all our data are secured by a secret password, and it would still work if we changed the front end or backend technologies. But there are some issues.</p>
</div>
<div class="ulist">
<ul>
<li> <p>Basic authentication is restricted to username and password authentication.</p> </li>
<li> <p>The authentication UI is ubiquitous but ugly (browser dialog).</p> </li>
<li> <p>There is no protection from <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">Cross Site Request Forgery</a> (CSRF).</p> </li>
</ul>
</div>
<div class="paragraph">
<p>CSRF isnât really an issue with our application as it stands since it only needs to GET the backend resources (i.e. no state is changed in the server). As soon as you have a POST, PUT or DELETE in your application it simply isnât secure any more by any reasonable modern measure.</p>
</div>
<div class="paragraph">
<p>In the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">next section in this series</a> we will extend the application to use form-based authentication, which is a lot more flexible than HTTP Basic. Once we have a form we will need CSRF protection, and both Spring Security and Angular have some nice out-of-the box features to help with this. Spoiler: we are going to need to use the <code>HttpSession</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Thanks: I would like to thank everyone who helped me develop this series, and in particular <a href="http://spring.io/team/rwinch">Rob Winch</a> and <a href="https://twitter.com/thspaeth">Thorsten Spaeth</a> for their careful reviews of the sections and sources codes, and for teaching me a few tricks I didnât know even about the parts I thought I was most familar with.</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_login_page_angular_js_and_spring_security_part_ii">The Login Page</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we show how to use Angular JS to authenticate a user via a form and fetch a secure resource to render in the UI. This is the second in a series of sections, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/single">source code in Github</a>. In the first section we built a simple application that used HTTP Basic authentication to protect the backend resources. In this one we add a login form, give the user some control over whether to authenticate or not, and fix the issues with the first iteration (principally lack of CSRF protection).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: if you are working through this section with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_add_navigation_to_the_home_page">Add Navigation to the Home Page</h3>
<div class="paragraph">
<p>The core of a single page application is a static "index.html". We already had a really basic one, but for this application we need to offer some navigation features (login, logout, home), so letâs modify it (in "src/main/resources/static"):</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Hello AngularJS&lt;/title&gt;
&lt;link
	href=&quot;css/angular-bootstrap.css&quot;
	rel=&quot;stylesheet&quot;&gt;
&lt;style type=&quot;text/css&quot;&gt;
[ng\:cloak], [ng-cloak], .ng-cloak {
	display: none !important;
}
&lt;/style&gt;
&lt;/head&gt;

&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
	&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
		&lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
			&lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;#/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
			&lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
			&lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;div ng-view class=&quot;container&quot;&gt;&lt;/div&gt;
	&lt;script src=&quot;js/angular-bootstrap.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
	&lt;script src=&quot;js/hello.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="dec">&lt;!doctype html&gt;</span><span class="pln">
</span><span class="tag">&lt;html&gt;</span><span class="pln">
</span><span class="tag">&lt;head&gt;</span><span class="pln">
</span><span class="tag">&lt;title&gt;</span><span class="pln">Hello AngularJS</span><span class="tag">&lt;/title&gt;</span><span class="pln">
</span><span class="tag">&lt;link</span><span class="pln">
	</span><span class="atn">href</span><span class="pun">=</span><span class="atv">"css/angular-bootstrap.css"</span><span class="pln">
	</span><span class="atn">rel</span><span class="pun">=</span><span class="atv">"stylesheet"</span><span class="tag">&gt;</span><span class="pln">
</span><span class="tag">&lt;style</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/css"</span><span class="tag">&gt;</span><span class="pln">
</span><span class="pun">[</span><span class="pln">ng\:cloak</span><span class="pun">],</span><span class="pln"> </span><span class="pun">[</span><span class="pln">ng</span><span class="pun">-</span><span class="pln">cloak</span><span class="pun">],</span><span class="pln"> </span><span class="pun">.</span><span class="pln">ng</span><span class="pun">-</span><span class="pln">cloak </span><span class="pun">{</span><span class="pln">
	display</span><span class="pun">:</span><span class="pln"> none </span><span class="pun">!</span><span class="pln">important</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span><span class="pln">
</span><span class="tag">&lt;/head&gt;</span><span class="pln">

</span><span class="tag">&lt;body</span><span class="pln"> </span><span class="atn">ng-app</span><span class="pun">=</span><span class="atv">"hello"</span><span class="pln"> </span><span class="atn">ng-cloak</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"ng-cloak"</span><span class="tag">&gt;</span><span class="pln">
	</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"navigation"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
		</span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"nav nav-pills"</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"tablist"</span><span class="tag">&gt;</span><span class="pln">
			</span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"active"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#/"</span><span class="tag">&gt;</span><span class="pln">home</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
			</span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#/login"</span><span class="tag">&gt;</span><span class="pln">login</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
			</span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">""</span><span class="pln"> </span><span class="atn">ng-click</span><span class="pun">=</span><span class="atv">"logout()"</span><span class="tag">&gt;</span><span class="pln">logout</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
		</span><span class="tag">&lt;/ul&gt;</span><span class="pln">
	</span><span class="tag">&lt;/div&gt;</span><span class="pln">
	</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-view</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;&lt;/div&gt;</span><span class="pln">
	</span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"js/angular-bootstrap.js"</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/javascript"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln">
	</span><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"js/hello.js"</span><span class="tag">&gt;&lt;/script&gt;</span><span class="pln">
</span><span class="tag">&lt;/body&gt;</span><span class="pln">
</span><span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Itâs not much different than the original in fact. Salient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>There is a <code>&lt;ul&gt;</code> for the navigation bar. All the links come straight back to the home page, but in a way that Angular will recognize once we get it set up with "routes".</p> </li>
<li> <p>All the content is going to be added as "partials" in the <code>&lt;div&gt;</code> labelled "ng-view".</p> </li>
<li> <p>The "ng-cloak" has been moved up to the body because we want to hide the whole page until Angular can work out which bits to render. Otherwise the menus and content can "flicker" as they are moved around when the page loads.</p> </li>
<li> <p>As in the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, the front end assets "angular-bootstrap.css" and "angular-bootstrap.js" are generated from JAR libraries at build time.</p> </li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_add_navigation_to_the_angular_application">Add Navigation to the Angular Application</h3>
<div class="paragraph">
<p>Letâs modify the "hello" application (in "src/main/resources/public/js/hello.js") to add some navigation features. We can start by adding some configuration for routes, so that the links in the home page actually do something. E.g.</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
  .config(function($routeProvider, $httpProvider) {

	$routeProvider.when(&#39;/&#39;, {
		templateUrl : &#39;home.html&#39;,
		controller : &#39;home&#39;
	}).when(&#39;/login&#39;, {
		templateUrl : &#39;login.html&#39;,
		controller : &#39;navigation&#39;
	}).otherwise(&#39;/&#39;);

    $httpProvider.defaults.headers.common[&quot;X-Requested-With&quot;] = &#39;XMLHttpRequest&#39;;

  })
  .controller(&#39;home&#39;, function($scope, $http) {
    $http.get(&#39;/resource/&#39;).success(function(data) {
      $scope.greeting = data;
    })
  })
  .controller(&#39;navigation&#39;, function() {});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">config</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$routeProvider</span><span class="pun">,</span><span class="pln"> $httpProvider</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

	$routeProvider</span><span class="pun">.</span><span class="pln">when</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		templateUrl </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home.html'</span><span class="pun">,</span><span class="pln">
		controller </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home'</span><span class="pln">
	</span><span class="pun">}).</span><span class="pln">when</span><span class="pun">(</span><span class="str">'/login'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		templateUrl </span><span class="pun">:</span><span class="pln"> </span><span class="str">'login.html'</span><span class="pun">,</span><span class="pln">
		controller </span><span class="pun">:</span><span class="pln"> </span><span class="str">'navigation'</span><span class="pln">
	</span><span class="pun">}).</span><span class="pln">otherwise</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">);</span><span class="pln">

    $httpProvider</span><span class="pun">.</span><span class="pln">defaults</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">.</span><span class="pln">common</span><span class="pun">[</span><span class="str">"X-Requested-With"</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'XMLHttpRequest'</span><span class="pun">;</span><span class="pln">

  </span><span class="pun">})</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/resource/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">})</span><span class="pln">
  </span><span class="pun">})</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We added a dependency on an Angular module called <a href="https://docs.angularjs.org/api/ngRoute">"ngRoute"</a> and this allowed us to inject a magic <code>$routeProvider</code> into the config function (Angular does dependency injection by naming convention, and recognizes the names of your function parameters). The <code>$routeProvider</code> is then used inside the function to set up links to "/" (the "home" controller) and "/login" (the "login" controller). The "templateUrls" are relative paths from the root of the routes (i.e. "/") to "partial" views that will be used to render the model created by each controller.</p>
</div>
<div class="paragraph">
<p>The custom "X-Requested-With" is a conventional header sent by browser clients, and it used to be the default in Angular but they <a href="https://github.com/angular/angular.js/issues/1004">took it out in 1.3.0</a>. Spring Security responds to it by not sending a "WWW-Authenticate" header in a 401 response, and thus the browser will not pop up an authentication dialog (which is desirable in our app since we want to control the authentication).</p>
</div>
<div class="paragraph">
<p>In order to use the "ngRoute" module, we need to add a line to the "wro.xml" configuration that builds the static assets (in "src/main/wro"):</p>
</div>
<div class="listingblock">
<div class="title">
wro.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;groups xmlns=&quot;http://www.isdc.ro/wro&quot;&gt;
  &lt;group name=&quot;angular-bootstrap&quot;&gt;
    ...
    &lt;js&gt;webjar:angularjs/1.3.8/angular-route.min.js&lt;/js&gt;
   &lt;/group&gt;
&lt;/groups&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;groups</span><span class="pln"> </span><span class="atn">xmlns</span><span class="pun">=</span><span class="atv">"http://www.isdc.ro/wro"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;group</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"angular-bootstrap"</span><span class="tag">&gt;</span><span class="pln">
    ...
    </span><span class="tag">&lt;js&gt;</span><span class="pln">webjar:angularjs/1.3.8/angular-route.min.js</span><span class="tag">&lt;/js&gt;</span><span class="pln">
   </span><span class="tag">&lt;/group&gt;</span><span class="pln">
</span><span class="tag">&lt;/groups&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_the_greeting">The Greeting</h4>
<div class="paragraph">
<p>The greeting content from the old home page can go in "home.html" (right next to the "index.html" in "src/main/resources/static"):</p>
</div>
<div class="listingblock">
<div class="title">
home.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;h1&gt;Greeting&lt;/h1&gt;
&lt;div ng-show=&quot;authenticated&quot;&gt;
	&lt;p&gt;The ID is {{greeting.id}}&lt;/p&gt;
	&lt;p&gt;The content is {{greeting.content}}&lt;/p&gt;
&lt;/div&gt;
&lt;div  ng-show=&quot;!authenticated&quot;&gt;
	&lt;p&gt;Login to see your greeting&lt;/p&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;h1&gt;</span><span class="pln">Greeting</span><span class="tag">&lt;/h1&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="tag">&gt;</span><span class="pln">
	</span><span class="tag">&lt;p&gt;</span><span class="pln">The ID is {{greeting.id}}</span><span class="tag">&lt;/p&gt;</span><span class="pln">
	</span><span class="tag">&lt;p&gt;</span><span class="pln">The content is {{greeting.content}}</span><span class="tag">&lt;/p&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln">  </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"!authenticated"</span><span class="tag">&gt;</span><span class="pln">
	</span><span class="tag">&lt;p&gt;</span><span class="pln">Login to see your greeting</span><span class="tag">&lt;/p&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the user now has the choice whether to login or not (before it was all controlled by the browser), we need to distinguish in the UI between content that is secure and that which is not. We have anticipated this by adding references to an (as yet non-existent) <code>authenticated</code> variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_login_form">The Login Form</h4>
<div class="paragraph">
<p>The login form goes in "login.html":</p>
</div>
<div class="listingblock">
<div class="title">
login.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div class=&quot;alert alert-danger&quot; ng-show=&quot;error&quot;&gt;
	There was a problem logging in. Please try again.
&lt;/div&gt;
&lt;form role=&quot;form&quot; ng-submit=&quot;login()&quot;&gt;
	&lt;div class=&quot;form-group&quot;&gt;
		&lt;label for=&quot;username&quot;&gt;Username:&lt;/label&gt; &lt;input type=&quot;text&quot;
			class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; ng-model=&quot;credentials.username&quot;/&gt;
	&lt;/div&gt;
	&lt;div class=&quot;form-group&quot;&gt;
		&lt;label for=&quot;password&quot;&gt;Password:&lt;/label&gt; &lt;input type=&quot;password&quot;
			class=&quot;form-control&quot; id=&quot;password&quot; name=&quot;password&quot; ng-model=&quot;credentials.password&quot;/&gt;
	&lt;/div&gt;
	&lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Submit&lt;/button&gt;
&lt;/form&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"alert alert-danger"</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"error"</span><span class="tag">&gt;</span><span class="pln">
	There was a problem logging in. Please try again.
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"form"</span><span class="pln"> </span><span class="atn">ng-submit</span><span class="pun">=</span><span class="atv">"login()"</span><span class="tag">&gt;</span><span class="pln">
	</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-group"</span><span class="tag">&gt;</span><span class="pln">
		</span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">"username"</span><span class="tag">&gt;</span><span class="pln">Username:</span><span class="tag">&lt;/label&gt;</span><span class="pln"> </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text"</span><span class="pln">
			</span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-control"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"username"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"username"</span><span class="pln"> </span><span class="atn">ng-model</span><span class="pun">=</span><span class="atv">"credentials.username"</span><span class="tag">/&gt;</span><span class="pln">
	</span><span class="tag">&lt;/div&gt;</span><span class="pln">
	</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-group"</span><span class="tag">&gt;</span><span class="pln">
		</span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">"password"</span><span class="tag">&gt;</span><span class="pln">Password:</span><span class="tag">&lt;/label&gt;</span><span class="pln"> </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln">
			</span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-control"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln"> </span><span class="atn">ng-model</span><span class="pun">=</span><span class="atv">"credentials.password"</span><span class="tag">/&gt;</span><span class="pln">
	</span><span class="tag">&lt;/div&gt;</span><span class="pln">
	</span><span class="tag">&lt;button</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"btn btn-primary"</span><span class="tag">&gt;</span><span class="pln">Submit</span><span class="tag">&lt;/button&gt;</span><span class="pln">
</span><span class="tag">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very standard login form, with 2 inputs for username and password and a button for submitting the form via <a href="https://docs.angularjs.org/api/ng/directive/ngSubmit"><code>ng-submit</code></a>. You donât need an action on the form tag, so itâs probably better not to put one in at all. There is also an error message, shown only if the angular <code>$scope</code> contains an <code>error</code>. The form controls use <a href="https://docs.angularjs.org/api/ng/directive/ngModel"><code>ng-model</code></a> to pass data between the HTML and the Angular controller, and in this case we are using a <code>credentials</code> object to hold the username and pasword. According to the routes we defined the login form is linked with the "navigation" controller, which is so far empty, so letâs head over to that to fill in some gaps.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_authentication_process">The Authentication Process</h3>
<div class="paragraph">
<p>To support the login form we just added we need to add some more features. On the client side these will be implemented in the "navigation" controller, and on the server it will be Spring Security configuration.</p>
</div>
<div class="sect3">
<h4 id="_submitting_the_login_form">Submitting the Login Form</h4>
<div class="paragraph">
<p>To submit the form we need to define the <code>login()</code> function that we referenced already in the form via <code>ng-submit</code>, and the <code>credentials</code> object that we referenced via <code>ng-model</code>. Letâs flesh out the "navigation" controller in "hello.js" (omitting the routes config and the "home" controller):</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]) // ... omitted code
.controller(&#39;navigation&#39;,

  function($rootScope, $scope, $http, $location) {

  var authenticate = function(credentials, callback) {

    var headers = credentials ? {authorization : &quot;Basic &quot;
        + btoa(credentials.username + &quot;:&quot; + credentials.password)
    } : {};

    $http.get(&#39;user&#39;, {headers : headers}).success(function(data) {
      if (data.name) {
        $rootScope.authenticated = true;
      } else {
        $rootScope.authenticated = false;
      }
      callback &amp;&amp; callback();
    }).error(function() {
      $rootScope.authenticated = false;
      callback &amp;&amp; callback();
    });

  }

  authenticate();
  $scope.credentials = {};
  $scope.login = function() {
      authenticate($scope.credentials, function() {
        if ($rootScope.authenticated) {
          $location.path(&quot;/&quot;);
          $scope.error = false;
        } else {
          $location.path(&quot;/login&quot;);
          $scope.error = true;
        }
      });
  };
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln"> </span><span class="com">// ... omitted code</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln">

  </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$rootScope</span><span class="pun">,</span><span class="pln"> $scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">,</span><span class="pln"> $location</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> authenticate </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> headers </span><span class="pun">=</span><span class="pln"> credentials </span><span class="pun">?</span><span class="pln"> </span><span class="pun">{</span><span class="pln">authorization </span><span class="pun">:</span><span class="pln"> </span><span class="str">"Basic "</span><span class="pln">
        </span><span class="pun">+</span><span class="pln"> btoa</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">.</span><span class="pln">username </span><span class="pun">+</span><span class="pln"> </span><span class="str">":"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> credentials</span><span class="pun">.</span><span class="pln">password</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">

    $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">headers </span><span class="pun">:</span><span class="pln"> headers</span><span class="pun">}).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="pln">name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
      </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
      </span><span class="pun">}</span><span class="pln">
      callback </span><span class="pun">&amp;&amp;</span><span class="pln"> callback</span><span class="pun">();</span><span class="pln">
    </span><span class="pun">}).</span><span class="pln">error</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
      callback </span><span class="pun">&amp;&amp;</span><span class="pln"> callback</span><span class="pun">();</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">

  </span><span class="pun">}</span><span class="pln">

  authenticate</span><span class="pun">();</span><span class="pln">
  $scope</span><span class="pun">.</span><span class="pln">credentials </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">
  $scope</span><span class="pun">.</span><span class="pln">login </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      authenticate</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">.</span><span class="pln">credentials</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$rootScope</span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
          $location</span><span class="pun">.</span><span class="pln">path</span><span class="pun">(</span><span class="str">"/"</span><span class="pun">);</span><span class="pln">
          $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
          $location</span><span class="pun">.</span><span class="pln">path</span><span class="pun">(</span><span class="str">"/login"</span><span class="pun">);</span><span class="pln">
          $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
      </span><span class="pun">});</span><span class="pln">
  </span><span class="pun">};</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the code in the "navigation" controller will be executed when the page loads because the <code>&lt;div&gt;</code> containing the menu bar is visible and is decorated with <code>ng-controller="navigation"</code>. In addition to initializing the <code>credentials</code> object, it defines 2 functions, the <code>login()</code> that we need in the form, and a local helper function <code>authenticate()</code> which tries to load a "user" resource from the backend. The <code>authenticate()</code> function is called when the controller is loaded to see if the user is actually already authenticated (e.g. if he had refreshed the browser in the middle of a session). We need the <code>authenticate()</code> function to make a remote call because the actual authentication is done by the server, and we donât want to trust the browser to keep track of it.</p>
</div>
<div class="paragraph">
<p>The <code>authenticate()</code> function sets an application-wide flag called <code>authenticated</code> which we have already used in our "home.html" to control which parts of the page are rendered. We do this using <a href="https://docs.angularjs.org/api/ng/service/$rootScope"><code>$rootScope</code></a> because itâs convenient and easy to follow, and we need to share the <code>authenticated</code> flag between the "navigation" and the "home" controllers. Angular experts might prefer to share data through a shared user-defined service (but it ends up being the same mechanism).</p>
</div>
<div class="paragraph">
<p>The <code>authenticate()</code> makes a GET to a relative resource (relative to the deployment root of your application) "/user". When called from the <code>login()</code> function it adds the Base64-encoded credentials in the headers so on the server it does an authentication and accepts a cookie in return. The <code>login()</code> function also sets a local <code>$scope.error</code> flag accordingly when we get the result of the authentication, which is used to control the display of the error message above the login form.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_currently_authenticated_user">The Currently Authenticated User</h4>
<div class="paragraph">
<p>To service the <code>authenticate()</code> function we need to add a new endpoint to the backend:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
public class UiApplication {

  @RequestMapping(&quot;/user&quot;)
  public Principal user(Principal user) {
    return user;
  }

  ...

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">"/user"</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Principal</span><span class="pln"> user</span><span class="pun">(</span><span class="typ">Principal</span><span class="pln"> user</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> user</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a useful trick in a Spring Security application. If the "/user" resource is reachable then it will return the currently authenticated user (an <a href="https://github.com/spring-projects/spring-security/blob/master/core/src/main/java/org/springframework/security/core/Authentication.java"><code>Authentication</code></a>), and otherwise Spring Security will intercept the request and send a 401 response through an <a href="https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/AuthenticationEntryPoint.java"><code>AuthenticationEntryPoint</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_the_login_request_on_the_server">Handling the Login Request on the Server</h4>
<div class="paragraph">
<p>Spring Security makes it easy to handle the login request. We just need to add some configuration to our <a href="https://github.com/dsyer/spring-security-angular/blob/master/single/src/main/java/demo/UiApplication.java">main application class</a> (e.g. as an inner class):</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
public class UiApplication {

  ...

  @Configuration
  @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
  protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
      http
        .httpBasic()
      .and()
        .authorizeRequests()
          .antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/login.html&quot;, &quot;/&quot;).permitAll()
          .anyRequest().authenticated();
    }
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

  </span><span class="lit">@Configuration</span><span class="pln">
  </span><span class="lit">@Order</span><span class="pun">(</span><span class="typ">SecurityProperties</span><span class="pun">.</span><span class="pln">ACCESS_OVERRIDE_ORDER</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="lit">@Override</span><span class="pln">
    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      http
        </span><span class="pun">.</span><span class="pln">httpBasic</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">authorizeRequests</span><span class="pun">()</span><span class="pln">
          </span><span class="pun">.</span><span class="pln">antMatchers</span><span class="pun">(</span><span class="str">"/index.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/home.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/login.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">).</span><span class="pln">permitAll</span><span class="pun">()</span><span class="pln">
          </span><span class="pun">.</span><span class="pln">anyRequest</span><span class="pun">().</span><span class="pln">authenticated</span><span class="pun">();</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a standard Spring Boot application with Spring Security customization, just allowing anonymous access to the static (HTML) resources (the CSS and JS resources are already accessible by default). The HTML resources need to be available to anonymous users, not just ignored by Spring Security, for reasons that will become clear.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logout">Logout</h3>
<div class="paragraph">
<p>The application is almost finished functionally. The last thing we need to do is implement the logout feature that we sketched in the home page. Hereâs a reminder what the navigation bar looks like:</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;#/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    &lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"navigation"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"nav nav-pills"</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"tablist"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"active"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#/"</span><span class="tag">&gt;</span><span class="pln">home</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#/login"</span><span class="tag">&gt;</span><span class="pln">login</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">""</span><span class="pln"> </span><span class="atn">ng-click</span><span class="pun">=</span><span class="atv">"logout()"</span><span class="tag">&gt;</span><span class="pln">logout</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
  </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the user is authenticated then we show a "logout" link and hook it to a <code>logout()</code> function in the "navigation" controller. The implementation of the function is relatively simple:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]).
// ...
.controller(&#39;navigation&#39;, function(...) {

...

$scope.logout = function() {
  $http.post(&#39;logout&#39;, {}).success(function() {
    $rootScope.authenticated = false;
    $location.path(&quot;/&quot;);
  }).error(function(data) {
    $rootScope.authenticated = false;
  });
}

...

});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">]).</span><span class="pln">
</span><span class="com">// ...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(...)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

</span><span class="pun">...</span><span class="pln">

$scope</span><span class="pun">.</span><span class="pln">logout </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  $http</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'logout'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{}).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    $location</span><span class="pun">.</span><span class="pln">path</span><span class="pun">(</span><span class="str">"/"</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}).</span><span class="pln">error</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="pun">...</span><span class="pln">

</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It sends an HTTP POST to "/logout" which we now need to implement on the server. This is straightforward because it is added for us already by Spring Security (i.e. we donât need to do anything for this simple use case). For more control over the behaviour of logout you could use the <code>HttpSecurity</code> callbacks in your <code>WebSecurityAdapter</code> to, for instance execute some business logic after logout.</p>
</div>
</div>
<div class="sect2">
<h3 id="_csrf_protection">CSRF Protection</h3>
<div class="paragraph">
<p>The application is almost ready to use, and in fact if you run it you will find that everything we built so far actually works except the logout link. Try using it annd look at the responses in the browser and you will see why:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="POST /logout HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded

username=user&amp;password=password

HTTP/1.1 403 Forbidden
Set-Cookie: JSESSIONID=3941352C51ABB941781E1DF312DA474E; Path=/; HttpOnly
Content-Type: application/json;charset=UTF-8
Transfer-Encoding: chunked
...

{&quot;timestamp&quot;:1420467113764,&quot;status&quot;:403,&quot;error&quot;:&quot;Forbidden&quot;,&quot;message&quot;:&quot;Expected CSRF token not found. Has your session expired?&quot;,&quot;path&quot;:&quot;/login&quot;}"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">POST </span><span class="pun">/</span><span class="pln">logout HTTP</span><span class="pun">/</span><span class="lit">1.1</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="typ">Content</span><span class="pun">-</span><span class="typ">Type</span><span class="pun">:</span><span class="pln"> application</span><span class="pun">/</span><span class="pln">x</span><span class="pun">-</span><span class="pln">www</span><span class="pun">-</span><span class="pln">form</span><span class="pun">-</span><span class="pln">urlencoded

username</span><span class="pun">=</span><span class="pln">user</span><span class="pun">&amp;</span><span class="pln">password</span><span class="pun">=</span><span class="pln">password

HTTP</span><span class="pun">/</span><span class="lit">1.1</span><span class="pln"> </span><span class="lit">403</span><span class="pln"> </span><span class="typ">Forbidden</span><span class="pln">
</span><span class="typ">Set</span><span class="pun">-</span><span class="typ">Cookie</span><span class="pun">:</span><span class="pln"> JSESSIONID</span><span class="pun">=</span><span class="lit">3941352C51ABB941781E1DF312DA474E</span><span class="pun">;</span><span class="pln"> </span><span class="typ">Path</span><span class="pun">=/;</span><span class="pln"> </span><span class="typ">HttpOnly</span><span class="pln">
</span><span class="typ">Content</span><span class="pun">-</span><span class="typ">Type</span><span class="pun">:</span><span class="pln"> application</span><span class="pun">/</span><span class="pln">json</span><span class="pun">;</span><span class="pln">charset</span><span class="pun">=</span><span class="pln">UTF</span><span class="pun">-</span><span class="lit">8</span><span class="pln">
</span><span class="typ">Transfer</span><span class="pun">-</span><span class="typ">Encoding</span><span class="pun">:</span><span class="pln"> chunked
</span><span class="pun">...</span><span class="pln">

</span><span class="pun">{</span><span class="str">"timestamp"</span><span class="pun">:</span><span class="lit">1420467113764</span><span class="pun">,</span><span class="str">"status"</span><span class="pun">:</span><span class="lit">403</span><span class="pun">,</span><span class="str">"error"</span><span class="pun">:</span><span class="str">"Forbidden"</span><span class="pun">,</span><span class="str">"message"</span><span class="pun">:</span><span class="str">"Expected CSRF token not found. Has your session expired?"</span><span class="pun">,</span><span class="str">"path"</span><span class="pun">:</span><span class="str">"/login"</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Thatâs good because it means that Spring Securityâs built-in CSRF protection has kicked in to prevent us from shooting ourselves in the foot. All it wants is a token sent to it in a header called "X-CSRF". The value of the CSRF token was available server side in the <code>HttpRequest</code> attributes from the initial request that loaded the home page. To get it to the client we could render it using a dynamic HTML page on the server, or expose it via a custom endpoint, or else we could send it as a cookie. The last choice is the best because Angular has <a href="https://docs.angularjs.org/api/ng/service/$http">built in support for CSRF</a> (which it calls "XSRF") based on cookies.</p>
</div>
<div class="paragraph">
<p>So on the server we need a custom filter that will send the cookie. Angular wants the cookie name to be "XSRF-TOKEN" and Spring Security provides it as a request attribute, so we just need to transfer the value from a request attribute to a cookie:</p>
</div>
<div class="listingblock">
<div class="title">
CsrfHeaderFilter.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="public class CsrfHeaderFilter extends OncePerRequestFilter {
  @Override
  protected void doFilterInternal(HttpServletRequest request,
      HttpServletResponse response, FilterChain filterChain)
      throws ServletException, IOException {
    CsrfToken csrf = (CsrfToken) request.getAttribute(CsrfToken.class
        .getName());
    if (csrf != null) {
      Cookie cookie = WebUtils.getCookie(request, &quot;XSRF-TOKEN&quot;);
      String token = csrf.getToken();
      if (cookie==null || token!=null &amp;&amp; !token.equals(cookie.getValue())) {
        cookie = new Cookie(&quot;XSRF-TOKEN&quot;, token);
        cookie.setPath(&quot;/&quot;);
        response.addCookie(cookie);
      }
    }
    filterChain.doFilter(request, response);
  }
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">CsrfHeaderFilter</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">OncePerRequestFilter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> doFilterInternal</span><span class="pun">(</span><span class="typ">HttpServletRequest</span><span class="pln"> request</span><span class="pun">,</span><span class="pln">
      </span><span class="typ">HttpServletResponse</span><span class="pln"> response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">FilterChain</span><span class="pln"> filterChain</span><span class="pun">)</span><span class="pln">
      </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">ServletException</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IOException</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">CsrfToken</span><span class="pln"> csrf </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">CsrfToken</span><span class="pun">)</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getAttribute</span><span class="pun">(</span><span class="typ">CsrfToken</span><span class="pun">.</span><span class="kwd">class</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">getName</span><span class="pun">());</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">csrf </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="typ">Cookie</span><span class="pln"> cookie </span><span class="pun">=</span><span class="pln"> </span><span class="typ">WebUtils</span><span class="pun">.</span><span class="pln">getCookie</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> </span><span class="str">"XSRF-TOKEN"</span><span class="pun">);</span><span class="pln">
      </span><span class="typ">String</span><span class="pln"> token </span><span class="pun">=</span><span class="pln"> csrf</span><span class="pun">.</span><span class="pln">getToken</span><span class="pun">();</span><span class="pln">
      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">cookie</span><span class="pun">==</span><span class="kwd">null</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> token</span><span class="pun">!=</span><span class="kwd">null</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln">token</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="pln">cookie</span><span class="pun">.</span><span class="pln">getValue</span><span class="pun">()))</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        cookie </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Cookie</span><span class="pun">(</span><span class="str">"XSRF-TOKEN"</span><span class="pun">,</span><span class="pln"> token</span><span class="pun">);</span><span class="pln">
        cookie</span><span class="pun">.</span><span class="pln">setPath</span><span class="pun">(</span><span class="str">"/"</span><span class="pun">);</span><span class="pln">
        response</span><span class="pun">.</span><span class="pln">addCookie</span><span class="pun">(</span><span class="pln">cookie</span><span class="pun">);</span><span class="pln">
      </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    filterChain</span><span class="pun">.</span><span class="pln">doFilter</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To finish the job and make it completely generic we should be careful to set the cookie path to the context path of the application (instead of hard-coded to "/"), but this is good enough for the application we are working on.</p>
</div>
<div class="paragraph">
<p>We need to install this filter in the application somewhere, and it needs to go after the Spring Security <code>CsrfFilter</code> so that the request attribute is available. Since we have Spring Security protecting these resources thereâs no better place than in the Spring Security filter chain, e.g. extending the <code>SecurityConfiguration</code> above:</p>
</div>
<div class="listingblock">
<div class="title">
SecurityConfiguration.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Configuration
@Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {
  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http
      .httpBasic().and()
      .authorizeRequests()
        .antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/login.html&quot;, &quot;/&quot;).permitAll().anyRequest()
        .authenticated().and()
      .addFilterAfter(new CsrfHeaderFilter(), CsrfFilter.class);
  }
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Configuration</span><span class="pln">
</span><span class="lit">@Order</span><span class="pun">(</span><span class="typ">SecurityProperties</span><span class="pun">.</span><span class="pln">ACCESS_OVERRIDE_ORDER</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    http
      </span><span class="pun">.</span><span class="pln">httpBasic</span><span class="pun">().</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">authorizeRequests</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">antMatchers</span><span class="pun">(</span><span class="str">"/index.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/home.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/login.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">).</span><span class="pln">permitAll</span><span class="pun">().</span><span class="pln">anyRequest</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">().</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">addFilterAfter</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">CsrfHeaderFilter</span><span class="pun">(),</span><span class="pln"> </span><span class="typ">CsrfFilter</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The other thing we have to do on the server is tell Spring Security to expect the CSRF token in the format that Angular wants to send it back (a header called "X-XRSF-TOKEN" instead of the default "X-CSRF-TOKEN"). We do this by customizing the CSRF filter:</p>
</div>
<div class="listingblock">
<div class="title">
SecurityConfiguration.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Override
protected void configure(HttpSecurity http) throws Exception {
  http
    .httpBasic().and()
    ...
    .csrf().csrfTokenRepository(csrfTokenRepository());
}

private CsrfTokenRepository csrfTokenRepository() {
  HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();
  repository.setHeaderName(&quot;X-XSRF-TOKEN&quot;);
  return repository;
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Override</span><span class="pln">
</span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  http
    </span><span class="pun">.</span><span class="pln">httpBasic</span><span class="pun">().</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
    </span><span class="pun">.</span><span class="pln">csrf</span><span class="pun">().</span><span class="pln">csrfTokenRepository</span><span class="pun">(</span><span class="pln">csrfTokenRepository</span><span class="pun">());</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">private</span><span class="pln"> </span><span class="typ">CsrfTokenRepository</span><span class="pln"> csrfTokenRepository</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="typ">HttpSessionCsrfTokenRepository</span><span class="pln"> repository </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HttpSessionCsrfTokenRepository</span><span class="pun">();</span><span class="pln">
  repository</span><span class="pun">.</span><span class="pln">setHeaderName</span><span class="pun">(</span><span class="str">"X-XSRF-TOKEN"</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> repository</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With those changes in place we donât need to do anything on the client side and the login form is now working.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_it_work">How Does it Work?</h3>
<div class="paragraph">
<p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, may require a plugin in Firefox). Hereâs a summary:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verb</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index.html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/css/angular-bootstrap.css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Twitter bootstrap CSS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/angular-bootstrap.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap and Angular JS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/hello.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/home.html</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Home page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login.html</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Angular login form partial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send credentials and get JSON</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON greeting</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The responses that are marked "ignored" above are HTML responses received by Angular in an XHR call, and since we arenât processing that data the HTML is dropped on the floor. We do look for an authenticated user in the case of the "/user" resource, but since it isnât there in the first call, that response is dropped.</p>
</div>
<div class="paragraph">
<p>Look more closely at the requests and you will see that they all have cookies. If you start with a clean browser (e.g. incognito in Chrome), the very first request has no cookies going off to the server, but the server sends back "Set-Cookie" for "JSESSIONID" (the regular <code>HttpSession</code>) and "X-XSRF-TOKEN" (the CRSF cookie that we set up above). Subsequent requests all have those cookies, and they are important: the application doesnât work without them, and they are providing some really basic security features (authentication and CSRF protection). The values of the cookies change when the user authenticates (after the POST) and this is another important security feature (preventing <a href="http://en.wikipedia.org/wiki/Session_fixation">session fixation attacks</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> It is not adequate for CSRF protection to rely on a cookie being sent back to the server because the browser will automatically send it even if you are not in a page loaded from your application (a Cross Site Scripting attack, otherwise known as <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a>). The header is not automatically sent, so the origin is under control. You might see that in our application the CSRF token is sent to the client as a cookie, so we will see it being sent back automatically by the browser, but it is the header that provides the protection. </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_help_how_is_my_application_going_to_scale">Help, How is My Application Going to Scale?</h3>
<div class="paragraph">
<p>"But waitâ¦" you are saying, "isnât it Really Bad to use session state in a single-page application?" The answer to that question is going to have to be "mostly", because it very definitely is a Good Thing to use the session for authentication and CSRF protection. That state has to be stored somewhere, and if you take it out of the session, you are going to have to put it somewhere else and manage it manually yourself, on both the server and the client. Thatâs just more code and probably more maintenance, and generally re-inventing a perfectly good wheel.</p>
</div>
<div class="paragraph">
<p>"But, butâ¦" you are going to respond, "how do I scale my application horizontally now?" This is the "real" question you were asking above, but it tends to get shortened to "session state is bad, I must be stateless". Donât panic. The main point to take on board here is that security <em>is</em> stateful. You canât have a secure, stateless application. So where are you going to store the state? Thatâs all there is to it. <a href="https://spring.io/team/rwinch">Rob Winch</a> gave a very useful and insightful talk at <a href="https://skillsmatter.com/skillscasts/5398-the-state-of-securing-restful-apis-with-spring">Spring Exchange 2014</a> explaining the need for state (and the ubiquity of it - TCP and SSL are stateful, so your system is stateful whether you knew it or not), which is probably worth a look if you want to look into this topic in more depth.</p>
</div>
<div class="paragraph">
<p>The good news is you have a choice. The easiest choice is to store the session data in-memory, and rely on sticky sessions in your load balancer to route requests from the same session back to the same JVM (they all support that somehow). Thatâs good enough to get you off the ground and will work for a <em>really</em> large number of use cases. The other choice is to share the session data between instances of your application. As long as you are strict and only store the security data, it is small and changes infrequently (only when users log in and out, or their session times out), so there shouldnât be any major infrastructure problems. Itâs also really easy to do with <a href="https://github.com/spring-projects/spring-session/">Spring Session</a>. Weâll be using Spring Session in the next section in this series, so thereâs no need to go into any detail about how to set it up here, but it is literally a few lines of code and a Redis server, which is super fast.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td>
<td class="content"> Another easy way to set up shared session state is to deploy your application as a WAR file to Cloud Foundry <a href="http://run.pivotal.io/">Pivotal Web Services</a> and bind it to a Redis service. </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_but_what_about_my_custom_token_implementation_it_s_stateless_look">But, What about My Custom Token Implementation (itâs Stateless, Look)?</h3>
<div class="paragraph">
<p>If that was your response to the last section, then read it again because maybe you didnât get it the first time. Itâs probably not stateless if you stored the token somewhere, but even if you didnât (e.g. you use JWT encoded tokens), how are you going to provide CSRF protection? Itâs important. Hereâs a rule of thumb (attributed to Rob Winch): if your application or API is going to be accessed by a browser, you need CSRF protection. Itâs not that you canât do it without sessions, itâs just that youâd have to write all that code yourself, and what would be the point because itâs already implemented and works perfectly well on top of <code>HttpSession</code> (which in turn is part of the container you are using and baked into specs since the very beginning)? Even if you decide you donât need CSRF, and have a perfectly "stateless" (non-session based) token implementation, you still had to write extra code in the client to consume and use it, where you could have just delegated to the browser and serverâs own built-in features: the browser always sends cookies, and the server always has a session (unless you switch it off). That code is not business logic, and it isnât making you any money, itâs just an overhead, so even worse, it costs you money.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>The application we have now is close to what a user might expect in a "real" application in a live environment, and it probably could be used as a template for building out into a more feature rich application with that architecture (single server with static content and JSON resources). We are using the <code>HttpSession</code> for storing security data, relying on our clients to respect and use the cookies we send them, and we are comfortable with that because it lets us concentrate on our own business domain. In the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">next section</a> we expand the architecture to a separate authentication and UI server, plus a standalone resource server for the JSON. This is obviously easily generalised to multiple resource servers. We are also going to introduce Spring Session into the stack and show how that can be used to share authentication data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_resource_server_angular_js_and_spring_security_part_iii">The Resource Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we start by breaking out the "greeting" resource that we are using as the dynamic content in our application into a separate server, first as an unprotected resource, and then protected by an opaque token. This is the third in a series of sections, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, or you can just go straight to the source code in Github, which is in two parts: one where the <a href="https://github.com/dsyer/spring-security-angular/tree/master/vanilla">resource is unprotected</a>, and one where it is <a href="https://github.com/dsyer/spring-security-angular/tree/master/spring-session">protected by a token</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: if you are working through this section with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_a_separate_resource_server">A Separate Resource Server</h3>
<div class="sect3">
<h4 id="_client_side_changes">Client Side Changes</h4>
<div class="paragraph">
<p>On the client side there isnât very much to do to move the resource to a different backend. Hereâs the "home" controller in the <a href="https://github.com/dsyer/spring-security-angular/blob/master/single/src/main/resources/static/js/hello.js">last section</a>:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
...
.controller(&#39;home&#39;, function($scope, $http) {
	$http.get(&#39;/resource/&#39;).success(function(data) {
		$scope.greeting = data;
	})
})
..."></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	$http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/resource/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		$scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
	</span><span class="pun">})</span><span class="pln">
</span><span class="pun">})</span><span class="pln">
</span><span class="pun">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All we need to do to this is change the URL. For example, if we are going to run the new resource on localhost, it could look like this:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
...
.controller(&#39;home&#39;, function($scope, $http) {
	$http.get(&#39;http://localhost:9000/&#39;).success(function(data) {
		$scope.greeting = data;
	})
})
..."></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	$http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'http://localhost:9000/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		$scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
	</span><span class="pun">})</span><span class="pln">
</span><span class="pun">})</span><span class="pln">
</span><span class="pun">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_side_changes">Server Side Changes</h4>
<div class="paragraph">
<p>The <a href="https://github.com/dsyer/spring-security-angular/blob/master/vanilla/ui/src/main/java/demo/UiApplication.java">UI server</a> is trivial to change: we just need to remove the <code>@RequestMapping</code> for the greeting resource (it was "/resource"). Then we need to create a new resource server, which we can do like we did in the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a> using the <a href="https://start.spring.io/">Spring Boot Initializr</a>. E.g. using curl on a UN*X like system:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mkdir resource &amp;&amp; cd resource
$ curl https://start.spring.io/starter.tgz -d style=web \
-d name=resource -d language=groovy | tar -xzvf -"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mkdir resource </span><span class="pun">&amp;&amp;</span><span class="pln"> cd resource
$ curl https</span><span class="pun">:</span><span class="com">//start.spring.io/starter.tgz -d style=web \</span><span class="pln">
</span><span class="pun">-</span><span class="pln">d name</span><span class="pun">=</span><span class="pln">resource </span><span class="pun">-</span><span class="pln">d language</span><span class="pun">=</span><span class="pln">groovy </span><span class="pun">|</span><span class="pln"> tar </span><span class="pun">-</span><span class="pln">xzvf </span><span class="pun">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then import that project (itâs a normal Maven Java project by default) into your favourite IDE, or just work with the files and "mvn" on the command line. We are using Groovy because we can, but please feel free to use Java if you prefer. There isnât going to be much code anyway.</p>
</div>
<div class="paragraph">
<p>Just add a <code>@RequestMapping</code> to the <a href="https://github.com/dsyer/spring-security-angular/blob/master/vanilla/resource/src/main/groovy/demo/ResourceApplication.groovy">main application class</a>, copying the implementation from the <a href="https://github.com/dsyer/spring-security-angular/blob/master/single/src/main/java/demo/UiApplication.java">old UI</a>:</p>
</div>
<div class="listingblock">
<div class="title">
ResourceApplication.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
class ResourceApplication {

  @RequestMapping(&#39;/&#39;)
  def home() {
    [id: UUID.randomUUID().toString(), content: &#39;Hello World&#39;]
  }comm

  static void main(String[] args) {
    SpringApplication.run ResourceApplication, args
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResourceApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">)</span><span class="pln">
  def home</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[</span><span class="pln">id</span><span class="pun">:</span><span class="pln"> UUID</span><span class="pun">.</span><span class="pln">randomUUID</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">(),</span><span class="pln"> content</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Hello World'</span><span class="pun">]</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">comm

  </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run </span><span class="typ">ResourceApplication</span><span class="pun">,</span><span class="pln"> args
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once that is done your application will be loadable in a browser. On the command line you can do this</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mvn spring-boot:run --server.port=9000"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mvn spring</span><span class="pun">-</span><span class="pln">boot</span><span class="pun">:</span><span class="pln">run </span><span class="pun">--</span><span class="pln">server</span><span class="pun">.</span><span class="pln">port</span><span class="pun">=</span><span class="lit">9000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and go to a browser at <a href="http://localhost:9000/">http://localhost:9000</a> and you should see JSON with a greeting. You can bake in the port change in <code>application.properties</code> (in"src/main/resources"):</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="server.port: 9000"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">server</span><span class="pun">.</span><span class="pln">port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">9000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you try loading that resource from the UI (on port 8080) in a browser, you will find that it doesnât work because the browser wonât allow the XHR request.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cors_negotiation">CORS Negotiation</h3>
<div class="paragraph">
<p>The browser tries to negotiate with our resource server to find out if it is allowed to access it according to the <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross Origin Resource Sharing</a> protocol. Itâs not an Angular JS responsibility, so just like the cookie contract it will work like this with all JavaScript in the browser. The two servers do not declare that they have a common origin, so the browser declines to send the request and the UI is broken.</p>
</div>
<div class="paragraph">
<p>To fix that we need to support the CORS protocol which involves a "pre-flight" OPTIONS request and some headers to list the allowed behaviour of the caller. Spring 4.2 might have some nice <a href="https://jira.spring.io/browse/SPR-9278">fine-grained CORS support</a>, but until that is released we can do an adequate job for the purposes of this application by sending the same CORS responses to all requests using a <code>Filter</code>. We can just create a class in the same directory as the resource server application and make sure it is a <code>@Component</code> (so it gets scanned into the Spring application context), for example:</p>
</div>
<div class="listingblock">
<div class="title">
CorsFilter.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
class CorsFilter implements Filter {

  void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) {
    HttpServletResponse response = (HttpServletResponse) res
    HttpServletRequest request = (HttpServletRequest) req
    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;)
    response.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, PUT, GET, OPTIONS, DELETE&quot;)
    response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;x-requested-with&quot;)
    response.setHeader(&quot;Access-Control-Max-Age&quot;, &quot;3600&quot;)
    if (request.getMethod()!=&#39;OPTIONS&#39;) {
      chain.doFilter(req, res)
    } else {
    }
  }

  void init(FilterConfig filterConfig) {}

  void destroy() {}

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Component</span><span class="pln">
</span><span class="lit">@Order</span><span class="pun">(</span><span class="typ">Ordered</span><span class="pun">.</span><span class="pln">HIGHEST_PRECEDENCE</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">CorsFilter</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">Filter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">void</span><span class="pln"> doFilter</span><span class="pun">(</span><span class="typ">ServletRequest</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ServletResponse</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="typ">FilterChain</span><span class="pln"> chain</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">HttpServletResponse</span><span class="pln"> response </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">HttpServletResponse</span><span class="pun">)</span><span class="pln"> res
    </span><span class="typ">HttpServletRequest</span><span class="pln"> request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">HttpServletRequest</span><span class="pun">)</span><span class="pln"> req
    response</span><span class="pun">.</span><span class="pln">setHeader</span><span class="pun">(</span><span class="str">"Access-Control-Allow-Origin"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"*"</span><span class="pun">)</span><span class="pln">
    response</span><span class="pun">.</span><span class="pln">setHeader</span><span class="pun">(</span><span class="str">"Access-Control-Allow-Methods"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"POST, PUT, GET, OPTIONS, DELETE"</span><span class="pun">)</span><span class="pln">
    response</span><span class="pun">.</span><span class="pln">setHeader</span><span class="pun">(</span><span class="str">"Access-Control-Allow-Headers"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"x-requested-with"</span><span class="pun">)</span><span class="pln">
    response</span><span class="pun">.</span><span class="pln">setHeader</span><span class="pun">(</span><span class="str">"Access-Control-Max-Age"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"3600"</span><span class="pun">)</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">request</span><span class="pun">.</span><span class="pln">getMethod</span><span class="pun">()!=</span><span class="str">'OPTIONS'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      chain</span><span class="pun">.</span><span class="pln">doFilter</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">void</span><span class="pln"> init</span><span class="pun">(</span><span class="typ">FilterConfig</span><span class="pln"> filterConfig</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{}</span><span class="pln">

  </span><span class="kwd">void</span><span class="pln"> destroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Filter</code> is defined with an <code>@Order</code> so that it is definitely applied <em>before</em> the main Spring Security filter. With that change to the resource server, we should be able to re-launch it and get our greeting in the UI.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> Blithely using <code>Access-Control-Allow-Origin=*</code> is quick and dirty, and it works, but it is not not secure and is not in any way recommended. </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_securing_the_resource_server">Securing the Resource Server</h3>
<div class="paragraph">
<p>Great! We have a working application with a new architecture. The only problem is that the resource server has no security.</p>
</div>
<div class="sect3">
<h4 id="_adding_spring_security">Adding Spring Security</h4>
<div class="paragraph">
<p>We can also look at how to add security to the resource server as a filter layer, like in the UI server. This is perhaps more conventional, and is certainly the best option in most PaaS environments (since they donât usually make private networks available to applications). The first step is really easy: just add Spring Security to the classpath in the Maven POM:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
  &lt;/dependency&gt;
  ...
&lt;/dependencies&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependencies&gt;</span><span class="pln">
  </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
    </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
    </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-security</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
  ...
</span><span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Re-launch the resource server and, hey presto! Itâs secure:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl -v localhost:9000
&lt; HTTP/1.1 302 Found
&lt; Location: http://localhost:9000/login
..."></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl </span><span class="pun">-</span><span class="pln">v localhost</span><span class="pun">:</span><span class="lit">9000</span><span class="pln">
</span><span class="pun">&lt;</span><span class="pln"> HTTP</span><span class="pun">/</span><span class="lit">1.1</span><span class="pln"> </span><span class="lit">302</span><span class="pln"> </span><span class="typ">Found</span><span class="pln">
</span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">Location</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9000/login</span><span class="pln">
</span><span class="pun">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are getting a redirect to a (whitelabel) login page because curl is not sending the same headers that our Angular client will. Modifying the command to send more similar headers:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl -v -H &quot;Accept: application/json&quot; \
    -H &quot;X-Requested-With: XMLHttpRequest&quot; localhost:9000
&lt; HTTP/1.1 401 Unauthorized
..."></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl </span><span class="pun">-</span><span class="pln">v </span><span class="pun">-</span><span class="pln">H </span><span class="str">"Accept: application/json"</span><span class="pln"> \
    </span><span class="pun">-</span><span class="pln">H </span><span class="str">"X-Requested-With: XMLHttpRequest"</span><span class="pln"> localhost</span><span class="pun">:</span><span class="lit">9000</span><span class="pln">
</span><span class="pun">&lt;</span><span class="pln"> HTTP</span><span class="pun">/</span><span class="lit">1.1</span><span class="pln"> </span><span class="lit">401</span><span class="pln"> </span><span class="typ">Unauthorized</span><span class="pln">
</span><span class="pun">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So all we need to do is teach the client to send credentials with every request.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_token_authentication">Token Authentication</h3>
<div class="paragraph">
<p>The internet, and peopleâs Spring backend projects, are littered with custom token-based authentication solutions. Spring Security provides a barebones <code>Filter</code> implementation to get you started on your own (see for example <a href="https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/authentication/preauth/AbstractPreAuthenticatedProcessingFilter.java"><code>AbstractPreAuthenticatedProcessingFilter</code></a> and <a href="https://github.com/spring-projects/spring-security/blob/master/core/src/main/java/org/springframework/security/core/token/TokenService.java"><code>TokenService</code></a>). There is no canonical implementation in Spring Security though, and one of the reasons why is probably that thereâs an easier way.</p>
</div>
<div class="paragraph">
<p>Remember from <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a> of this series that Spring Security uses the <code>HttpSession</code> to store authentication data by default. It doesnât interact directly with the session though: thereâs an abstraction layer (<a href="https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/context/SecurityContextRepository.java"><code>SecurityContextRepository</code></a>) in between that you can use to change the storage backend. If we can point that repository, in our resource server, to a store with an authentication verified by our UI, then we have a way to share authentication between the two servers. The UI server already has such a store (the <code>HttpSession</code>), so if we can distribute that store and open it up to the resource server, we have most of a solution.</p>
</div>
<div class="sect3">
<h4 id="_spring_session">Spring Session</h4>
<div class="paragraph">
<p>That part of the solution is pretty easy with <a href="https://github.com/spring-projects/spring-session/">Spring Session</a>. All we need is a shared data store (Redis is supported out of the box), and a few lines of configuration in the servers to set up a <code>Filter</code>.</p>
</div>
<div class="paragraph">
<p>In the UI application we need to add some dependencies to our <a href="https://github.com/dsyer/spring-security-angular/blob/master/spring-session/ui/pom.xml">POM</a>:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-redis&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.session</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-session</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;version&gt;</span><span class="pln">1.0.0.RELEASE</span><span class="tag">&lt;/version&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
</span><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-redis</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then add <code>@EnableRedisHttpSession</code> to your main application:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
public class UiApplication {

  public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

  ...

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">UiApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@EnableRedisHttpSession</code> annotation comes from Spring Session, and Spring Boot supplies a redis connection (a URL and credentials can be configured using environment variables or configuration files).</p>
</div>
<div class="paragraph">
<p>With that 1 line of code in place and a Redis server running on localhost you can run the UI application, login with some valid user credentials, and the session data (the authentication and CSRF token) will be stored in redis.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td>
<td class="content"> if you donât have a redis server running locally you can easily spin one up with <a href="https://www.docker.com/">Docker</a> (on Windows or MacOS this requires a VM). There is a <a href="http://docs.docker.com/compose/"><code>docker-compose.yml</code></a> file in the <a href="https://github.com/dsyer/spring-security-angular/tree/master/spring-session/docker-compose.yml">source code in Github</a> which you can run really easily on the command line with <code>docker-compose up</code>. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_a_custom_token_from_the_ui">Sending a Custom Token from the UI</h3>
<div class="paragraph">
<p>The only missing piece is the transport mechanism for the key to the data in the store. The key is the <code>HttpSession</code> ID, so if we can get hold of that key in the UI client, we can send it as a custom header to the resource server. So the "home" controller would need to change so that it sends the header as part of the HTTP request for the greeting resource. For example:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
...
.controller(&#39;home&#39;, function($scope, $http) {
  $http.get(&#39;token&#39;).success(function(token) {
    $http({
      url : &#39;http://localhost:9000&#39;,
      method : &#39;GET&#39;,
      headers : {
        &#39;X-Auth-Token&#39; : token.token
      }
    }).success(function(data) {
      $scope.greeting = data;
    });
  })
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $http</span><span class="pun">({</span><span class="pln">
      url </span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://localhost:9000'</span><span class="pun">,</span><span class="pln">
      method </span><span class="pun">:</span><span class="pln"> </span><span class="str">'GET'</span><span class="pun">,</span><span class="pln">
      headers </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">'X-Auth-Token'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">token
      </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
  </span><span class="pun">})</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(A more elegant solution might be to grab the token as needed, and use an Angular <a href="https://docs.angularjs.org/api/ng/service/$http">interceptor</a> to add the header to every request to the resource server. The interceptor definition could then be abstracted instead of doing it all in one place and cluttering up the business logic.)</p>
</div>
<div class="paragraph">
<p>Instead of going directly to "http://localhost:9000[<a href="http://localhost:9000/" class="bare">http://localhost:9000</a>]" we have wrapped that call in the success callback of a call to a new custom endpoint on the UI server at "/token". The implementation of that is trivial:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
public class UiApplication {

  public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

  ...

  @RequestMapping(&quot;/token&quot;)
  @ResponseBody
  public Map&lt;String,String&gt; token(HttpSession session) {
    return Collections.singletonMap(&quot;token&quot;, session.getId());
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">UiApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">"/token"</span><span class="pun">)</span><span class="pln">
  </span><span class="lit">@ResponseBody</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln"> token</span><span class="pun">(</span><span class="typ">HttpSession</span><span class="pln"> session</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Collections</span><span class="pun">.</span><span class="pln">singletonMap</span><span class="pun">(</span><span class="str">"token"</span><span class="pun">,</span><span class="pln"> session</span><span class="pun">.</span><span class="pln">getId</span><span class="pun">());</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the UI application is ready and will include the session ID in a header called "X-Auth-Token" for all calls to the backend.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authentication_in_the_resource_server">Authentication in the Resource Server</h3>
<div class="paragraph">
<p>There is one tiny change to the resource server for it to be able to accept the custom header. The CORS filter has to nominate that header as an allowed one from remote clients, e.g.</p>
</div>
<div class="listingblock">
<div class="title">
CorsFilter.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
public class CorsFilter implements Filter {

  void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
    ...
    response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;x-auth-token, x-requested-with&quot;)
    ...
  }

  ...
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Component</span><span class="pln">
</span><span class="lit">@Order</span><span class="pun">(</span><span class="typ">Ordered</span><span class="pun">.</span><span class="pln">HIGHEST_PRECEDENCE</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">CorsFilter</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">Filter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">void</span><span class="pln"> doFilter</span><span class="pun">(</span><span class="typ">ServletRequest</span><span class="pln"> req</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ServletResponse</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="typ">FilterChain</span><span class="pln"> chain</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">IOException</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ServletException</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
    response</span><span class="pun">.</span><span class="pln">setHeader</span><span class="pun">(</span><span class="str">"Access-Control-Allow-Headers"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"x-auth-token, x-requested-with"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All that remains is to pick up the custom token in the resource server and use it to authenticate our user. This turns out to be pretty straightforward because all we need to do is tell Spring Security where the session repository is, and where to look for the token (session ID) in an incoming request. First we need to add the Spring Session and Redis dependencies, and then we can set up the <code>Filter</code>:</p>
</div>
<div class="listingblock">
<div class="title">
ResourceApplication.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
class ResourceApplication {

  ...

  @Bean
  HeaderHttpSessionStrategy sessionStrategy() {
    new HeaderHttpSessionStrategy();
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResourceApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

  </span><span class="lit">@Bean</span><span class="pln">
  </span><span class="typ">HeaderHttpSessionStrategy</span><span class="pln"> sessionStrategy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HeaderHttpSessionStrategy</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Filter</code> created is the mirror image of the one in the UI server, so it establishes Redis as the session store. The only difference is that it uses a custom <code>HttpSessionStrategy</code> that looks in the header ("X-Auth-Token" by default) instead of the default (cookie named "JSESSIONID"). We also need to prevent the browser from popping up a dialog in an unauthenticated client - the app is secure but sends a 401 with <code>WWW-Authenticate: Basic</code> by default, so the browser responds with a dialog for username and password. There is more than one way to achieve this, but we already made Angular send an "X-Requested-With" header, so Spring Security handles it for us by default.</p>
</div>
<div class="paragraph">
<p>There is one final change to the resource server to make it work with our new authentication scheme. Spring Boot default security is stateless, and we want this to store authentication in the session, so we need to be explicit in <code>application.yml</code> (or <code>application.properties</code>):</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="security:
  sessions: NEVER"></button><pre class="prettyprint highlight prettyprinted"><code class="language-yaml" data-lang="yaml"><span class="pln">security</span><span class="pun">:</span><span class="pln">
  sessions</span><span class="pun">:</span><span class="pln"> NEVER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This says to Spring Security "never create a session, but use one if it is there" (it will be already be there because of the authentication in the UI).</p>
</div>
<div class="paragraph">
<p>Re-launch the resource server and open the UI up in a new browser window.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_doesn_t_it_all_work_with_cookies">Why Doesnât it All Work With Cookies?</h3>
<div class="paragraph">
<p>We had to use a custom header and write code in the client to populate the header, which isnât terribly complicated, but it seems to contradict the advice in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a> to use cookies and sessions wherever possible. The argument there was that not to do so introduces additional unecessary complexity, and for sure the implementation we have now is the most complex we have seen so far: the technical part of the solution far outweighs the business logic (which is admittedly tiny). This is definitely a fair criticism (and one we plan to address in the next section in this series), but letâs just briefly look at why itâs not as simple as just using cookies and sessions for everything.</p>
</div>
<div class="paragraph">
<p>At least we are still using the session, which makes sense because Spring Security and the Servlet container know how to do that with no effort on our part. But couldnât we have continued to use cookies to transport the authentication token? It would have been nice, but there is a reason it wouldnât work, and that is that the browser wouldnât let us. You can just go poking around in the browserâs cookie store from a JavaScript client, but there are some restrictions, and for good reason. In particular you donât have access to the cookies that were sent by the server as "HttpOnly" (which you will see is the case by default for session cookies). You also canât set cookies in outgoing requests, so we couldnât set a "SESSION" cookie (which is the Spring Session default cookie name), we had to use a custom "X-Session" header. Both these restrictions are for your own protection so malicious scripts cannot access your resources without proper authorization.</p>
</div>
<div class="paragraph">
<p>TL;DR the UI and resource servers do not have a common origin, so they cannot share cookies (even though we can use Spring Session to force them to share sessions).</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_2">Conclusion</h3>
<div class="paragraph">
<p>We have duplicated the features of the application in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II of this series</a>: a home page with a greeting fetched from a remote backend, with login and logout links in a navigation bar. The difference is that the greeting comes from a resource server that is a standalone, instead of being embedded in the UI server. This added significant complexity to the implementation, but the good news is that we have a mostly configuration-based (and practically 100% declarative) solution. We could even make the solution 100% declarative by extracting all the new code into libraries (Spring configuration and Angular custom directives). We are going to defer that interesting task for after the next couple of installments. In the <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv">next section</a> we are going to look at a different really great way to reduce all the complexity in the current implementation: the API Gateway Pattern (the client sends all its requests to one place and authentication is handled there).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> we used Spring Session here to share sessions between 2 servers that are not logically the same application. Itâs a neat trick, and it isnât possible with "regular" JEE distributed sessions. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">The API Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we show how to build an API Gateway to control the authentication and access to the backend resources using <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a>. This is the fourth in a series of sections, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/proxy">source code in Github</a>. In the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">last section</a> we built a simple distributed application that used <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> to authenticate the backend resources. In this one we make the UI server into a reverse proxy to the backend resource server, fixing the issues with the last implementation (technical complexity introduced by custom token authentication), and giving us a lot of new options for controlling access from the browser client.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: if you are working through this section with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_creating_an_api_gateway">Creating an API Gateway</h3>
<div class="paragraph">
<p>An API Gateway is a single point of entry (and control) for front end clients, which could be browser based (like the examples in this section) or mobile. The client only has to know the URL of one server, and the backend can be refactored at will with no change, which is a significant advantage. There are other advantages in terms of centralization and control: rate limiting, authentication, auditing and logging. And implementing a simple reverse proxy is really simple with <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a>.</p>
</div>
<div class="paragraph">
<p>If you were following along in the code, you will know that the application implementation at the end of the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">last section</a> was a bit complicated, so itâs not a great place to iterate away from. There was, however, a halfway point which we could start from more easily, where the backend resource wasnât yet secured with Spring Security. The source code for this is a separate project <a href="https://github.com/dsyer/spring-security-angular/tree/master/vanilla">in Github</a> so we are going to start from there. It has a UI server and a resource server and they are talking to each other. The resource server doesnât have Spring Security yet so we can get the system working first and then add that layer.</p>
</div>
<div class="sect3">
<h4 id="_declarative_reverse_proxy_in_one_line">Declarative Reverse Proxy in One Line</h4>
<div class="paragraph">
<p>To turn it into an API Gateawy, the UI server needs one small tweak. Somewhere in the Spring configuration we need to add an <code>@EnableZuulProxy</code> annotation, e.g. in the main (only) <a href="https://github.com/dsyer/spring-security-angular/blob/master/proxy/ui/src/main/java/demo/UiApplication.java">application class</a>:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableZuulProxy
public class UiApplication {
  ...
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableZuulProxy</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and in an external configuration file we need to map a local resource in the UI server to a remote one in the <a href="https://github.com/dsyer/spring-security-angular/blob/master/proxy/ui/src/main/resources/application.yml">external configuration</a> ("application.yml"):</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="security:
  ...
zuul:
  routes:
    resource:
      path: /resource/**
      url: http://localhost:9000"></button><pre class="prettyprint highlight prettyprinted"><code class="language-yaml" data-lang="yaml"><span class="pln">security</span><span class="pun">:</span><span class="pln">
  </span><span class="pun">...</span><span class="pln">
zuul</span><span class="pun">:</span><span class="pln">
  routes</span><span class="pun">:</span><span class="pln">
    resource</span><span class="pun">:</span><span class="pln">
      path</span><span class="pun">:</span><span class="pln"> </span><span class="str">/resource/</span><span class="pun">**</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This says "map paths with the pattern /resource/** in this server to the same paths in the remote server at localhost:9000". Simple and yet effective (OK so itâs 6 lines including the YAML, but you donât always need that)!</p>
</div>
<div class="paragraph">
<p>All we need to make this work is the right stuff on the classpath. For that purpose we have a few new lines in our Maven POM:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-parent&lt;/artifactId&gt;
      &lt;version&gt;1.0.0.BUILD-SNAPSHOT&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-zuul&lt;/artifactId&gt;
  &lt;/dependency&gt;
  ...
&lt;/dependencies&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span><span class="pln">
  </span><span class="tag">&lt;dependencies&gt;</span><span class="pln">
    </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
      </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.cloud</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-cloud-starter-parent</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
      </span><span class="tag">&lt;version&gt;</span><span class="pln">1.0.0.BUILD-SNAPSHOT</span><span class="tag">&lt;/version&gt;</span><span class="pln">
      </span><span class="tag">&lt;type&gt;</span><span class="pln">pom</span><span class="tag">&lt;/type&gt;</span><span class="pln">
      </span><span class="tag">&lt;scope&gt;</span><span class="pln">import</span><span class="tag">&lt;/scope&gt;</span><span class="pln">
    </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;/dependencies&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependencyManagement&gt;</span><span class="pln">

</span><span class="tag">&lt;dependencies&gt;</span><span class="pln">
  </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
    </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.cloud</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
    </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-cloud-starter-zuul</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
  ...
</span><span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the "spring-cloud-starter-zuul" - itâs a starter POM just like the Spring Boot ones, but it governs the dependencies we need for this Zuul proxy. We are also using <code>&lt;dependencyManagement&gt;</code> because we want to be able to depend on all the versions of transitive dependencies being correct.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consuming_the_proxy_in_the_client">Consuming the Proxy in the Client</h4>
<div class="paragraph">
<p>With those changes in place our application still works, but we havenât actually used the new proxy yet until we modify the client. Fortunately thatâs trivial. We just need to go from this implementation of the "home" controller:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
...
.controller(&#39;home&#39;, function($scope, $http) {
	$http.get(&#39;http://localhost:9000/&#39;).success(function(data) {
		$scope.greeting = data;
	})
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	$http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'http://localhost:9000/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		$scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
	</span><span class="pun">})</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to a local resource:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
...
.controller(&#39;home&#39;, function($scope, $http) {
	$http.get(&#39;resource/&#39;).success(function(data) {
		$scope.greeting = data;
	})
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
</span><span class="pun">...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	$http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'resource/'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		$scope</span><span class="pun">.</span><span class="pln">greeting </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
	</span><span class="pun">})</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we fire up the servers everything is working and the requests are being proxied through the UI (API Gateway) to the resource server.</p>
</div>
</div>
<div class="sect3">
<h4 id="_further_simplifications">Further Simplifications</h4>
<div class="paragraph">
<p>Even better: we donât need the CORS filter any more in the resource server. We threw that one together pretty quickly anyway, and it should have been a red light that we had to do anything as technically focused by hand (especially where it concerns security). Fortunately it is now redundant, so we can just throw it away, and go back to sleeping at night!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_securing_the_resource_server_2">Securing the Resource Server</h3>
<div class="paragraph">
<p>You might remember in the intermediate state that we started from there is no security in place for the resource server.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Aside: Lack of software security might not even be a problem if your network architecture mirrors the application architecture (you can just make the resource server physically inaccessible to anyone but the UI server). As a simple demonstration of that we can make the resource server only accessible on localhost. Just add this to <code>application.properties</code> in the resource server:</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="server.address: 127.0.0.1"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">server</span><span class="pun">.</span><span class="pln">address</span><span class="pun">:</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Wow, that was easy! Do that with a network address thatâs only visible in your data center and you have a security solution that works for all resource servers and all user desktops.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Suppose that we decide we do need security at the software level (quite likely for a number of reasons). Thatâs not going to be a problem, because all we need to do is add Spring Security as a dependency (in the <a href="https://github.com/dsyer/spring-security-angular/blob/master/proxy/resource/pom.xml">resource server POM</a>):</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-security</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Thatâs enough to get us a secure resource server, but it wonât get us a working application yet, for the same reason that it didnât in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">Part III</a>: there is no shared authentication state between the two servers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_authentication_state">Sharing Authentication State</h3>
<div class="paragraph">
<p>We can use the same mechanism to share authentication (and CSRF) state as we did in the last, i.e. <a href="https://github.com/spring-projects/spring-session/">Spring Session</a>. We add the dependency to both servers as before:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-redis&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.session</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-session</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;version&gt;</span><span class="pln">1.0.0.RELEASE</span><span class="tag">&lt;/version&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
</span><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-redis</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>but this time the configuration is much simpler because we can just add the same <code>Filter</code> declaration to both. First the UI server (adding <code>@EnableRedisHttpSession</code>):</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableZuulProxy
@EnableRedisHttpSession
public class UiApplication {

  ...

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableZuulProxy</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then the resource server. There are three small changes to make: one is adding <code>@EnableRedisHttpSession</code> to the <code>ResourceApplication</code>:</p>
</div>
<div class="listingblock">
<div class="title">
ResourceApplication.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
class ResourceApplication {
  ...
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResourceApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>another is to explicitly disable HTTP Basic in the resource server (to prevent the browser from popping up authentication dialogs):</p>
</div>
<div class="listingblock">
<div class="title">
ResourceApplication.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
class ResourceApplication extends WebSecurityConfigurerAdapter {

  ...

  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http.httpBasic().disable()
    http.authorizeRequests().anyRequest().authenticated()
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResourceApplication</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

  </span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    http</span><span class="pun">.</span><span class="pln">httpBasic</span><span class="pun">().</span><span class="pln">disable</span><span class="pun">()</span><span class="pln">
    http</span><span class="pun">.</span><span class="pln">authorizeRequests</span><span class="pun">().</span><span class="pln">anyRequest</span><span class="pun">().</span><span class="pln">authenticated</span><span class="pun">()</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Aside: an alternative, which would also prevent the authentication dialog, would be to keep HTTP Basic but change the 401 challenge to something other than "Basic". You can do that with a one-line implementation of <code>AuthenticationEntryPoint</code> in the <code>HttpSecurity</code> configuration callback.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>and the last one is to explicitly ask for a non-stateless session creation policy in <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="security.sessions: NEVER"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">security</span><span class="pun">.</span><span class="pln">sessions</span><span class="pun">:</span><span class="pln"> NEVER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As long as redis is still running in the background (use the <a href="https://github.com/dsyer/spring-security-angular/tree/master/proxy/fig.yml"><code>fig.yml</code></a> if you like to start it) then the system will work. Load the homepage for the UI at <a href="http://localhost:8080/">http://localhost:8080</a> and login and you will see the message from the backend rendered on the homepage.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_it_work_2">How Does it Work?</h3>
<div class="paragraph">
<p>What is going on behind the scenes now? First we can look at the HTTP requests in the UI server (and API Gateway):</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verb</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index.html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/css/angular-bootstrap.css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Twitter bootstrap CSS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/angular-bootstrap.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap and Angular JS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/hello.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to login page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whitelabel login page (ignored)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to login page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whitelabel login page (ignored)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login.html</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Angular login form partial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to home page (ignored)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON authenticated user</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Proxied) JSON greeting</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Thatâs identical to the sequence at the end of <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a> except for the fact that the cookie names are slightly different ("SESSION" instead of "JSESSIONID") because we are using Spring Session. But the architecture is different and that last request to "/resource" is special because it was proxied to the resource server.</p>
</div>
<div class="paragraph">
<p>We can see the reverse proxy in action by looking at the "/trace" endpoint in the UI server (from Spring Boot Actuator, which we added with the Spring Cloud dependencies). Go to <a href="http://localhost:8080/trace">http://localhost:8080/trace</a> in a new browser and scroll to the end (if you donât have one already get a JSON plugin for your browser to make it nice and readable). You will need to authenticate with HTTP Basic (browser popup), but the same credentials are valid as for your login form. At or near the end you should see a pair of requests something like this:</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> Try to use a different browser so that there is no chance of authentication crossover (e.g. use Firefox if yoused Chrome for testing the UI) - it wonât stop the app from working, but it will make the traces harder to read if they contain a mixture of authentication from the same browser. </td>
</tr>
</tbody>
</table>
</div>
<div class="listingblock">
<div class="title">
/trace
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="{
  &quot;timestamp&quot;: 1420558194546,
  &quot;info&quot;: {
    &quot;method&quot;: &quot;GET&quot;,
    &quot;path&quot;: &quot;/&quot;,
    &quot;query&quot;: &quot;&quot;
    &quot;remote&quot;: true,
    &quot;proxy&quot;: &quot;resource&quot;,
    &quot;headers&quot;: {
      &quot;request&quot;: {
        &quot;accept&quot;: &quot;application/json, text/plain, */*&quot;,
        &quot;x-xsrf-token&quot;: &quot;542c7005-309c-4f50-8a1d-d6c74afe8260&quot;,
        &quot;cookie&quot;: &quot;SESSION=c18846b5-f805-4679-9820-cd13bd83be67; XSRF-TOKEN=542c7005-309c-4f50-8a1d-d6c74afe8260&quot;,
        &quot;x-forwarded-prefix&quot;: &quot;/resource&quot;,
        &quot;x-forwarded-host&quot;: &quot;localhost:8080&quot;
      },
      &quot;response&quot;: {
        &quot;Content-Type&quot;: &quot;application/json;charset=UTF-8&quot;,
        &quot;status&quot;: &quot;200&quot;
      }
    },
  }
},
{
  &quot;timestamp&quot;: 1420558200232,
  &quot;info&quot;: {
    &quot;method&quot;: &quot;GET&quot;,
    &quot;path&quot;: &quot;/resource/&quot;,
    &quot;headers&quot;: {
      &quot;request&quot;: {
        &quot;host&quot;: &quot;localhost:8080&quot;,
        &quot;accept&quot;: &quot;application/json, text/plain, */*&quot;,
        &quot;x-xsrf-token&quot;: &quot;542c7005-309c-4f50-8a1d-d6c74afe8260&quot;,
        &quot;cookie&quot;: &quot;SESSION=c18846b5-f805-4679-9820-cd13bd83be67; XSRF-TOKEN=542c7005-309c-4f50-8a1d-d6c74afe8260&quot;
      },
      &quot;response&quot;: {
        &quot;Content-Type&quot;: &quot;application/json;charset=UTF-8&quot;,
        &quot;status&quot;: &quot;200&quot;
      }
    }
  }
},"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pun">{</span><span class="pln">
  </span><span class="str">"timestamp"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1420558194546</span><span class="pun">,</span><span class="pln">
  </span><span class="str">"info"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="str">"method"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"GET"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"path"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"query"</span><span class="pun">:</span><span class="pln"> </span><span class="str">""</span><span class="pln">
    </span><span class="str">"remote"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"proxy"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"resource"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"headers"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="str">"request"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"accept"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"application/json, text/plain, */*"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"x-xsrf-token"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"542c7005-309c-4f50-8a1d-d6c74afe8260"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"cookie"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"SESSION=c18846b5-f805-4679-9820-cd13bd83be67; XSRF-TOKEN=542c7005-309c-4f50-8a1d-d6c74afe8260"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"x-forwarded-prefix"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/resource"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"x-forwarded-host"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"localhost:8080"</span><span class="pln">
      </span><span class="pun">},</span><span class="pln">
      </span><span class="str">"response"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"application/json;charset=UTF-8"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"status"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"200"</span><span class="pln">
      </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">},</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
</span><span class="pun">},</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
  </span><span class="str">"timestamp"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1420558200232</span><span class="pun">,</span><span class="pln">
  </span><span class="str">"info"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="str">"method"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"GET"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"path"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/resource/"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"headers"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="str">"request"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"host"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"localhost:8080"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"accept"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"application/json, text/plain, */*"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"x-xsrf-token"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"542c7005-309c-4f50-8a1d-d6c74afe8260"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"cookie"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"SESSION=c18846b5-f805-4679-9820-cd13bd83be67; XSRF-TOKEN=542c7005-309c-4f50-8a1d-d6c74afe8260"</span><span class="pln">
      </span><span class="pun">},</span><span class="pln">
      </span><span class="str">"response"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"application/json;charset=UTF-8"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"status"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"200"</span><span class="pln">
      </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
</span><span class="pun">},</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second entry there is the request from the client to the gateway on "/resource" and you can see the cookies (added by the browser) and the CSRF header (added by Angular as discussed in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/second">Part II</a>). The first entry has <code>remote: true</code> and that means itâs tracing the call to the resource server. You can see it went out to a uri path "/" and you can see that (crucially) the cookies and CSRF headers have been sent too. Without Spring Session these headers would be meaningless to the resource server, but the way we have set it up it can now use those headers to re-constitute a session with authentication and CSRF token data. So the request is permitted and we are in business!</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_3">Conclusion</h3>
<div class="paragraph">
<p>We covered quite a lot in this section but we got to a really nice place where there is a minimal amount of boilerplate code in our two servers, they are both nicely secure and the user experience isnât compromised. That alone would be a reason to use the API Gateway pattern, but really we have only scratched the surface of what that might be used for (Netflix uses it for <a href="https://github.com/Netflix/zuul/wiki/How-We-Use-Zuul-At-Netflix">a lot of things</a>). Read up on <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> to find out more on how to make it easy to add more features to the gateway. The <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">next section</a> in this series will extend the application architecture a bit by extracting the authentication responsibilities to a separate server (the Single Sign On pattern).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sso_with_oauth2_angular_js_and_spring_security_part_v">Single Sign On with OAuth2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we show how to use <a href="http://projects.spring.io/spring-security-oauth/">Spring Security OAuth</a> together with <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> to extend our API Gateway to do Single Sign On and OAuth2 token authentication to backend resources. This is the fifth in a series of sections, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/oauth2">source code in Github</a>. In the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">last section</a> we built a small distributed application that used <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> to authenticate the backend resources and <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> to implement an embedded API Gateway in the UI server. In this section we extract the authentication responsibilities to a separate server to make our UI server the first of potentially many Single Sign On applications to the authorization server. This is a common pattern in many applications these days, both in the enterprise and in social startups. We will use an OAuth2 server as the authenticator, so that we can also use it to grant tokens for the backend resource server. Spring Cloud will automatically relay the access token to our backend, and enable us to further simplify the implementation of both the UI and resource servers.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: if you are working through this section with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_creating_an_oauth2_authorization_server">Creating an OAuth2 Authorization Server</h3>
<div class="paragraph">
<p>Our first step is to create a new server to handle authentication and token management. Following the steps in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a> we can begin with <a href="https://start.spring.io/">Spring Boot Initializr</a>. E.g. using curl on a UN*X like system:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl https://start.spring.io/starter.tgz -d style=web \
-d style=security -d name=authserver | tar -xzvf -"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl https</span><span class="pun">:</span><span class="com">//start.spring.io/starter.tgz -d style=web \</span><span class="pln">
</span><span class="pun">-</span><span class="pln">d style</span><span class="pun">=</span><span class="pln">security </span><span class="pun">-</span><span class="pln">d name</span><span class="pun">=</span><span class="pln">authserver </span><span class="pun">|</span><span class="pln"> tar </span><span class="pun">-</span><span class="pln">xzvf </span><span class="pun">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then import that project (itâs a normal Maven Java project by default) into your favourite IDE, or just work with the files and "mvn" on the command line.</p>
</div>
<div class="sect3">
<h4 id="_adding_the_oauth2_dependencies">Adding the OAuth2 Dependencies</h4>
<div class="paragraph">
<p>We need to add the <a href="http://projects.spring.io/spring-security-oauth">Spring OAuth</a> dependencies, so in our <a href="https://github.com/dsyer/spring-security-angular/blob/master/oauth2/authserver/pom.xml">POM</a> we add:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
  &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
  &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.security.oauth</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-security-oauth2</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;version&gt;</span><span class="pln">2.0.5.RELEASE</span><span class="tag">&lt;/version&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The authorization server is pretty easy to implement. A minimal version looks like this:</p>
</div>
<div class="listingblock">
<div class="title">
AuthserverApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
public class AuthserverApplication extends WebMvcConfigurerAdapter {

  public static void main(String[] args) {
    SpringApplication.run(AuthserverApplication.class, args);
  }

  @Configuration
  @EnableAuthorizationServer
  protected static class OAuth2Config extends AuthorizationServerConfigurerAdapter {

    @Autowired
    private AuthenticationManager authenticationManager;

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
      endpoints.authenticationManager(authenticationManager);
    }

@Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
      clients.inMemory()
          .withClient(&quot;acme&quot;)
          .secret(&quot;acmesecret&quot;)
          .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;refresh_token&quot;,
              &quot;password&quot;).scopes(&quot;openid&quot;);
    }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">AuthserverApplication</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebMvcConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">AuthserverApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="lit">@Configuration</span><span class="pln">
  </span><span class="lit">@EnableAuthorizationServer</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuth2Config</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">AuthorizationServerConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    </span><span class="lit">@Autowired</span><span class="pln">
    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">AuthenticationManager</span><span class="pln"> authenticationManager</span><span class="pun">;</span><span class="pln">

    </span><span class="lit">@Override</span><span class="pln">
    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">AuthorizationServerEndpointsConfigurer</span><span class="pln"> endpoints</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      endpoints</span><span class="pun">.</span><span class="pln">authenticationManager</span><span class="pun">(</span><span class="pln">authenticationManager</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

</span><span class="lit">@Override</span><span class="pln">
    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">ClientDetailsServiceConfigurer</span><span class="pln"> clients</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      clients</span><span class="pun">.</span><span class="pln">inMemory</span><span class="pun">()</span><span class="pln">
          </span><span class="pun">.</span><span class="pln">withClient</span><span class="pun">(</span><span class="str">"acme"</span><span class="pun">)</span><span class="pln">
          </span><span class="pun">.</span><span class="pln">secret</span><span class="pun">(</span><span class="str">"acmesecret"</span><span class="pun">)</span><span class="pln">
          </span><span class="pun">.</span><span class="pln">authorizedGrantTypes</span><span class="pun">(</span><span class="str">"authorization_code"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"refresh_token"</span><span class="pun">,</span><span class="pln">
              </span><span class="str">"password"</span><span class="pun">).</span><span class="pln">scopes</span><span class="pun">(</span><span class="str">"openid"</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We only had to do 2 things (after adding <code>@EnableAuthorizationServer</code>):</p>
</div>
<div class="ulist">
<ul>
<li> <p>Register a client "acme" with a secret and some authorized grant types including "authorization_code".</p> </li>
<li> <p>Inject the default <code>AuthenticationManager</code> from Spring Boot autoconfiguration and wire it into the OAuth2 endpoints.</p> </li>
</ul>
</div>
<div class="paragraph">
<p>Now letâs get it running on port 9999, with a predictable password for testing:</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="server.port=9999
security.user.password=password
server.contextPath=/uaa"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">server</span><span class="pun">.</span><span class="pln">port</span><span class="pun">=</span><span class="lit">9999</span><span class="pln">
security</span><span class="pun">.</span><span class="pln">user</span><span class="pun">.</span><span class="pln">password</span><span class="pun">=</span><span class="pln">password
server</span><span class="pun">.</span><span class="pln">contextPath</span><span class="pun">=/</span><span class="pln">uaa</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also set the context path so that it doesnât use the default ("/") because otherwise you can get cookies for other servers on localhost being sent to the wrong server. So get the server running and we can make sure it is working:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mvn spring-boot:run"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mvn spring</span><span class="pun">-</span><span class="pln">boot</span><span class="pun">:</span><span class="pln">run</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or start the <code>main()</code> method in your IDE.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_authorization_server">Testing the Authorization Server</h4>
<div class="paragraph">
<p>Our server is using the Spring Boot default security settings, so like the server in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a> it will be protected by HTTP Basic authentication. To initiate an <a href="https://tools.ietf.org/html/rfc6749#section-1.3.1">authorization code token grant</a> you visit the authorization endpoint, e.g. at <a href="http://localhost:9999/uaa/oauth/authorize?response_type=code&client_id=acme&redirect_uri=http://example.com">http://localhost:9999/uaa/oauth/authorize?response_type=code&amp;client_id=acme&amp;redirect_uri=http://example.com</a> once you have authenticated you will get a redirect to example.com with an authorization code attached, e.g. <a href="http://example.com/?code=jYWioI">http://example.com/?code=jYWioI</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> for the purposes of this sample application we have created a client "acme" with no registered redirect, which is what enables us to get a redirect the example.com. In a production application you should always register a redirect (and use HTTPS). </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>The code can be exchanged for an access token using the "acme" client credentials on the token endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl acme:acmesecret@localhost:9999/uaa/oauth/token  \
-d grant_type=authorization_code -d client_id=acme     \
-d redirect_uri=http://example.com -d code=jYWioI
{&quot;access_token&quot;:&quot;2219199c-966e-4466-8b7e-12bb9038c9bb&quot;,&quot;token_type&quot;:&quot;bearer&quot;,&quot;refresh_token&quot;:&quot;d193caf4-5643-4988-9a4a-1c03c9d657aa&quot;,&quot;expires_in&quot;:43199,&quot;scope&quot;:&quot;openid&quot;}"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl acme</span><span class="pun">:</span><span class="pln">acmesecret@localhost</span><span class="pun">:</span><span class="lit">9999</span><span class="pun">/</span><span class="pln">uaa</span><span class="pun">/</span><span class="pln">oauth</span><span class="pun">/</span><span class="pln">token  \
</span><span class="pun">-</span><span class="pln">d grant_type</span><span class="pun">=</span><span class="pln">authorization_code </span><span class="pun">-</span><span class="pln">d client_id</span><span class="pun">=</span><span class="pln">acme     \
</span><span class="pun">-</span><span class="pln">d redirect_uri</span><span class="pun">=</span><span class="pln">http</span><span class="pun">:</span><span class="com">//example.com -d code=jYWioI</span><span class="pln">
</span><span class="pun">{</span><span class="str">"access_token"</span><span class="pun">:</span><span class="str">"2219199c-966e-4466-8b7e-12bb9038c9bb"</span><span class="pun">,</span><span class="str">"token_type"</span><span class="pun">:</span><span class="str">"bearer"</span><span class="pun">,</span><span class="str">"refresh_token"</span><span class="pun">:</span><span class="str">"d193caf4-5643-4988-9a4a-1c03c9d657aa"</span><span class="pun">,</span><span class="str">"expires_in"</span><span class="pun">:</span><span class="lit">43199</span><span class="pun">,</span><span class="str">"scope"</span><span class="pun">:</span><span class="str">"openid"</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The access token is a UUID ("2219199câ¦"), backed by an in-memory token store in the server. We also got a refresh token that we can use to get a new access token when the current one expires.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> since we allowed "password" grants for the "acme" client we can also get a token directly from the token endpoint using curl and user credentials instead of an authorization code. This is not suitable for a browser based client, but itâs useful for testing. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>If you followed the link above you would have seen the whitelabel UI provided by Spring OAuth. To start with we will use this and we can come back later to beef it up like we did in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a> for the self-contained server.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="changing-the-resource-server">Changing the Resource Server</h3>
<div class="paragraph">
<p>If we follow on from <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a>, our resource server is using <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> for authentication, so we can take that out and replace it with Spring OAuth. We also need to remove the Spring Session and Redis dependencies, so replace this:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.RC1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-redis&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.session</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-session</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;version&gt;</span><span class="pln">1.0.0.RC1</span><span class="tag">&lt;/version&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
</span><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-redis</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with this:</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
  &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.security.oauth</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-security-oauth2</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then remove the session <code>Filter</code> from the <a href="https://github.com/dsyer/spring-security-angular/blob/master/vanilla-oauth2/resource/src/main/groovy/demo/ResourceApplication.groovy">main application class</a>, replacing it with the convenient <code>@EnableOAuth2Resource</code> annotation (from Spring Cloud Security):</p>
</div>
<div class="listingblock">
<div class="title">
ResourceApplication.groovy
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableOAuth2Resource
class ResourceApplication {

  @RequestMapping(&#39;/&#39;)
  def home() {
    [id: UUID.randomUUID().toString(), content: &#39;Hello World&#39;]
  }

  static void main(String[] args) {
    SpringApplication.run ResourceApplication, args
  }
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableOAuth2Resource</span><span class="pln">
</span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResourceApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">)</span><span class="pln">
  def home</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[</span><span class="pln">id</span><span class="pun">:</span><span class="pln"> UUID</span><span class="pun">.</span><span class="pln">randomUUID</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">(),</span><span class="pln"> content</span><span class="pun">:</span><span class="pln"> </span><span class="str">'Hello World'</span><span class="pun">]</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run </span><span class="typ">ResourceApplication</span><span class="pun">,</span><span class="pln"> args
  </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that one change the app is ready to challenge for an access token instead of HTTP Basic, but we need a config change to actually finish the process. We are going to add a small amount of external configuration (in "application.properties") to allow the resource server to decode the tokens it is given and authenticate a user:</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="...
spring.oauth2.resource.userInfoUri: http://localhost:9999/uaa/user"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pun">...</span><span class="pln">
spring</span><span class="pun">.</span><span class="pln">oauth2</span><span class="pun">.</span><span class="pln">resource</span><span class="pun">.</span><span class="pln">userInfoUri</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9999/uaa/user</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells the server that it can use the token to access a "/user" endpoint and use that to derive authentication information (itâs a bit like the <a href="https://developers.facebook.com/docs/graph-api/reference/v2.2/user/?locale=en_GB">"/me" endpoint</a> in the Facebook API). Effectively it provides a way for the resource server to decode the token, as expressed by the <code>ResourceServerTokenServices</code> interface in Spring OAuth2.</p>
</div>
<div class="paragraph">
<p>Run the application and hit the home page with a command line client:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ curl -v localhost:9000
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.35.0
&gt; Host: localhost:9000
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 401 Unauthorized
...
&lt; WWW-Authenticate: Bearer realm=&quot;null&quot;, error=&quot;unauthorized&quot;, error_description=&quot;An Authentication object was not found in the SecurityContext&quot;
&lt; Content-Type: application/json;charset=UTF-8
{&quot;error&quot;:&quot;unauthorized&quot;,&quot;error_description&quot;:&quot;An Authentication object was not found in the SecurityContext&quot;}"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ curl </span><span class="pun">-</span><span class="pln">v localhost</span><span class="pun">:</span><span class="lit">9000</span><span class="pln">
</span><span class="pun">&gt;</span><span class="pln"> GET </span><span class="pun">/</span><span class="pln"> HTTP</span><span class="pun">/</span><span class="lit">1.1</span><span class="pln">
</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">User</span><span class="pun">-</span><span class="typ">Agent</span><span class="pun">:</span><span class="pln"> curl</span><span class="pun">/</span><span class="lit">7.35</span><span class="pun">.</span><span class="lit">0</span><span class="pln">
</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">Host</span><span class="pun">:</span><span class="pln"> localhost</span><span class="pun">:</span><span class="lit">9000</span><span class="pln">
</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">Accept</span><span class="pun">:</span><span class="pln"> </span><span class="pun">*</span><span class="com">/*
&gt;
&lt; HTTP/1.1 401 Unauthorized
...
&lt; WWW-Authenticate: Bearer realm="null", error="unauthorized", error_description="An Authentication object was not found in the SecurityContext"
&lt; Content-Type: application/json;charset=UTF-8
{"error":"unauthorized","error_description":"An Authentication object was not found in the SecurityContext"}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and you will see a 401 with a "WWW-Authenticate" header indicating that it wants a bearer token.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> the <code>userInfoUri</code> is by far not the only way of hooking a resource server up with a way to decode tokens. In fact itâs sort of a lowest common denominator (and not part of the spec), but quite often available from OAuth2 providers (like Facebook, Cloud Foundry, Github), and other choices are available. For instance you can encode the user authentication in the token itself (e.g. with <a href="http://jwt.io/">JWT</a>), or use a shared backend store. There is also a <code>/token_info</code> endpoint in CloudFoundry, which provides more detailed information than the user info endpoint, but which requires more thorough authentication. Different options (naturally) provide different benefits and trade-offs, but a full discussion of those is outside the scope of this section. </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_user_endpoint">Implementing the User Endpoint</h3>
<div class="paragraph">
<p>On the authorization server we can easily add that endpoint</p>
</div>
<div class="listingblock">
<div class="title">
AuthserverApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableResourceServer
public class AuthserverApplication {

  @RequestMapping(&quot;/user&quot;)
  public Principal user(Principal user) {
    return user;
  }

  ...

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableResourceServer</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">AuthserverApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">"/user"</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Principal</span><span class="pln"> user</span><span class="pun">(</span><span class="typ">Principal</span><span class="pln"> user</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> user</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We added a <code>@RequestMapping</code> the same as the UI server in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a>, and also the <code>@EnableResourceServer</code> annotation from Spring OAuth, which by default secures everything in an authorization server except the "/oauth/*" endpoints.</p>
</div>
<div class="paragraph">
<p>With that endpoint in place we can test it and the greeting resource, since they both now accept bearer tokens that were created by the authorization server:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ TOKEN=2219199c-966e-4466-8b7e-12bb9038c9bb
$ curl -H &quot;Authorization: Bearer $TOKEN&quot; localhost:9000
{&quot;id&quot;:&quot;03af8be3-2fc3-4d75-acf7-c484d9cf32b1&quot;,&quot;content&quot;:&quot;Hello World&quot;}
$ curl -H &quot;Authorization: Bearer $TOKEN&quot; localhost:9999/uaa/user
{&quot;details&quot;:...,&quot;principal&quot;:{&quot;username&quot;:&quot;user&quot;,...},&quot;name&quot;:&quot;user&quot;}"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ TOKEN</span><span class="pun">=</span><span class="lit">2219199c</span><span class="pun">-</span><span class="lit">966e-4466</span><span class="pun">-</span><span class="lit">8b7e-12bb9038c9bb</span><span class="pln">
$ curl </span><span class="pun">-</span><span class="pln">H </span><span class="str">"Authorization: Bearer $TOKEN"</span><span class="pln"> localhost</span><span class="pun">:</span><span class="lit">9000</span><span class="pln">
</span><span class="pun">{</span><span class="str">"id"</span><span class="pun">:</span><span class="str">"03af8be3-2fc3-4d75-acf7-c484d9cf32b1"</span><span class="pun">,</span><span class="str">"content"</span><span class="pun">:</span><span class="str">"Hello World"</span><span class="pun">}</span><span class="pln">
$ curl </span><span class="pun">-</span><span class="pln">H </span><span class="str">"Authorization: Bearer $TOKEN"</span><span class="pln"> localhost</span><span class="pun">:</span><span class="lit">9999</span><span class="pun">/</span><span class="pln">uaa</span><span class="pun">/</span><span class="pln">user
</span><span class="pun">{</span><span class="str">"details"</span><span class="pun">:...,</span><span class="str">"principal"</span><span class="pun">:{</span><span class="str">"username"</span><span class="pun">:</span><span class="str">"user"</span><span class="pun">,...},</span><span class="str">"name"</span><span class="pun">:</span><span class="str">"user"</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(substitute the value of the access token that you obtain from your own authorization server to get that working yourself).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_ui_server">The UI Server</h3>
<div class="paragraph">
<p>The final piece of this application we need to complete is the UI server, extracting the authentication part and delegating to the authorization server. So, as with <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#changing-the-resource-server">the resource server</a>, we first need to remove the Spring Session and Redis dependencies and replace them with Spring OAuth2.</p>
</div>
<div class="paragraph">
<p>Once that is done we can remove the session filter and the "/user" endpoint as well, and set up the application to redirect to the authorization server (using the <code>@EnableOAuth2Sso</code> annotation):</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@EnableZuulProxy
@EnableOAuth2Sso
public class UiApplication {

  public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

  @Configuration
  @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
  protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@EnableZuulProxy</span><span class="pln">
</span><span class="lit">@EnableOAuth2Sso</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">UiApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="lit">@Configuration</span><span class="pln">
  </span><span class="lit">@Order</span><span class="pun">(</span><span class="typ">SecurityProperties</span><span class="pun">.</span><span class="pln">ACCESS_OVERRIDE_ORDER</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recall from <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a> that the UI server, by virtue of the <code>@EnableZuulProxy</code>, acts an API Gateway and we can declare the route mappings in YAML. So the "/user" endpoint can be proxied to the authorization server:</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="zuul:
  routes:
    resource:
      path: /resource/**
      url: http://localhost:9000
    user:
      path: /user/**
      url: http://localhost:9999/uaa/user"></button><pre class="prettyprint highlight prettyprinted"><code class="language-yaml" data-lang="yaml"><span class="pln">zuul</span><span class="pun">:</span><span class="pln">
  routes</span><span class="pun">:</span><span class="pln">
    resource</span><span class="pun">:</span><span class="pln">
      path</span><span class="pun">:</span><span class="pln"> </span><span class="str">/resource/</span><span class="pun">**</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9000</span><span class="pln">
    user</span><span class="pun">:</span><span class="pln">
      path</span><span class="pun">:</span><span class="pln"> </span><span class="str">/user/</span><span class="pun">**</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9999/uaa/user</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we need to change the <code>WebSecurityConfigurerAdapter</code> to an <code>OAuth2SsoConfigurerAdapter</code> since now it is going to be used to modify the defaults in the SSO filter chain set up by <code>@EnableOAuth2Sso</code>:</p>
</div>
<div class="listingblock">
<div class="title">
SecurityConfiguration.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Configuration
protected static class SecurityConfiguration extends OAuth2SsoConfigurerAdapter {

  @Override
  public void match(RequestMatchers matchers) {
    matchers.anyRequest();
  }

  @Override
  public void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests().antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/&quot;)
        .permitAll().anyRequest().authenticated().and().csrf()
        .csrfTokenRepository(csrfTokenRepository()).and()
        .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class);
  }

  ... // the csrf*() methods are the same as the old WebSecurityConfigurerAdapter
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Configuration</span><span class="pln">
</span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">OAuth2SsoConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> match</span><span class="pun">(</span><span class="typ">RequestMatchers</span><span class="pln"> matchers</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    matchers</span><span class="pun">.</span><span class="pln">anyRequest</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    http</span><span class="pun">.</span><span class="pln">authorizeRequests</span><span class="pun">().</span><span class="pln">antMatchers</span><span class="pun">(</span><span class="str">"/index.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/home.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">)</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">permitAll</span><span class="pun">().</span><span class="pln">anyRequest</span><span class="pun">().</span><span class="pln">authenticated</span><span class="pun">().</span><span class="pln">and</span><span class="pun">().</span><span class="pln">csrf</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">csrfTokenRepository</span><span class="pun">(</span><span class="pln">csrfTokenRepository</span><span class="pun">()).</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">addFilterAfter</span><span class="pun">(</span><span class="pln">csrfHeaderFilter</span><span class="pun">(),</span><span class="pln"> </span><span class="typ">CsrfFilter</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="pun">...</span><span class="pln"> </span><span class="com">// the csrf*() methods are the same as the old WebSecurityConfigurerAdapter</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The main changes (apart from the base class name) are that the matchers go into their own method, and there is no need for <code>formLogin()</code> any more.</p>
</div>
<div class="paragraph">
<p>There are also some mandatory external configuration properties for the <code>@EnableOAuth2Sso</code> annotation to be able to contact and authenticate with thr right authorization server. So we need this in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="spring:
  oauth2:
    sso:
      home:
        secure: false
        path: /,/**/*.html
    client:
      accessTokenUri: http://localhost:9999/uaa/oauth/token
      userAuthorizationUri: http://localhost:9999/uaa/oauth/authorize
      clientId: acme
      clientSecret: acmesecret
    resource:
      userInfoUri: http://localhost:9999/uaa/user"></button><pre class="prettyprint highlight prettyprinted"><code class="language-yaml" data-lang="yaml"><span class="pln">spring</span><span class="pun">:</span><span class="pln">
  oauth2</span><span class="pun">:</span><span class="pln">
    sso</span><span class="pun">:</span><span class="pln">
      home</span><span class="pun">:</span><span class="pln">
        secure</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pln">
        path</span><span class="pun">:</span><span class="pln"> </span><span class="str">/,/</span><span class="pun">**</span><span class="com">/*.html
    client:
      accessTokenUri: http://localhost:9999/uaa/oauth/token
      userAuthorizationUri: http://localhost:9999/uaa/oauth/authorize
      clientId: acme
      clientSecret: acmesecret
    resource:
      userInfoUri: http://localhost:9999/uaa/user</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The bulk of that is about the OAuth2 client ("acme") and the authorization server locations. There is also a <code>userInfoUri</code> (just like in the resource server) so that the user can be authenticated in the UI app itself. The "home" stuff is about allowing anonymous access to the static resources in our single page application.</p>
</div>
<div class="sect3">
<h4 id="_in_the_client">In the Client</h4>
<div class="paragraph">
<p>There are some minor tweaks to the UI application on the front end that we still need to make to trigger the redirect to the authorization server. The first is in the navigation bar in "index.html" where the "login" link changes from an Angular route:</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    ...
    &lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    ...
  &lt;/ul&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"navigation"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"nav nav-pills"</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"tablist"</span><span class="tag">&gt;</span><span class="pln">
    ...
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"#/login"</span><span class="tag">&gt;</span><span class="pln">login</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    ...
  </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to a plain HTML link</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    ...
    &lt;li&gt;&lt;a href=&quot;login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    ...
  &lt;/ul&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"navigation"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"nav nav-pills"</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"tablist"</span><span class="tag">&gt;</span><span class="pln">
    ...
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"login"</span><span class="tag">&gt;</span><span class="pln">login</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    ...
  </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "/login" endpoint that this goes to is handled by Spring Security and if the user is not authenticated it will result in a redirect to the authorization server.</p>
</div>
<div class="paragraph">
<p>We can also remove the definition of the <code>login()</code> function in the "navigation" controller, and the "/login" route from the Angular configuration, which simplifies the implementation a bit:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]).config(function($routeProvider) {

  $routeProvider.when(&#39;/&#39;, {
    templateUrl : &#39;home.html&#39;,
    controller : &#39;home&#39;
  }).otherwise(&#39;/&#39;);

}). // ...
.controller(&#39;navigation&#39;,

function($rootScope, $scope, $http, $location, $route) {

  $http.get(&#39;user&#39;).success(function(data) {
    if (data.name) {
      $rootScope.authenticated = true;
    } else {
      $rootScope.authenticated = false;
    }
  }).error(function() {
    $rootScope.authenticated = false;
  });

  $scope.credentials = {};

  $scope.logout = function() {
    $http.post(&#39;logout&#39;, {}).success(function() {
      $rootScope.authenticated = false;
      $location.path(&quot;/&quot;);
    }).error(function(data) {
      $rootScope.authenticated = false;
    });
  }

});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">]).</span><span class="pln">config</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$routeProvider</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  $routeProvider</span><span class="pun">.</span><span class="pln">when</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    templateUrl </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home.html'</span><span class="pun">,</span><span class="pln">
    controller </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home'</span><span class="pln">
  </span><span class="pun">}).</span><span class="pln">otherwise</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">);</span><span class="pln">

</span><span class="pun">}).</span><span class="pln"> </span><span class="com">// ...</span><span class="pln">
</span><span class="pun">.</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln">

</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$rootScope</span><span class="pun">,</span><span class="pln"> $scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">,</span><span class="pln"> $location</span><span class="pun">,</span><span class="pln"> $route</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="pln">name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
  </span><span class="pun">}).</span><span class="pln">error</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">

  $scope</span><span class="pun">.</span><span class="pln">credentials </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">

  $scope</span><span class="pun">.</span><span class="pln">logout </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $http</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="str">'logout'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{}).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
      $location</span><span class="pun">.</span><span class="pln">path</span><span class="pun">(</span><span class="str">"/"</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}).</span><span class="pln">error</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $rootScope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">});</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_it_work_3">How Does it Work?</h3>
<div class="paragraph">
<p>Run all the servers together now, and visit the UI in a browser at <a href="http://localhost:8080/">http://localhost:8080</a>. Click on the "login" link and you will be redirected to the authorization server to authenticate (HTTP Basic popup) and approve the token grant (whitelabel HTML), before being redirected to the home page in the UI with the greeting fetched from the OAuth2 resource server using the same token as we authenticated the UI with.</p>
</div>
<div class="paragraph">
<p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, may require a plugin in Firefox). Hereâs a summary:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verb</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index.html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/css/angular-bootstrap.css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Twitter bootstrap CSS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/angular-bootstrap.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap and Angular JS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/js/hello.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/home.html</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTML partial for home page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to login page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to auth server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(uaa)/oauth/authorize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(ignored)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to login page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to auth server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(uaa)/oauth/authorize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(ignored)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to auth server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(uaa)/oauth/authorize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP Basic auth happens here</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(uaa)/oauth/authorize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User approves grant, redirect to /login</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/login</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">302</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect to home page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Proxied) JSON authenticated user</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/home.html</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTML partial for home page</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Proxied) JSON greeting</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The requests prefixed with (uaa) are to the authorization server. The responses that are marked "ignored" are responses received by Angular in an XHR call, and since we arenât processing that data they are dropped on the floor. We do look for an authenticated user in the case of the "/user" resource, but since it isnât there in the first call, that response is dropped.</p>
</div>
<div class="paragraph">
<p>In the "/trace" endpoint of the UI (scroll down to the bottom) you will see the proxied backend requests to "/user" and "/resource", with <code>remote:true</code> and the bearer token instead of the cookie (as it would have been in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a>) being used for authentication. Spring Cloud Security has taken care of this for us: by recognising that we has <code>@EnableOAuth2Sso</code> and <code>@EnableZuulProxy</code> it has figured out that (by default) we want to relay the token to the proxied backends.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> As in previous sections, try to use a different browser for "/trace" so that there is no chance of authentication crossover (e.g. use Firefox if you used Chrome for testing the UI). </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_logout_experience">The Logout Experience</h3>
<div class="paragraph">
<p>If you click on the "logout" link you will see that the home page changes (the greeting is no longer displayed) so the user is no longer authenticated with the UI server. Click back on "login" though and you actually <em>donât</em> need to go back through the authentication and approval cycle in the authorization server (because you havenât logged out of that). Opinions will be divided as to whether that is a desirable user experience, and itâs a notoriously tricky problem (Single Sign Out: <a href="http://www.sciencedirect.com/science/article/pii/S2214212614000179">Science Direct article</a> and <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/SLOIssues">Shibboleth docs</a>). The ideal user experience might not be technically feasible, and you also have to be suspicious sometimes that users really want what they say they want. "I want 'logout' to log me out" sounds simple enough, but the obvious response is, "Logged out of what? Do you want to be logged out of <em>all</em> the systems controlled by this SSO server, or just the one that you clicked the 'logout' link in?" We donât have room to discuss this topic more broadly here but it does deserve more attention. If you are interested then there is some discussion of the principles and some (fairly unappetising) ideas about implementations in the <a href="http://openid.net/connect/">Open ID Connect</a> specification.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_4">Conclusion</h3>
<div class="paragraph">
<p>This is almost the end of our shallow tour through the Spring Security and Angular JS stack. We have a nice architecture now with clear responsibilities in three separate components, UI/API Gateway, resource server and authorization server/token granter. The amount of non-business code in all layers is now minimal, and itâs easy to see where to extend and improve the implementation with more business logic. The next steps will be to tidy up the UI in our authorization server, and probably add some more tests, including tests on the JavaScript client. Another interesting task is to extract all the boiler plate code and put it in a library (e.g. "spring-security-angular") containing Spring Security and Spring Session autoconfiguration and some webjars resources for the navigation controller in the Angular piece. Having read the sections in thir series, anyone who was hoping to learn the inner workings of either Angular JS or Spring Security will probably be disappointed, but if you wanted to see how they can work well together and how a little bit of configuration can go a long way, then hopefully you will have had a good experience. <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> is new and these samples required snapshots when they were written, but there are release candidates available and a GA release coming soon, so check it out and send some feedback <a href="https://github.com/spring-cloud">via Github</a> or <a href="https://gitter.im/spring-cloud/spring-cloud">gitter.im</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_multiple_ui_applications_and_a_gateway_single_page_application_with_spring_and_angular_js_part_vi">next section</a> in the series is about access decisions (beyond authentication) and employs multiple UI applications behind the same proxy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_addendum_bootstrap_ui_and_jwt_tokens_for_the_authorization_server">Addendum: Bootstrap UI and JWT Tokens for the Authorization Server</h3>
<div class="paragraph">
<p>You will find another version of this application in the <a href="https://github.com/dsyer/spring-security-angular/tree/master/oauth2">source code in Github</a> which has a pretty login page and user approval page implemented similarly to the way we did the login page in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a>. It also uses <a href="http://jwt.io/">JWT</a> to encode the tokens, so instead of using the "/user" endpoint, the resource server can pull enough information out of the token itself to do a simple authentication. The browser client still uses it, proxied through the UI server, so that it can determine if a user is authenticated (it doesnât need to do that very often, compared to the likely number of calls to a resource server in a real application).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multiple_ui_applications_and_a_gateway_single_page_application_with_spring_and_angular_js_part_vi">Multiple UI Applications and a Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we show how to use <a href="http://projects.spring.io/spring-security-oauth/">Spring Session</a> together with <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> to combine the features of the systems we built in parts II and IV, and actually end up building 3 single page applications with quite different responsibilities. The aim is to build a Gateway (like in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">part IV</a>) that is used not only for API resources but also to load the UI from a backend server. We simplify the token-wrangling bits of <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">part II</a> by using the Gateway to pass through the authentication to the backends. Then we extend the system to show how we can make local, granular access decisions in the backends, while still controlling identity and authentication at the Gateway. This is a very powerful model for building distributed systems in general, and has a number of benefits that we can explore as we introduce the features in the code we build.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: if you are working through this section with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that is to open a new incognito window.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_target_architecture">Target Architecture</h3>
<div class="paragraph">
<p>Hereâs a picture of the basic system we are going to build to start with:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./spring_files/double-simple.png" alt="Components of the System"></span></p>
</div>
<div class="paragraph">
<p>Like the other sample applications in this series it has a UI (HTML and JavaScript) and a Resource server. Like the sample in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a> it has a Gateway, but here it is separate, not part of the UI. The UI effectively becomes part of the backend, giving us even more choice to re-configure and re-implement features, and also bringing other benefits as we will see.</p>
</div>
<div class="paragraph">
<p>The browser goes to the Gateway for everything and it doesnât have to know about the architecture of the backend (fundamentally, it has no idea that there is a back end). One of the things the browser does in this Gateway is authentication, e.g. it sends a username and password like in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a>, and it gets a cookie in return. On subsequent requests it presents the cookie automatically and the Gateway passes it through to the backends. No code needs to be written on the client to enable the cookie passing. The backends use the cookie to authenticate and because all components share a session they share the same information about the user. Contrast this with <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">Part V</a> where the cookie had to be converted to an access token in the Gateway, and the access token then had to be independently decoded by all the backend components.</p>
</div>
<div class="paragraph">
<p>As in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a> the Gateway simplifies the interaction between clients and servers, and it presents a small, well-defined surface on which to deal with security. For example, we donât need to worry about <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross Origin Resource Sharing</a>, which is a welcome relief since it is easy to get wrong.</p>
</div>
<div class="paragraph">
<p>The source code for the complete project we are going to build is in <a href="https://github.com/dsyer/spring-security-angular/tree/master/double">Github here</a>, so you can just clone the project and work directly from there if you want. There is an extra component in the end state of this system ("double-admin") so ignore that for now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_the_backend">Building the Backend</h3>
<div class="paragraph">
<p>In this architecture the backend is very similar to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/spring-session">"spring-session"</a> sample we built in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">Part III</a>, with the exception that it doesnât actually need a login page. The easiest way to get to what we want here is probably to copy the "resource" server from Part III and take the UI from the <a href="https://github.com/dsyer/spring-security-angular/tree/master/basic">"basic"</a> sample in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a>. To get from the "basic" UI to the one we want here, we need only to add a couple of dependencies (like when we first used <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> in Part III):</p>
</div>
<div class="listingblock">
<div class="title">
pom.xml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-redis&lt;/artifactId&gt;
&lt;/dependency&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-xml" data-lang="xml"><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.session</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-session</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
  </span><span class="tag">&lt;version&gt;</span><span class="pln">1.0.0.RELEASE</span><span class="tag">&lt;/version&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
</span><span class="tag">&lt;dependency&gt;</span><span class="pln">
  </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.springframework.boot</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
  </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">spring-boot-starter-redis</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
</span><span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and add the <code>@EnableRedisHttpSession</code> annotation to the main application class:</p>
</div>
<div class="listingblock">
<div class="title">
UiApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@EnableRedisHttpSession
public class UiApplication {

public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UiApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">UiApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this is now a UI there is no need for the "/resource" endpoint. When you have done that you will have a very simple Angular application (the same as in the "basic" sample), which simplifies testing and reasoning about its behaviour greatly.</p>
</div>
<div class="paragraph">
<p>Lastly, we want this server to run as a backend, so weâll give it a non-default port to listen on (in <code>application.properties</code>):</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="server.port: 8081
security.sessions: NEVER"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">server</span><span class="pun">.</span><span class="pln">port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8081</span><span class="pln">
security</span><span class="pun">.</span><span class="pln">sessions</span><span class="pun">:</span><span class="pln"> NEVER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If thatâs the <em>whole</em> content <code>application.properties</code> then the application will be secure and accessible to a user called "user" with a password that is random, but printed on the console (at log level INFO) on startup. The "security.sessions" setting means that Spring Security will accept cookies as authentication tokens but wonât create them unless they already exist.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_resource_server">The Resource Server</h3>
<div class="paragraph">
<p>The Resource server is easy to generate from one of our existing samples. It is the same as the "spring-session" Resource server in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">Part III</a>: just a "/resource" endpoint and <code>@EnableRedisHttpSession</code> to get the distributed session data. We want this server to have a non-default port to listen on, and we want to be able to look up authentication in the session so we need this (in <code>application.properties</code>):</p>
</div>
<div class="listingblock">
<div class="title">
application.properties
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="server.port: 9000
security.sessions: NEVER"></button><pre class="prettyprint highlight prettyprinted"><code class="language-properties" data-lang="properties"><span class="pln">server</span><span class="pun">.</span><span class="pln">port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">9000</span><span class="pln">
security</span><span class="pun">.</span><span class="pln">sessions</span><span class="pun">:</span><span class="pln"> NEVER</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The completed sample is <a href="https://github.com/dsyer/spring-security-angular/tree/master/double/resource">here in github</a> if you want to take a peek.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_gateway">The Gateway</h3>
<div class="paragraph">
<p>For an initial implementation of a Gateway (the simplest thing that could possibly work) we can just take an empty Spring Boot web application and add the <code>@EnableZuulProxy</code> annotation. As we saw in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a> there are several ways to do that, and one is to use the <a href="http://start.spring.io/">Spring Initializr</a> to generate a skeleton project. Even easier, is to use the <a href="http://cloud-start.spring.io/">Spring Cloud Initializr</a> which is the same thing, but for <a href="http://cloud.spring.io/">Spring Cloud</a> applications. Using the same sequence of command line operations as in Part I:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="$ mkdir gateway &amp;&amp; cd gateway
$ curl https://cloud-start.spring.io/starter.tgz -d style=web \
  -d style=security -d style=cloud-zuul -d name=gateway \
  -d style=redis | tar -xzvf -"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">$ mkdir gateway </span><span class="pun">&amp;&amp;</span><span class="pln"> cd gateway
$ curl https</span><span class="pun">:</span><span class="com">//cloud-start.spring.io/starter.tgz -d style=web \</span><span class="pln">
  </span><span class="pun">-</span><span class="pln">d style</span><span class="pun">=</span><span class="pln">security </span><span class="pun">-</span><span class="pln">d style</span><span class="pun">=</span><span class="pln">cloud</span><span class="pun">-</span><span class="pln">zuul </span><span class="pun">-</span><span class="pln">d name</span><span class="pun">=</span><span class="pln">gateway \
  </span><span class="pun">-</span><span class="pln">d style</span><span class="pun">=</span><span class="pln">redis </span><span class="pun">|</span><span class="pln"> tar </span><span class="pun">-</span><span class="pln">xzvf </span><span class="pun">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then import that project (itâs a normal Maven Java project by default) into your favourite IDE, or just work with the files and "mvn" on the command line. There is a version <a href="https://github.com/dsyer/spring-security-angular/tree/master/double/gateway">in github</a> if you want to go from there, but it has a few extra features that we donât need yet.</p>
</div>
<div class="paragraph">
<p>Starting from the blank Initializr application, we add the Spring Session dependency (like in the UI above), and the <code>@EnableRedisHttpSession</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">
GatewayApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@EnableRedisHttpSession
@EnableZuulProxy
public class GatewayApplication {

public static void main(String[] args) {
    SpringApplication.run(GatewayApplication.class, args);
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="lit">@EnableZuulProxy</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">GatewayApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">GatewayApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Gateway is ready to run, but it doesnât yet know about our backend services, so letâs just set that up in its <code>application.yml</code> (renaming from <code>application.properties</code> if you did the curl thing above):</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="zuul:
  routes:
    ui:
      url: http://localhost:8081
    resource:
      url: http://localhost:9000
security:
  user:
    password:
      password
  sessions: ALWAYS"></button><pre class="prettyprint highlight prettyprinted"><code><span class="pln">zuul</span><span class="pun">:</span><span class="pln">
  routes</span><span class="pun">:</span><span class="pln">
    ui</span><span class="pun">:</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:8081</span><span class="pln">
    resource</span><span class="pun">:</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9000</span><span class="pln">
security</span><span class="pun">:</span><span class="pln">
  user</span><span class="pun">:</span><span class="pln">
    password</span><span class="pun">:</span><span class="pln">
      password
  sessions</span><span class="pun">:</span><span class="pln"> ALWAYS</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 2 routes in the proxy, one each for the UI and resource server, and we have set up a default password and a session persistence strategy (telling Spring Security to always create a session on authentication). This last bit is important because we want authentication and therefore sessions to be managed in the Gateway.</p>
</div>
</div>
<div class="sect2">
<h3 id="_up_and_running">Up and Running</h3>
<div class="paragraph">
<p>We now have three components, running on 3 ports. If you point the browser at <a href="http://localhost:8080/ui/">http://localhost:8080/ui/</a> you should get an HTTP Basic challenge, and you can authenticate as "user/password" (your credentials in the Gateway), and once you do that you should see a greeting in the UI, via a backend call through the proxy to the Resource server.</p>
</div>
<div class="paragraph">
<p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, may require a plugin in Firefox). Hereâs a summary:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Verb</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browser prompts for authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index.html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/css/angular-bootstrap.css</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Twitter bootstrap CSS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/js/angular-bootstrap.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap and Angular JS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/js/hello.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/ui/user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/resource/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON greeting</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You might not see the 401 because the browser treats the home page load as a single interaction. All requests are proxied (there is no content in the Gateway yet, beyond the Actuator endpoints for management).</p>
</div>
<div class="paragraph">
<p>Hurrah, it works! You have two backend servers, one of which is a UI, each with independent capabilities and able to be tested in isolation, and they are connected together with a secure Gateway that you control and for which you have configured the authentication. If the backends are not accessible to the browser it doesnât matter (in fact itâs probably an advantage because it gives you yet more control over physical security).</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_login_form">Adding a Login Form</h3>
<div class="paragraph">
<p>Just as in the "basic" sample in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a> we can now add a login form to the Gateway, e.g. by copying the code from <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a>. When we do that we can also add some basic navigation elements in the Gateway, so the user doesnât have to know the path to the UI backend in the proxy. So letâs first copy the static assets from the "single" UI into the Gateway, delete the message rendering and insert a login form into our home page (in the <code>&lt;body/&gt;</code> somewhere):</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;body ng-app=&quot;hello&quot; ng-controller=&quot;navigation&quot; ng-cloak
	class=&quot;ng-cloak&quot;&gt;
  ...
  &lt;div class=&quot;container&quot; ng-show=&quot;!authenticated&quot;&gt;
    &lt;form role=&quot;form&quot; ng-submit=&quot;login()&quot;&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;username&quot;&gt;Username:&lt;/label&gt; &lt;input type=&quot;text&quot;
          class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot;
          ng-model=&quot;credentials.username&quot; /&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;password&quot;&gt;Password:&lt;/label&gt; &lt;input type=&quot;password&quot;
          class=&quot;form-control&quot; id=&quot;password&quot; name=&quot;password&quot;
          ng-model=&quot;credentials.password&quot; /&gt;
      &lt;/div&gt;
      &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/body&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;body</span><span class="pln"> </span><span class="atn">ng-app</span><span class="pun">=</span><span class="atv">"hello"</span><span class="pln"> </span><span class="atn">ng-controller</span><span class="pun">=</span><span class="atv">"navigation"</span><span class="pln"> </span><span class="atn">ng-cloak</span><span class="pln">
	</span><span class="atn">class</span><span class="pun">=</span><span class="atv">"ng-cloak"</span><span class="tag">&gt;</span><span class="pln">
  ...
  </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"!authenticated"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">role</span><span class="pun">=</span><span class="atv">"form"</span><span class="pln"> </span><span class="atn">ng-submit</span><span class="pun">=</span><span class="atv">"login()"</span><span class="tag">&gt;</span><span class="pln">
      </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-group"</span><span class="tag">&gt;</span><span class="pln">
        </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">"username"</span><span class="tag">&gt;</span><span class="pln">Username:</span><span class="tag">&lt;/label&gt;</span><span class="pln"> </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text"</span><span class="pln">
          </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-control"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"username"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"username"</span><span class="pln">
          </span><span class="atn">ng-model</span><span class="pun">=</span><span class="atv">"credentials.username"</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln">
      </span><span class="tag">&lt;/div&gt;</span><span class="pln">
      </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-group"</span><span class="tag">&gt;</span><span class="pln">
        </span><span class="tag">&lt;label</span><span class="pln"> </span><span class="atn">for</span><span class="pun">=</span><span class="atv">"password"</span><span class="tag">&gt;</span><span class="pln">Password:</span><span class="tag">&lt;/label&gt;</span><span class="pln"> </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln">
          </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"form-control"</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"password"</span><span class="pln">
          </span><span class="atn">ng-model</span><span class="pun">=</span><span class="atv">"credentials.password"</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln">
      </span><span class="tag">&lt;/div&gt;</span><span class="pln">
      </span><span class="tag">&lt;button</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"btn btn-primary"</span><span class="tag">&gt;</span><span class="pln">Submit</span><span class="tag">&lt;/button&gt;</span><span class="pln">
    </span><span class="tag">&lt;/form&gt;</span><span class="pln">
  </span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;/body&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of the message rendering we will have a nice big navigation button:</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div class=&quot;container&quot; ng-show=&quot;authenticated&quot;&gt;
  &lt;a class=&quot;btn btn-primary&quot; href=&quot;/ui/&quot;&gt;Go To User Interface&lt;/a&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"btn btn-primary"</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"/ui/"</span><span class="tag">&gt;</span><span class="pln">Go To User Interface</span><span class="tag">&lt;/a&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are looking at the sample in github, it also has a minimal navigation bar with a "Logout" button. Hereâs the login form in a screenshot:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./spring_files/login.png" alt="Login Page"></span></p>
</div>
<div class="paragraph">
<p>To support the login form we need some JavaScript with a "navigation" controller implementing the <code>login()</code> function we declared in the <code>&lt;form/&gt;</code>, and we need to set the <code>authenticated</code> flag so that the home page will render differently depending on whether or not the user is authenticated. For example:</p>
</div>
<div class="listingblock">
<div class="title">
gateway.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;gateway&#39;, []).controller(&#39;navigation&#39;,
function($scope, $http) {

  ...

  authenticate();

  $scope.credentials = {};

$scope.login = function() {
    authenticate($scope.credentials, function() {
      if ($scope.authenticated) {
        console.log(&quot;Login succeeded&quot;)
        $scope.error = false;
        $scope.authenticated = true;
      } else {
        console.log(&quot;Login failed&quot;)
        $scope.error = true;
        $scope.authenticated = false;
      }
    })
  };

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'gateway'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]).</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln">
</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="pun">...</span><span class="pln">

  authenticate</span><span class="pun">();</span><span class="pln">

  $scope</span><span class="pun">.</span><span class="pln">credentials </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">

$scope</span><span class="pun">.</span><span class="pln">login </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    authenticate</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">.</span><span class="pln">credentials</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Login succeeded"</span><span class="pun">)</span><span class="pln">
        $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
        $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
      </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Login failed"</span><span class="pun">)</span><span class="pln">
        $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
        $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
      </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">})</span><span class="pln">
  </span><span class="pun">};</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the implementation of the <code>authenticate()</code> function is similar to that in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">Part II</a>:</p>
</div>
<div class="listingblock">
<div class="title">
gateway.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="var authenticate = function(credentials, callback) {

  var headers = credentials ? {
    authorization : &quot;Basic &quot;
        + btoa(credentials.username + &quot;:&quot;
            + credentials.password)
  } : {};

  $http.get(&#39;user&#39;, {
    headers : headers
  }).success(function(data) {
    if (data.name) {
      $scope.authenticated = true;
    } else {
      $scope.authenticated = false;
    }
    callback &amp;&amp; callback();
  }).error(function() {
    $scope.authenticated = false;
    callback &amp;&amp; callback();
  });

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="kwd">var</span><span class="pln"> authenticate </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> headers </span><span class="pun">=</span><span class="pln"> credentials </span><span class="pun">?</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    authorization </span><span class="pun">:</span><span class="pln"> </span><span class="str">"Basic "</span><span class="pln">
        </span><span class="pun">+</span><span class="pln"> btoa</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">.</span><span class="pln">username </span><span class="pun">+</span><span class="pln"> </span><span class="str">":"</span><span class="pln">
            </span><span class="pun">+</span><span class="pln"> credentials</span><span class="pun">.</span><span class="pln">password</span><span class="pun">)</span><span class="pln">
  </span><span class="pun">}</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">

  $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    headers </span><span class="pun">:</span><span class="pln"> headers
  </span><span class="pun">}).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="pln">name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    callback </span><span class="pun">&amp;&amp;</span><span class="pln"> callback</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">}).</span><span class="pln">error</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    callback </span><span class="pun">&amp;&amp;</span><span class="pln"> callback</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the <code>$scope</code> to store the <code>authenticated</code> flag because there is only one controller in this simple application.</p>
</div>
<div class="paragraph">
<p>If we run this enhanced Gateway, instead of having to remember the URL for the UI we can just load the home page and follow links. Hereâs the home page for an authenticated user:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./spring_files/home.png" alt="Home Page"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_granular_access_decisions_in_the_backend">Granular Access Decisions in the Backend</h3>
<div class="paragraph">
<p>Up to now our application is functionally very similar to the one in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">Part III</a> or <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">Part IV</a>, but with an additional dedicated Gateway. The advantage of the extra layer may not be yet apparent, but we can emphasise it by expanding the system a bit. Suppose we want to use that Gateway to expose another backend UI, for users to "administrate" the content in the main UI, and that we want to restrict access to this feature to users with special roles. So we will add an "Admin" application behind the proxy, and the system will look like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./spring_files/double-components.png" alt="Components of the System"></span></p>
</div>
<div class="paragraph">
<p>There is a new component (Admin) and a new route in the Gateway in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="title">
application.yml
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="zuul:
  routes:
    ui:
      url: http://localhost:8081
    admin:
      url: http://localhost:8082
    resource:
      url: http://localhost:9000"></button><pre class="prettyprint highlight prettyprinted"><code class="language-yaml" data-lang="yaml"><span class="pln">zuul</span><span class="pun">:</span><span class="pln">
  routes</span><span class="pun">:</span><span class="pln">
    ui</span><span class="pun">:</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:8081</span><span class="pln">
    admin</span><span class="pun">:</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:8082</span><span class="pln">
    resource</span><span class="pun">:</span><span class="pln">
      url</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//localhost:9000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fact that the existing UI is available to users in the "USER" role is indicated on the block diagram above in the Gateway box (green lettering), as is the fact that the "ADMIN" role is needed to go to the Admin application. The access decision for the "ADMIN" role could be applied in the Gateway, in which case it would appear in a <code>WebSecurityConfigurerAdapter</code>, or it could be applied in the Admin application itself (and we will see how to do that below).</p>
</div>
<div class="paragraph">
<p>In addition, suppose that within the Admin application we want to distinguish between "READER" and "WRITER" roles, so that we can permit (letâs say) users who are auditors to view the changes made by the main admin users. This is a granular access decision, where the rule is only known, and should only be known, in the backend application. In the Gateway we only need to ensure that our user accounts have the roles needed, and this information is available, but the Gateway doesnât need to know how to interpret it. In the Gateway we create user accounts to keep the sample application self-contained:</p>
</div>
<div class="listingblock">
<div class="title">
SecurityConfiguration.class
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

  @Autowired
  public void globalUserDetails(AuthenticationManagerBuilder auth) throws Exception {
    auth.inMemoryAuthentication()
      .withUser(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;)
    .and()
      .withUser(&quot;admin&quot;).password(&quot;admin&quot;).roles(&quot;USER&quot;, &quot;ADMIN&quot;, &quot;READER&quot;, &quot;WRITER&quot;)
    .and()
      .withUser(&quot;audit&quot;).password(&quot;audit&quot;).roles(&quot;USER&quot;, &quot;ADMIN&quot;, &quot;READER&quot;);
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="lit">@Configuration</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> extends </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@Autowired</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> globalUserDetails</span><span class="pun">(</span><span class="typ">AuthenticationManagerBuilder</span><span class="pln"> auth</span><span class="pun">)</span><span class="pln"> throws </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    auth</span><span class="pun">.</span><span class="pln">inMemoryAuthentication</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">withUser</span><span class="pun">(</span><span class="str">"user"</span><span class="pun">).</span><span class="pln">password</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">).</span><span class="pln">roles</span><span class="pun">(</span><span class="str">"USER"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">.</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">withUser</span><span class="pun">(</span><span class="str">"admin"</span><span class="pun">).</span><span class="pln">password</span><span class="pun">(</span><span class="str">"admin"</span><span class="pun">).</span><span class="pln">roles</span><span class="pun">(</span><span class="str">"USER"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"ADMIN"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"READER"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"WRITER"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">.</span><span class="pln">and</span><span class="pun">()</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">withUser</span><span class="pun">(</span><span class="str">"audit"</span><span class="pun">).</span><span class="pln">password</span><span class="pun">(</span><span class="str">"audit"</span><span class="pun">).</span><span class="pln">roles</span><span class="pun">(</span><span class="str">"USER"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"ADMIN"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"READER"</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the "admin" user has been enhanced with 3 new roles ("ADMIN", "READER" and "WRITER") and we have also added an "audit" user with "ADMIN" access, but not "WRITER".</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Aside: In a production system the user account data would be managed in a backend database (most likely a directory service), not hard coded in the Spring Configuration. Sample applications connecting to such a database are easy to find on the internet, for example in the <a href="https://github.com/spring-projects/spring-security/tree/master/samples">Spring Security Samples</a>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The access decisions go in the Admin application. For the "ADMIN" role (which is required globally for this backend) we do it in Spring Security:</p>
</div>
<div class="listingblock">
<div class="title">
SecurityConfiguration.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

@Override
  protected void configure(HttpSecurity http) throws Exception {
    http
    ...
      .authorizeRequests()
        .antMatchers(&quot;/index.html&quot;, &quot;/login&quot;, &quot;/&quot;).permitAll()
        .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)
        .anyRequest().authenticated()
    ...
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@Configuration</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SecurityConfiguration</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebSecurityConfigurerAdapter</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

</span><span class="lit">@Override</span><span class="pln">
  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> configure</span><span class="pun">(</span><span class="typ">HttpSecurity</span><span class="pln"> http</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    http
    </span><span class="pun">...</span><span class="pln">
      </span><span class="pun">.</span><span class="pln">authorizeRequests</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">antMatchers</span><span class="pun">(</span><span class="str">"/index.html"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/login"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/"</span><span class="pun">).</span><span class="pln">permitAll</span><span class="pun">()</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">antMatchers</span><span class="pun">(</span><span class="str">"/admin/**"</span><span class="pun">).</span><span class="pln">hasRole</span><span class="pun">(</span><span class="str">"ADMIN"</span><span class="pun">)</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">anyRequest</span><span class="pun">().</span><span class="pln">authenticated</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the "READER" and "WRITER" roles the application itself is split, and since the application is implemented in JavaScript, that is where we need to make the access decision. One way to do this is to have a home page with a computed view embedded in it:</p>
</div>
<div class="listingblock">
<div class="title">
index.html
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;div class=&quot;container&quot;&gt;
  &lt;h1&gt;Admin&lt;/h1&gt;
  &lt;div ng-show=&quot;authenticated&quot; ng-include=&quot;template&quot;&gt;&lt;/div&gt;
  &lt;div ng-show=&quot;!authenticated&quot; ng-include=&quot;&#39;unauthenticated.html&#39;&quot;&gt;&lt;/div&gt;
&lt;/div&gt;"></button><pre class="prettyprint highlight prettyprinted"><code class="language-html" data-lang="html"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"container"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;h1&gt;</span><span class="pln">Admin</span><span class="tag">&lt;/h1&gt;</span><span class="pln">
  </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"authenticated"</span><span class="pln"> </span><span class="atn">ng-include</span><span class="pun">=</span><span class="atv">"template"</span><span class="tag">&gt;&lt;/div&gt;</span><span class="pln">
  </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">ng-show</span><span class="pun">=</span><span class="atv">"!authenticated"</span><span class="pln"> </span><span class="atn">ng-include</span><span class="pun">=</span><span class="atv">"'unauthenticated.html'"</span><span class="tag">&gt;&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Angular JS evaluates the "ng-include" attribute value as an expression, and then uses the result to load a template.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td>
<td class="content"> A more complex application might use other mechanisms to modularize itself, e.g. the <code>$routeProvider</code> service that we used in nearly all the other applications in this series. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>The <code>template</code> variable is initialized in our controller, first by defining a utility function:</p>
</div>
<div class="listingblock">
<div class="title">
admin.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="var computeDefaultTemplate = function(user) {
  $scope.template = user &amp;&amp; user.roles
      &amp;&amp; user.roles.indexOf(&quot;ROLE_WRITER&quot;)&gt;0 ? &quot;write.html&quot; : &quot;read.html&quot;;
}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="kwd">var</span><span class="pln"> computeDefaultTemplate </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  $scope</span><span class="pun">.</span><span class="pln">template </span><span class="pun">=</span><span class="pln"> user </span><span class="pun">&amp;&amp;</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">roles
      </span><span class="pun">&amp;&amp;</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">roles</span><span class="pun">.</span><span class="pln">indexOf</span><span class="pun">(</span><span class="str">"ROLE_WRITER"</span><span class="pun">)&gt;</span><span class="lit">0</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="str">"write.html"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"read.html"</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then by using the utility function when the controller loads:</p>
</div>
<div class="listingblock">
<div class="title">
admin.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;admin&#39;, []).controller(&#39;home&#39;,

function($scope, $http) {

  $http.get(&#39;user&#39;).success(function(data) {
    if (data.name) {
      $scope.authenticated = true;
      $scope.user = data;
      computeDefaultTemplate(data);
    } else {
      $scope.authenticated = false;
    }
    $scope.error = null
  })
  ...

})"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'admin'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]).</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln">

</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  $http</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">).</span><span class="pln">success</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="pln">name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">user </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span><span class="pln">
      computeDefaultTemplate</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pln">
  </span><span class="pun">})</span><span class="pln">
  </span><span class="pun">...</span><span class="pln">

</span><span class="pun">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the first thing the application does is look at the usual (for this series) "/user" endpoint, then it extracts some data, sets the authenticated flag, and if the user is authenticated, computes the template by looking at the user data.</p>
</div>
<div class="paragraph">
<p>To support this function on the backend we need an endpoint, e.g. in our main application class:</p>
</div>
<div class="listingblock">
<div class="title">
AdminApplication.java
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@SpringBootApplication
@RestController
@EnableRedisHttpSession
public class AdminApplication {

  @RequestMapping(&quot;/user&quot;)
  public Map&lt;String, Object&gt; user(Principal user) {
    Map&lt;String, Object&gt; map = new LinkedHashMap&lt;String, Object&gt;();
    map.put(&quot;name&quot;, user.getName());
    map.put(&quot;roles&quot;, AuthorityUtils.authorityListToSet(((Authentication) user)
        .getAuthorities()));
    return map;
  }

  public static void main(String[] args) {
    SpringApplication.run(AdminApplication.class, args);
  }

}"></button><pre class="prettyprint highlight prettyprinted"><code class="language-java" data-lang="java"><span class="lit">@SpringBootApplication</span><span class="pln">
</span><span class="lit">@RestController</span><span class="pln">
</span><span class="lit">@EnableRedisHttpSession</span><span class="pln">
</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">AdminApplication</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

  </span><span class="lit">@RequestMapping</span><span class="pun">(</span><span class="str">"/user"</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> user</span><span class="pun">(</span><span class="typ">Principal</span><span class="pln"> user</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> map </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">LinkedHashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;();</span><span class="pln">
    map</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"name"</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">());</span><span class="pln">
    map</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"roles"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">AuthorityUtils</span><span class="pun">.</span><span class="pln">authorityListToSet</span><span class="pun">(((</span><span class="typ">Authentication</span><span class="pun">)</span><span class="pln"> user</span><span class="pun">)</span><span class="pln">
        </span><span class="pun">.</span><span class="pln">getAuthorities</span><span class="pun">()));</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> map</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="typ">SpringApplication</span><span class="pun">.</span><span class="pln">run</span><span class="pun">(</span><span class="typ">AdminApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

</span><span class="pun">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> the role names come back from the "/user" endpoint with the "ROLE_" prefix so we can distinguish them from other kinds of authorities (itâs a Spring Security thing). Thus the "ROLE_" prefix is needed in the JavaScript, but not in the Spring Security configuration, where it is clear from the method names that "roles" are the focus of the operations. </td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_why_are_we_here">Why are we Here?</h3>
<div class="paragraph">
<p>Now we have a nice little system with 2 independent user interfaces and a backend Resource server, all protected by the same authentication in a Gateway. The fact that the Gateway acts as a micro-proxy makes the implementation of the backend security concerns extremely simple, and they are free to concentrate on their own business concerns. The use of Spring Session has (again) avoided a huge amount of hassle and potential errors.</p>
</div>
<div class="paragraph">
<p>A powerful feature is that the backends can independently have any kind of authentication they like (e.g. you can go directly to the UI if you know its physical address and a set of local credentials). The Gateway imposes a completely unrelated set of constraints, as long as it can authenticate users and assign metadata to them that satisfy the access rules in the backends. This is an excellent design for being able to independently develop and test the backend components. If we wanted to, we could go back to an external OAuth2 server (like in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">Part V</a>, or even something completely different) for the authentication at the Gateway, and the backends would not need to be touched.</p>
</div>
<div class="paragraph">
<p>A bonus feature of this architecture (single Gateway controlling authentication, and shared session token across all components) is that "Single Logout", a feature we identified as difficult to implement in <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">Part V</a>, comes for free. To be more precise, one particular approach to the user experience of single logout is automatically available in our finished system: if a user logs out of any of the UIs (Gateway, UI backend or Admin backend), he is logged out of all the others, assuming that each individual UI implemented a "logout" feature the same way (invalidating the session).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Thanks: I would like to thank again everyone who helped me develop this series, and in particular <a href="http://spring.io/team/rwinch">Rob Winch</a> and <a href="https://twitter.com/thspaeth">Thorsten SpÃ¤th</a> for their careful reviews of the sections and sources code. Since <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">Part I</a> was published it hasnât changed much but all the other parts have evolved in response to comments and insights from readers, so thank you also to anyone who read the sections and took the trouble to join in the discussion.</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modular_angularjs_application">Modular AngularJS Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we continue <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">our discussion</a> of how to use <a href="http://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org/">Angular JS</a> in a "single page application". Here we show how to modularize the client-side code, and how to use "nice" URL paths without the fragment notation (e.g. "/#/login") which Angular uses by default, but most users dislike. This is the seventh section of a tutorial, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">first section</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/modular">source code in Github</a>. We will be able to tidy up a lot of loose ends from the JavaScript code of the rest of this series, and at the same time show how it can fit very snugly against a backend server built from Spring Security and Spring Boot.</p>
</div>
<div class="sect2">
<h3 id="breaking-up-the-application">Breaking up the Application</h3>
<div class="paragraph">
<p>The sample application that we worked with so far in this series was trivial enough that we could get away with a single JavaScript source file for the whole thing. No larger application will ever end up that way, even if it starts out life like this one, so to mimic real life in a sample we are going to break things up. A good starting point would be to take the "single" application from the <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">second section</a> and have a look at its structure in the source code. Hereâs a directory listing for the static content (excluding the "application.yml" that belongs on the server):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="static/
 js/
   hello.js
 home.html
 login.html
 index.html"></button><pre>static/
 js/
   hello.js
 home.html
 login.html
 index.html</pre>
</div>
</div>
<div class="paragraph">
<p>There are a few problems with this. One is obvious: all the JavaScript is in a single file (<code>hello.js</code>). Another is more subtle: we have HTML "partials" for views inside our application ("login.html" and "home.html") but they are all in a flat structure and not associated with the controller code that uses them.</p>
</div>
<div class="paragraph">
<p>Letâs take a closer look at the JavaScript and we will see that Angular makes it easy for us to break it up into more manageable pieces:</p>
</div>
<div class="listingblock">
<div class="title">
hello.js
</div>
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]).config(

  function($routeProvider, $httpProvider) {

    $routeProvider.when(&#39;/&#39;, {
      templateUrl : &#39;home.html&#39;,
      controller : &#39;home&#39;
    }).when(&#39;/login&#39;, {
      templateUrl : &#39;login.html&#39;,
      controller : &#39;navigation&#39;
    }).otherwise(&#39;/&#39;);

    ...

}).controller(&#39;navigation&#39;,
    function($rootScope, $scope, $http, $location, $route) {
      ...
}).controller(&#39;home&#39;, function($scope, $http) {
    ...
  })
});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pln"> </span><span class="pun">]).</span><span class="pln">config</span><span class="pun">(</span><span class="pln">

  </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$routeProvider</span><span class="pun">,</span><span class="pln"> $httpProvider</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    $routeProvider</span><span class="pun">.</span><span class="pln">when</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      templateUrl </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home.html'</span><span class="pun">,</span><span class="pln">
      controller </span><span class="pun">:</span><span class="pln"> </span><span class="str">'home'</span><span class="pln">
    </span><span class="pun">}).</span><span class="pln">when</span><span class="pun">(</span><span class="str">'/login'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      templateUrl </span><span class="pun">:</span><span class="pln"> </span><span class="str">'login.html'</span><span class="pun">,</span><span class="pln">
      controller </span><span class="pun">:</span><span class="pln"> </span><span class="str">'navigation'</span><span class="pln">
    </span><span class="pun">}).</span><span class="pln">otherwise</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">);</span><span class="pln">

    </span><span class="pun">...</span><span class="pln">

</span><span class="pun">}).</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln">
    </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$rootScope</span><span class="pun">,</span><span class="pln"> $scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">,</span><span class="pln"> $location</span><span class="pun">,</span><span class="pln"> $route</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="pun">...</span><span class="pln">
</span><span class="pun">}).</span><span class="pln">controller</span><span class="pun">(</span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> $http</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
  </span><span class="pun">})</span><span class="pln">
</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is some "config" and there are 2 controllers ("home" and "navigation"), and the controllers seem to map nicely to the partials ("home.html" and "login.html" respectively). So letâs break them out into those pieces:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="static/
  js/
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html"></button><pre>static/
  js/
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html</pre>
</div>
</div>
<div class="paragraph">
<p>The controller definitions have moved into their own modules, alongside the HTML that they need to operate - nice and modular. If we had needed images or custom stylesheets we would have done the same with those.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> all the client-side code is under a single directory, "js" (except <code>index.html</code> because that is a "welcome" page and loads automatically from the "static" directory). This is intentional because it makes it easy to apply a single Spring Security access rule to all the static resources. These ones are all unsecured (because <code>/js/**</code> is unsecure by default in a Spring Boot application), but you might need other rules for other applications, in which case you would pick a different path. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>For example, hereâs the <code>home.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="code,javascript
angular.module(&#39;home&#39;, []).controller(&#39;home&#39;, function($scope, $http) {
    $http.get(&#39;/user/&#39;).success(function(data) {
        $scope.user = data.name;
    });
});"></button><pre>code,javascript
angular.module('home', []).controller('home', function($scope, $http) {
    $http.get('/user/').success(function(data) {
        $scope.user = data.name;
    });
});</pre>
</div>
</div>
<div class="paragraph">
<p>and hereâs the new <code>hello.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="code,javascript
angular
    .module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;home&#39;, &#39;navigation&#39; ])
    .config(

        function($routeProvider, $httpProvider) {

          $routeProvider.when(&#39;/&#39;, {
            templateUrl : &#39;js/home/home.html&#39;,
            controller : &#39;home&#39;
          }).when(&#39;/login&#39;, {
            templateUrl : &#39;js/navigation/login.html&#39;,
            controller : &#39;navigation&#39;
          }).otherwise(&#39;/&#39;);

          $httpProvider.defaults.headers.common[&#39;X-Requested-With&#39;] = &#39;XMLHttpRequest&#39;;

        });"></button><pre>code,javascript
angular
    .module('hello', [ 'ngRoute', 'home', 'navigation' ])
    .config(

        function($routeProvider, $httpProvider) {

          $routeProvider.when('/', {
            templateUrl : 'js/home/home.html',
            controller : 'home'
          }).when('/login', {
            templateUrl : 'js/navigation/login.html',
            controller : 'navigation'
          }).otherwise('/');

          $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

        });</pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the "hello" module <em>depends on</em> the other two by listing them in the initial declaration along with <code>ngRoute</code>. To make that work you just need to load the module definitions in the right order in <code>index.html</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="...
&lt;script src=&quot;js/angular-bootstrap.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/home/home.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/navigation/navigation.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/hello.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
..."></button><pre>...
&lt;script src="js/angular-bootstrap.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="js/home/home.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="js/navigation/navigation.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script src="js/hello.js" type="text/javascript"&gt;&lt;/script&gt;
...</pre>
</div>
</div>
<div class="paragraph">
<p>This is the Angular JS dependency management system in action. Other frameworks have similar (and arguably superior) features. Also, in a larger application, you might use a build time step to bundle all the JavaScript together so it can be loaded efficiently by the browser, but thatâs almost a matter of taste.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-natural-routes">Using "Natural" Routes</h3>
<div class="paragraph">
<p>The Angular <code>$routeProvider</code> by default works with fragment locators in the URL path, e.g. the login page is specified as a route in <code>hello.js</code> as "/login" and this translates into "/#/login" in the actual URL (the one you see in the browser window). This is so that the JavaScript in the <code>index.html</code>, loaded via the root path "/", stays active on all routes. The fragment naming is a bit unfamiliar to users and it is sometimes more convenient to use "natural" routes, where the URL path is the same as the Angular route declarations, e.g. "/login" for "/login". You canât do that if you have <em>only</em> static resources, because <code>index.html</code> can only be loaded one way, but if you have some active components in the stack (a proxy or some server-side logic) then you can arrange for it to work by loading <code>index.html</code> from all the Angular routes.</p>
</div>
<div class="paragraph">
<p>In this series you have Spring Boot, so of course you have server-side logic, and using a simple Spring MVC controller you can naturalize the routes in your application. All you need is a a way to enumerate the Angular routes in the server. Here we choose to do it by a naming convention: all paths that do not contain a period (and are not explicitly mapped already) are Angular routes, and should forward to the home page:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="@RequestMapping(value = &quot;/{[path:[^\\.]*}&quot;)
public String redirect() {
  return &quot;forward:/&quot;;
}"></button><pre>@RequestMapping(value = "/{[path:[^\\.]*}")
public String redirect() {
  return "forward:/";
}</pre>
</div>
</div>
<div class="paragraph">
<p>This method just needs to be in a <code>@Controller</code> (not a <code>@RestController</code>) somewhere in the Spring application. We use a "forward" (not a "redirect") so that the browser remembers the "real" route, and thatâs what the user sees in the URL. It also means that any saved-request mechanisms around authentication in Spring Security would work out of the box, although we wonât be taking advantage of that in this application.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> the application in the sample code <a href="https://github.com/dsyer/spring-security-angular/tree/master/modular">in github</a> has an extra route, so you can see a slightly more fully featured, and therefore hopefully realistic, application ("/home" and "/message" are different modules with slightly different views). </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>To complete the application with "natural" routes, you need to tell Angular about it. There are two steps. First, in <code>hello.js</code> you add a line to the <code>config</code> function setting the "HTML5 mode" in the <code>$locationProvider</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;home&#39;, &#39;navigation&#39; ]).config(

  function($locationProvider, $routeProvider, $httpProvider) {

    $locationProvider.html5Mode(true);
    ...
});"></button><pre>angular.module('hello', [ 'ngRoute', 'home', 'navigation' ]).config(

  function($locationProvider, $routeProvider, $httpProvider) {

    $locationProvider.html5Mode(true);
    ...
});</pre>
</div>
</div>
<div class="paragraph">
<p>Coupled with that you need an extra <code>&lt;base/&gt;</code> element in the header of the HTML in <code>index.html</code>, and you need to change the links in the menu bar to remove the fragments ("#"):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;html&gt;
&lt;head&gt;
&lt;base href=&quot;/&quot; /&gt;
...
&lt;/head&gt;
&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
    &lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
        &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
            &lt;li&gt;&lt;a href=&quot;/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&quot;/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
            &lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
...
&lt;/html&gt;"></button><pre>&lt;html&gt;
&lt;head&gt;
&lt;base href="/" /&gt;
...
&lt;/head&gt;
&lt;body ng-app="hello" ng-cloak class="ng-cloak"&gt;
    &lt;div ng-controller="navigation" class="container"&gt;
        &lt;ul class="nav nav-pills" role="tablist"&gt;
            &lt;li&gt;&lt;a href="/"&gt;home&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="/login"&gt;login&lt;/a&gt;&lt;/li&gt;
            &lt;li ng-show="authenticated"&gt;&lt;a href="" ng-click="logout()"&gt;logout&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
...
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Angular uses the <code>&lt;base/&gt;</code> element to anchor the routes and write the URLs that show up in the browser. You are running in a Spring Boot application so the default setting is to serve from root path "/" (on port 8080). If you need to be able to serve from different root paths with the same application then you will need to render that path into the HTML using a server-side template (many people prefer to stick with static resources for a Single Page Application, so they are stuck with a static root path).</p>
</div>
</div>
<div class="sect2">
<h3 id="extracting-the-authentication-concerns">Extracting the Authentication Concerns</h3>
<div class="paragraph">
<p>When you modularized the application above you should have found that the code worked just by splitting it into modules, but there is a small niggle there that we are still using <code>$rootScope</code> to share state between the controllers. Thereâs nothing horribly wrong with that for such a small application and it got us a decent prototype to play with quite quickly, so letâs not be too sad about it, but now we can take the opportunity to extract all the authentication concerns into a separate module. In Angular terms what you need is a "service", so create a new module ("auth") next to your "home" and "navigation" modules:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="static/
  js/
    auth/
      auth.js
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html"></button><pre>static/
  js/
    auth/
      auth.js
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html</pre>
</div>
</div>
<div class="paragraph">
<p>Before writing the <code>auth.js</code> code we can anticipate the changes in the other modules. First in <code>navigation.js</code> you should make the "navigation" module depend on the new "auth" module, and inject the "auth" service into the controller (and of course <code>$rootScope</code> is no longer needed):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;navigation&#39;, [&#39;auth&#39;]).controller(
        &#39;navigation&#39;,

        function($scope, auth) {

            $scope.credentials = {};

            $scope.authenticated = function() {
                return auth.authenticated;
            }

            $scope.login = function() {
                auth.authenticate($scope.credentials, function(authenticated) {
                    if (authenticated) {
                        console.log(&quot;Login succeeded&quot;)
                        $scope.error = false;
                    } else {
                        console.log(&quot;Login failed&quot;)
                        $scope.error = true;
                    }
                })
            };

            $scope.logout = function() {
              auth.clear();
            }

        });"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular</span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="str">'auth'</span><span class="pun">]).</span><span class="pln">controller</span><span class="pun">(</span><span class="pln">
        </span><span class="str">'navigation'</span><span class="pun">,</span><span class="pln">

        </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">,</span><span class="pln"> auth</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

            $scope</span><span class="pun">.</span><span class="pln">credentials </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">

            $scope</span><span class="pun">.</span><span class="pln">authenticated </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                </span><span class="kwd">return</span><span class="pln"> auth</span><span class="pun">.</span><span class="pln">authenticated</span><span class="pun">;</span><span class="pln">
            </span><span class="pun">}</span><span class="pln">

            $scope</span><span class="pun">.</span><span class="pln">login </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                auth</span><span class="pun">.</span><span class="pln">authenticate</span><span class="pun">(</span><span class="pln">$scope</span><span class="pun">.</span><span class="pln">credentials</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">authenticated</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">authenticated</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Login succeeded"</span><span class="pun">)</span><span class="pln">
                        $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">
                    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
                        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Login failed"</span><span class="pun">)</span><span class="pln">
                        $scope</span><span class="pun">.</span><span class="pln">error </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
                    </span><span class="pun">}</span><span class="pln">
                </span><span class="pun">})</span><span class="pln">
            </span><span class="pun">};</span><span class="pln">

            $scope</span><span class="pun">.</span><span class="pln">logout </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
              auth</span><span class="pun">.</span><span class="pln">clear</span><span class="pun">();</span><span class="pln">
            </span><span class="pun">}</span><span class="pln">

        </span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It isnât very different from the old controller (it still needs functions for user actions, login and logout, and an object to hold the credentials for login), but it has abstracted the implementation to the new "auth" service. The "auth" service will need an <code>authenticate()</code> function to support the <code>login()</code>, and a <code>clear()</code> function to support <code>logout()</code>. It also has a flag <code>authenticated</code> that replaces the <code>$rootScope.authenticated</code> from the old controller. We use the <code>authenticated</code> flag in a function with the same name attached to the <code>$scope</code> of the controller, so that Angular will keep checking its value and update the UI when the user logs in.</p>
</div>
<div class="paragraph">
<p>Suppose you want to make the "auth" module re-usable, so you donât want any hard-coded paths in it. Thatâs not a problem, but you will need to initialize or configure the paths in the <code>hello.js</code> module. To do that you can add a <code>run()</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular
  .module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;auth&#39;, &#39;home&#39;, &#39;navigation&#39; ])
  .config(
    ...
  }).run(function(auth) {

    auth.init(&#39;/&#39;, &#39;/login&#39;, &#39;/logout&#39;);

});"></button><pre class="prettyprint highlight prettyprinted"><code class="language-javascript" data-lang="javascript"><span class="pln">angular
  </span><span class="pun">.</span><span class="pln">module</span><span class="pun">(</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="str">'ngRoute'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'auth'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'home'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'navigation'</span><span class="pln"> </span><span class="pun">])</span><span class="pln">
  </span><span class="pun">.</span><span class="pln">config</span><span class="pun">(</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
  </span><span class="pun">}).</span><span class="pln">run</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">auth</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">

    auth</span><span class="pun">.</span><span class="pln">init</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/login'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/logout'</span><span class="pun">);</span><span class="pln">

</span><span class="pun">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>run()</code> function can call into any of the modules that "hello" depends on, in this case injecting an <code>auth</code> service and initializing it with the paths of the home page, login and logout endpoints respectively.</p>
</div>
<div class="paragraph">
<p>Now you need to load the "auth" module in <code>index.html</code> in addition to the other modules (and before the "login" module since it depends on "auth"):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="...
&lt;script src=&quot;js/auth/auth.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
...
&lt;script src=&quot;js/hello.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
..."></button><pre>...
&lt;script src="js/auth/auth.js" type="text/javascript"&gt;&lt;/script&gt;
...
&lt;script src="js/hello.js" type="text/javascript"&gt;&lt;/script&gt;
...</pre>
</div>
</div>
<div class="paragraph">
<p>Then finally you can write the code for the three functions you pencilled in above (<code>authenticate()</code>, <code>clear()</code> and <code>init()</code>). Hereâs most of the code:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;auth&#39;, []).factory(
    &#39;auth&#39;,

    function($http, $location) {

      var auth = {

        authenticated : false,

        loginPath : &#39;/login&#39;,
        logoutPath : &#39;/logout&#39;,
        homePath : &#39;/&#39;,

        authenticate : function(credentials, callback) {

          var headers = credentials &amp;&amp; credentials.username ? {
            authorization : &quot;Basic &quot;
                + btoa(credentials.username + &quot;:&quot;
                    + credentials.password)
          } : {};

          $http.get(&#39;user&#39;, {
            headers : headers
          }).success(function(data) {
            if (data.name) {
              auth.authenticated = true;
            } else {
              auth.authenticated = false;
            }
            $location.path(auth.homePath);
            callback &amp;&amp; callback(auth.authenticated);
          }).error(function() {
            auth.authenticated = false;
            callback &amp;&amp; callback(false);
          });

        },

        clear : function() { ... },

        init : function(homePath, loginPath, logoutPath) { ... }

      };

      return auth;

    });"></button><pre>angular.module('auth', []).factory(
    'auth',

    function($http, $location) {

      var auth = {

        authenticated : false,

        loginPath : '/login',
        logoutPath : '/logout',
        homePath : '/',

        authenticate : function(credentials, callback) {

          var headers = credentials &amp;&amp; credentials.username ? {
            authorization : "Basic "
                + btoa(credentials.username + ":"
                    + credentials.password)
          } : {};

          $http.get('user', {
            headers : headers
          }).success(function(data) {
            if (data.name) {
              auth.authenticated = true;
            } else {
              auth.authenticated = false;
            }
            $location.path(auth.homePath);
            callback &amp;&amp; callback(auth.authenticated);
          }).error(function() {
            auth.authenticated = false;
            callback &amp;&amp; callback(false);
          });

        },

        clear : function() { ... },

        init : function(homePath, loginPath, logoutPath) { ... }

      };

      return auth;

    });</pre>
</div>
</div>
<div class="paragraph">
<p>The "auth" module creates a factory for an <code>auth</code> service (which you already injected into the "navigation" controller for instance). The factory is just a function that returns an object (<code>auth</code>), and the object has to have the three functions and the flag that we anticipated above. Above, we have shown an implementation of the <code>authenticate()</code> function, which is substantially the same as the old one in the "navigation" controller, it calls out to a backend resource at "/user", sets a flag <code>authenticated</code> and calls an optional callback with the value of the flag. If successful, it also sends the user to the <code>homePath</code> using the <code>$location</code> service (we will improve on this in a minute).</p>
</div>
<div class="paragraph">
<p>Here is a bare-bones implementation of the <code>init()</code> function that just sets up the various paths you didnât want to hard code in the "auth" module:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="init : function(homePath, loginPath, logoutPath) {
  auth.homePath = homePath;
  auth.loginPath = loginPath;
  auth.logoutPath = logoutPath;
}"></button><pre>init : function(homePath, loginPath, logoutPath) {
  auth.homePath = homePath;
  auth.loginPath = loginPath;
  auth.logoutPath = logoutPath;
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>clear()</code> function implementation comes next, but itâs rather simple:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="clear : function() {
  auth.authenticated = false;
  $location.path(auth.loginPath);
  $http.post(auth.logoutPath, {});
}"></button><pre>clear : function() {
  auth.authenticated = false;
  $location.path(auth.loginPath);
  $http.post(auth.logoutPath, {});
}</pre>
</div>
</div>
<div class="paragraph">
<p>It unsets the <code>authenticated</code> flag, sends the user back to the login page, and then sends an HTTP POST to the logout path. The POST succeeds because we still have the CSRF protection features from the original "single" application in place. If you see a 403, look at the error message and server logs, then check that you have that filter in place and the XSRF cookie is being sent.</p>
</div>
<div class="paragraph">
<p>The very last change is to the <code>index.html</code> so that the "logout" link is hidden when the user is not authenticated:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="&lt;html&gt;
...
&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
  &lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
    &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
          ...
      &lt;li ng-show=&quot;authenticated()&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
...
&lt;/html&gt;"></button><pre>&lt;html&gt;
...
&lt;body ng-app="hello" ng-cloak class="ng-cloak"&gt;
  &lt;div ng-controller="navigation" class="container"&gt;
    &lt;ul class="nav nav-pills" role="tablist"&gt;
          ...
      &lt;li ng-show="authenticated()"&gt;&lt;a href="" ng-click="logout()"&gt;logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
...
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>You simply need to convert the flag <code>authenticated</code> to a function call <code>authenticated()</code>, so that the "navigation" controller can reach into the "auth" service and find the value of the flag, now that it is not in <code>$rootScope</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="redirecting-to-the-login-page">Redirecting to the Login Page</h3>
<div class="paragraph">
<p>The way we have implemented our home page up to now it has some content it can display when the user is anauthenticated (it just invites them to log in). Some applications work that way, and some donât. Some provide a different user experience where the user never sees anything apart from the login page until he is authenticated, so letâs see how we might convert our application to this pattern.</p>
</div>
<div class="paragraph">
<p>Hiding all content with a login page is a classic cross-cutting concern: you donât want all the logic for showing the login page stuck in all the UI modules (it would be duplicated everywhere, making the code harder to read and harder to maintain). Spring Security is all about cross-cutting concerns in the server, since it builds on top of <code>Filters</code> and AOP interceptors. Unfortunately that wonât help us much in a Single Page Application, but fortunately Angular also has some features that make it easy to implement the pattern we want. The feature that helps us here is that you can install a listener for "route changes", so every time the user moves to a new route (i.e. clicks on a menu bar or whatever) or when the page loads for the first time, you get to inspect the route and if you need to you can change it.</p>
</div>
<div class="paragraph">
<p>To install the listener you can write a small piece of extra code in your <code>auth.init()</code> function (since that is already arranged to run when the main "hello" module loads):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="angular.module(&#39;auth&#39;, []).factory(
    &#39;auth&#39;,

    function($rootScope, $http, $location) {

      var auth = {

        ...

        init : function(homePath, loginPath, logoutPath) {
          ...
          $rootScope.$on(&#39;$routeChangeStart&#39;, function() {
            enter();
          });
        }

      };

      return auth;

    });"></button><pre>angular.module('auth', []).factory(
    'auth',

    function($rootScope, $http, $location) {

      var auth = {

        ...

        init : function(homePath, loginPath, logoutPath) {
          ...
          $rootScope.$on('$routeChangeStart', function() {
            enter();
          });
        }

      };

      return auth;

    });</pre>
</div>
</div>
<div class="paragraph">
<p>We registered a simple listener which just delegates to a new <code>enter()</code> function, so now you need to implement that as well in the "auth" module factory function (where it has access to the factory object itself):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="enter = function() {
  if ($location.path() != auth.loginPath) {
    auth.path = $location.path();
    if (!auth.authenticated) {
      $location.path(auth.loginPath);
    }
  }
}"></button><pre>enter = function() {
  if ($location.path() != auth.loginPath) {
    auth.path = $location.path();
    if (!auth.authenticated) {
      $location.path(auth.loginPath);
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>The logic is simple: if the path just changed to something other than the login page, then make a record of the path value, and then if the user is not authenticated, go to the login page. The reason we save the path value is so we can go back to it after a successful authentication (Spring Security has this feature server side and itâs quite nice for users). You do that in the <code>authenticate()</code> function by adding some code to the success handler:</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="authenticate : function(credentials, callback) {
 ...
 $http.get(&#39;user&#39;, {
  headers : headers
  }).success(function(data) {
      ...
      $location.path(auth.path==auth.loginPath ? auth.homePath : auth.path);
  }).error(...);

},"></button><pre>authenticate : function(credentials, callback) {
 ...
 $http.get('user', {
  headers : headers
  }).success(function(data) {
      ...
      $location.path(auth.path==auth.loginPath ? auth.homePath : auth.path);
  }).error(...);

},</pre>
</div>
</div>
<div class="paragraph">
<p>On successful authentication we just set the location to either the home page or the most recently selected path (as long as itâs not the login page).</p>
</div>
<div class="paragraph">
<p>There is one final change to make the user experience more uniform: we would like to show the login page instead of the home page when the application first starts up. You already have that logic (redirect to login page) in the <code>authenticate()</code> function, so all you need to do is add some code in the <code>init()</code> function to authenticate with empty credentials (which fails unless the user has a cookie already):</p>
</div>
<div class="listingblock">
<div class="content">
<button class="copy-button snippet" data-clipboard-text="init : function(homePath, loginPath, logoutPath) {
  ...
  auth.authenticate({}, function(authenticated) {
    if (authenticated) {
      $location.path(auth.path);
    }
  });
  ...
}"></button><pre>init : function(homePath, loginPath, logoutPath) {
  ...
  auth.authenticate({}, function(authenticated) {
    if (authenticated) {
      $location.path(auth.path);
    }
  });
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>As long as <code>auth.path</code> is initialized with <code>$location.path()</code>, this will even work if the user types in a route explicitly into the browser (i.e. doesnât want to load the home page first).</p>
</div>
<div class="paragraph">
<p>Fire up the application (using your IDE and the <code>main()</code> method, or on the command line with <code>mvn spring-boot:run</code>) and visit it at <a href="http://localhost:8080/" class="bare">http://localhost:8080</a> to see the result.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Reminder: be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that is to open a new incognito window.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this section we have seen how to modularize an Angular application (taking as a starting point the application from <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">section two</a> of the tutorial), how to make it redirect to a login page, and how to use "natural" routes that can be typed or bookmarked easily by users. We took a step back from the last couple of sections in the tutorial, concentrating on the client-side code a bit more, and temporarily ditching the distributed architecture that we were building in Sections III-VI. That doesnât mean that the changes here canât be applied to those other applications (actually itâs fairly trivial) - it was just to simplify the server-side code while we were learning how to do things on the client. There <em>were</em> a couple of server-side features that we used or discussed briefly though (for instance the use of a "forward" view in Spring MVC to enable "natural" routes), so we have continued the theme of Angular and Spring working together, and shown that they do so quite well with small tweaks here and there.</p>
</div>
</div>
</div>
</div></div>
</article>
</div>
<aside class="span4 content-right-pane--container mobile-left-pane" id="sidebar">
<a class="ci-status desktop-only" href="https://travis-ci.org/spring-guides/tut-spring-security-and-angular-js">
<img src="./spring_files/tut-spring-security-and-angular-js.svg">
</a>
<div class="right-pane-widget--container desktop-only">
<div class="github-actions https">
<h2>Get the Code</h2>
<div class="btn-group">
<button class="btn" data-protocol="https">HTTPS</button>
<button class="btn" data-protocol="ssh">SSH</button>
<button class="btn" data-protocol="subversion">Subversion</button>
</div>
<div class="clone-url https">
<input id="clone-url-https" readonly="readonly" type="text" value="https://github.com/spring-guides/tut-spring-security-and-angular-js.git">
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="https://github.com/spring-guides/tut-spring-security-and-angular-js.git"></button>
</div>
<div class="clone-url ssh">
<input id="clone-url-ssh" readonly="readonly" type="text" value="git@github.com:spring-guides/tut-spring-security-and-angular-js.git">
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="git@github.com:spring-guides/tut-spring-security-and-angular-js.git"></button>
</div>
<div class="clone-url subversion">
<input id="clone-url-subversion" readonly="readonly" type="text" value="https://github.com/spring-guides/tut-spring-security-and-angular-js">
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="https://github.com/spring-guides/tut-spring-security-and-angular-js"></button>
</div>
<a class="github_download btn btn-black uppercase" href="https://github.com/spring-guides/tut-spring-security-and-angular-js/archive/master.zip">Download ZIP</a>
<a class="gs-guide-import" href="https://github.com/spring-guides/tut-spring-security-and-angular-js">Import into STS</a>
<div class="go-to-repo--container">
<a href="https://github.com/spring-guides/tut-spring-security-and-angular-js">
<i class="icon-github"></i>
Go To Repo
</a>
</div>
</div>
</div>
<div><div class="right-pane-widget--container">
<div class="related_resources">
<h3><a name="table-of-contents" class="anchor" href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#table-of-contents"></a>Table of contents</h3>
<ul class="sectlevel1">
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_spring_and_angular_js_a_secure_single_page_application">A Secure Single Page Application</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii">The Login Page</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_resource_server_angular_js_and_spring_security_part_iii">The Resource Server</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_api_gateway_pattern_angular_js_and_spring_security_part_iv">The API Gateway</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_sso_with_oauth2_angular_js_and_spring_security_part_v">Single Sign On with OAuth2</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_multiple_ui_applications_and_a_gateway_single_page_application_with_spring_and_angular_js_part_vi">Multiple UI Applications and a Gateway</a> </li>
<li><a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#_modular_angularjs_application">Modular AngularJS Application</a> </li>
</ul></div>
</div>
<div class="right-pane-widget--container">
<div class="related_resources">
<h3><a name="tags" class="anchor" href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#tags"></a>Tags</h3><ul class="inline">
<li><a href="https://spring.io/guides?filter=angular">angular</a></li>
<li><a href="https://spring.io/guides?filter=rest">rest</a></li>
<li><a href="https://spring.io/guides?filter=security">security</a></li>
<li><a href="https://spring.io/guides?filter=oauth">oauth</a></li>
</ul><h3><a name="projects" class="anchor" href="https://spring.io/guides/tutorials/spring-security-and-angular-js/#projects"></a>Projects</h3>
<ul>
<li><a href="http://projects.spring.io/spring-security-oauth">Spring Security OAuth</a></li>
<li><a href="http://projects.spring.io/spring-security">Spring Security</a></li>
</ul>
</div>
</div></div>
</aside>
</div>
</main>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span8">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="https://spring.io/team">Team</a></li>
<li><a href="https://spring.io/services">Services</a></li>
<li><a href="https://spring.io/tools">Tools</a></li>
</ul>
</div>
</div>
Â© <span>2015</span> <a href="http://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="http://www.pivotal.io/terms-of-use">Terms of Use</a> and
<a href="http://www.pivotal.io/privacy-policy">Privacy</a>
</div>
<div class="span4 footer-newsletter--wrapper pull-right">
<div class="footer-newsletter--container">
<label>
Subscribe to our newsletter
</label>
<iframe src="./spring_files/newsletter.html" frameborder="0" scrolling="no" height="42px" width="332px" style="border:none"></iframe></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
<div id="global-zeroclipboard-html-bridge" class="global-zeroclipboard-container" data-clipboard-ready="true" style="position: absolute; left: -9999px; top: -9999px; width: 15px; height: 15px; z-index: 9999;" data-original-title="" title="">      <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="global-zeroclipboard-flash-bridge" width="100%" height="100%">         <param name="movie" value="/lib/zeroclipboard/ZeroClipboard.swf?nocache=1440763167465">         <param name="allowScriptAccess" value="sameDomain">         <param name="scale" value="exactfit">         <param name="loop" value="false">         <param name="menu" value="false">         <param name="quality" value="best">         <param name="bgcolor" value="#ffffff">         <param name="wmode" value="transparent">         <param name="flashvars" value="">         <embed src="/lib/zeroclipboard/ZeroClipboard.swf?nocache=1440763167466" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="100%" height="100%" name="global-zeroclipboard-flash-bridge" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" wmode="transparent" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="" scale="exactfit">                </object></div></body></html>